<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVçµ±åˆå¤‰æ›ã‚·ã‚¹ãƒ†ãƒ  - ãƒ¤ãƒãƒˆé‹è¼¸ãƒ‡ãƒ¼ã‚¿ä½œæˆ</title>
    <meta name="description" content="Amazonãƒ»æ¥½å¤©ãƒ»Yahoo ã®CSVãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã«å¤‰æ›ã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .file-group {
            margin-bottom: 20px;
        }

        .file-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #f7fafc;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-family: inherit;
        }

        .file-input:hover {
            border-color: #007bff;
            background: #edf2f7;
        }

        .file-input.has-file {
            border-color: #28a745;
            background: #f0fff4;
            border-style: solid;
        }

        .file-status {
            font-size: 12px;
            margin-top: 4px;
            color: #718096;
        }

        .file-status.success {
            color: #28a745;
        }

        .convert-button {
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 20px;
        }

        .convert-button:hover:not(:disabled) {
            background: #0056b3;
        }

        .convert-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            color: #4a5568;
            font-size: 14px;
        }

        .result-section {
            display: none;
        }

        .success-message {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .error-message {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #742a2a;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .download-button {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .download-button:hover {
            background: #218838;
        }

        .reset-button {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .reset-button:hover {
            background: #f7fafc;
        }

        .info-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .info-list {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-list li {
            margin-bottom: 4px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-box {
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .required-label {
            color: #e53e3e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CSVçµ±åˆå¤‰æ›ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>Amazonãƒ»æ¥½å¤©ãƒ»Yahoo ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¤ãƒãƒˆé‹è¼¸ç”¨ã«å¤‰æ›</p>
        </div>

        <div class="upload-section">
            <div class="file-group">
                <label class="file-label">å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« <span class="required-label">*å¿…é ˆ</span></label>
                <input type="file" id="masterFile" class="file-input" accept=".xlsx,.xlsm,.xls">
                <div class="file-status" id="masterStatus">å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">Amazonãƒ‡ãƒ¼ã‚¿ (TSVå½¢å¼)</label>
                <input type="file" id="amazonFile" class="file-input" accept=".txt,.tsv,.csv">
                <div class="file-status" id="amazonStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</label>
                <input type="file" id="rakutenFile" class="file-input" accept=".csv">
                <div class="file-status" id="rakutenStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">Yahooãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</label>
                <input type="file" id="yahooFile" class="file-input" accept=".csv">
                <div class="file-status" id="yahooStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
        </div>

        <button class="convert-button" id="convertButton" disabled>
            ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡¦ç†ä¸­...</div>
        </div>

        <div class="result-section" id="resultSection">
            <div id="messageArea"></div>
            <button class="download-button" id="downloadButton" style="display: none;">
                ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
            <button class="reset-button" id="resetButton">
                æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
            </button>
        </div>

        <div class="info-section">
            <div class="info-title">ä½¿ç”¨æ–¹æ³•</div>
            <ul class="info-list">
                <li>1. å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠ</li>
                <li>2. å„ECã‚µã‚¤ãƒˆã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</li>
                <li>3. ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>4. å¤‰æ›å®Œäº†å¾Œã€ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                <li>â€» ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼šAmazon(TSV)ã€æ¥½å¤©ãƒ»Yahoo(CSV)</li>
                <li>â€» åŒä¸€é…é€å…ˆã¯è‡ªå‹•çµ±åˆã•ã‚Œã¾ã™</li>
                <li>â€» é‡é‡ã¯å•†å“ãƒã‚¹ã‚¿ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™</li>
                <li>â€» ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ã—ã¾ã™</li>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let productMaster = {};
        let colorWeightTable = {}; // ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨
        let selectedFiles = {
            master: null,
            amazon: null,
            rakuten: null,
            yahoo: null
        };

        // DOMè¦ç´ 
        const masterFile = document.getElementById('masterFile');
        const amazonFile = document.getElementById('amazonFile');
        const rakutenFile = document.getElementById('rakutenFile');
        const yahooFile = document.getElementById('yahooFile');
        const convertButton = document.getElementById('convertButton');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultSection = document.getElementById('resultSection');
        const messageArea = document.getElementById('messageArea');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');

        // ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
        async function loadColorWeightTable() {
            try {
                console.log('Loading color weight table...');
                const response = await fetch('./ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨.xlsx');
                if (!response.ok) {
                    throw new Error(`ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                console.log('Color weight table sheets:', workbook.SheetNames);
                
                // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { 
                    header: 1,
                    defval: '',
                    blankrows: false
                });
                
                console.log('Color weight table rows:', jsonData.length);
                console.log('Headers:', jsonData[0]);
                
                // ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                // Aåˆ—: ç©ºã€Båˆ—: Yahooè¡¨è¨˜ã€Cåˆ—: æ¥½å¤©è¡¨è¨˜ã€Dåˆ—: è‰²ã€Eåˆ—: é‡ã•
                colorWeightTable = {
                    byYahoo: {},  // Båˆ—(Yahooè¡¨è¨˜)ã§ã®ãƒãƒƒãƒ”ãƒ³ã‚°
                    byRakuten: {}, // Cåˆ—(æ¥½å¤©è¡¨è¨˜)ã§ã®ãƒãƒƒãƒ”ãƒ³ã‚°
                    byColor: {}    // Dåˆ—(è‰²)ã§ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå¾“æ¥äº’æ›ç”¨ï¼‰
                };
                let loadedCount = 0;
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length >= 5) {
                        const yahooCode = String(row[1] || '').trim();     // Båˆ—: Yahooè¡¨è¨˜
                        const rakutenCode = String(row[2] || '').trim();   // Cåˆ—: æ¥½å¤©è¡¨è¨˜
                        const colorName = String(row[3] || '').trim();     // Dåˆ—: è‰²
                        const weightStr = String(row[4] || '').trim();     // Eåˆ—: é‡ã•("60g", "80g"å½¢å¼)
                        
                        // é‡ã•ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡º
                        const weightMatch = weightStr.match(/(\d+)/);
                        const weight = weightMatch ? parseFloat(weightMatch[1]) : 0;
                        
                        if (weight > 0) {
                            // è‰²ã‚’ä¸€æ–‡å­—ã«å¤‰æ›
                            let shortColor = colorName;
                            if (colorName.endsWith('è‰²')) {
                                shortColor = colorName.slice(0, -1); // æœ€å¾Œã®ã€Œè‰²ã€ã‚’é™¤å»
                            }
                            
                            // Yahooè¡¨è¨˜ã§ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆBåˆ—ï¼‰
                            if (yahooCode) {
                                colorWeightTable.byYahoo[yahooCode] = {
                                    color: shortColor,
                                    weight: weight
                                };
                                console.log(`Yahoo mapping: ${yahooCode} -> ${shortColor}: ${weight}g`);
                            }
                            
                            // æ¥½å¤©è¡¨è¨˜ã§ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆCåˆ—ï¼‰
                            if (rakutenCode) {
                                colorWeightTable.byRakuten[rakutenCode] = {
                                    color: shortColor,
                                    weight: weight
                                };
                                console.log(`Rakuten mapping: ${rakutenCode} -> ${shortColor}: ${weight}g`);
                            }
                            
                            // ã‚«ãƒ©ãƒ¼åã§ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆDåˆ—ãƒ»å¾“æ¥äº’æ›ç”¨ï¼‰
                            if (colorName) {
                                colorWeightTable.byColor[colorName] = weight;
                            }
                            
                            loadedCount++;
                        }
                    }
                }
                
                console.log(`Color weight table loaded: ${loadedCount} colors`);
                console.log('Yahoo codes:', Object.keys(colorWeightTable.byYahoo));
                console.log('Rakuten codes:', Object.keys(colorWeightTable.byRakuten));
                return true;
                
            } catch (error) {
                console.error('ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã‚’ç¶™ç¶šï¼ˆå¯¾å¿œè¡¨ãªã—ã§ã‚‚å‹•ä½œã™ã‚‹ãŸã‚ï¼‰
                return false;
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        masterFile.addEventListener('change', (e) => handleFileSelect(e, 'master', 'masterStatus'));
        amazonFile.addEventListener('change', (e) => handleFileSelect(e, 'amazon', 'amazonStatus'));
        rakutenFile.addEventListener('change', (e) => handleFileSelect(e, 'rakuten', 'rakutenStatus'));
        yahooFile.addEventListener('change', (e) => handleFileSelect(e, 'yahoo', 'yahooStatus'));

        function handleFileSelect(event, type, statusId) {
            const file = event.target.files[0];
            const statusElement = document.getElementById(statusId);
            const inputElement = event.target;

            console.log(`File selected for ${type}:`, file ? file.name : 'none');

            if (file) {
                selectedFiles[type] = file;
                statusElement.textContent = `é¸æŠæ¸ˆã¿: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`;
                statusElement.className = 'file-status success';
                inputElement.classList.add('has-file');
                
                // å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯å³åº§ã«èª­ã¿è¾¼ã¿
                if (type === 'master') {
                    loadProductMaster(file);
                }
            } else {
                selectedFiles[type] = null;
                statusElement.textContent = type === 'master' ? 
                    'å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„' : 
                    'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
                statusElement.className = 'file-status';
                inputElement.classList.remove('has-file');
                
                if (type === 'master') {
                    productMaster = {};
                }
            }

            updateConvertButton();
        }

        async function loadProductMaster(file) {
            try {
                console.log('Loading product master...');
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                console.log('Workbook sheets:', workbook.SheetNames);
                
                let masterSheet = null;
                // å•†å“ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‚’æ¢ã™
                for (const sheetName of workbook.SheetNames) {
                    if (sheetName.includes('å•†å“ãƒã‚¹ã‚¿') || sheetName.includes('master') || sheetName.includes('Master')) {
                        masterSheet = workbook.Sheets[sheetName];
                        console.log('Found master sheet:', sheetName);
                        break;
                    }
                }
                
                // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨
                if (!masterSheet && workbook.SheetNames.length > 0) {
                    masterSheet = workbook.Sheets[workbook.SheetNames[0]];
                    console.log('Using first sheet:', workbook.SheetNames[0]);
                }
                
                if (!masterSheet) {
                    throw new Error('å•†å“ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ã‚·ãƒ¼ãƒˆã‚’JSONã«å¤‰æ›
                const jsonData = XLSX.utils.sheet_to_json(masterSheet, { 
                    header: 1,
                    defval: '',
                    blankrows: false
                });
                
                console.log('Master data rows:', jsonData.length);
                console.log('Headers:', jsonData[0]);
                
                // å•†å“ãƒã‚¹ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ï¼ˆè¤‡æ•°ã‚«ãƒ©ãƒ ã‚»ãƒƒãƒˆå¯¾å¿œï¼‰
                productMaster = {};
                let loadedCount = 0;
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length >= 3 && row[0] && row[2] && row[0] !== 'FBA') { // è²©å£²ã‚µã‚¤ãƒˆã€å•†å“Noæœ€ä½é™å¿…è¦ã€FBAé™¤å¤–
                        const site = String(row[0]).trim();
                        const detail = String(row[1] || '').trim();
                        const productNo = String(row[2]).trim();
                        
                        // è¤‡æ•°ã‚«ãƒ©ãƒ ã‚»ãƒƒãƒˆã‚’å‡¦ç†ï¼ˆD-F, G-I, J-L, M-O, P-Rï¼‰
                        const colorSets = [];
                        const columnGroups = [
                            [3, 4, 5],   // D, E, F
                            [6, 7, 8],   // G, H, I  
                            [9, 10, 11], // J, K, L
                            [12, 13, 14], // M, N, O
                            [15, 16, 17]  // P, Q, R
                        ];
                        
                        columnGroups.forEach(([weightCol, quantityCol, colorCol]) => {
                            let weight = parseFloat(row[weightCol]) || 0;
                            const quantity = parseInt(row[quantityCol]) || 0;
                            const color = String(row[colorCol] || '').trim();
                            
                            // ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã‹ã‚‰é‡é‡ã‚’å–å¾—ï¼ˆå„ªå…ˆï¼‰
                            if (color && colorWeightTable.byColor && colorWeightTable.byColor[color]) {
                                weight = colorWeightTable.byColor[color];
                                console.log(`Using color weight table: ${color} = ${weight}g`);
                            }
                            
                            if (weight > 0 && quantity > 0 && color) {
                                colorSets.push({
                                    weight: weight,
                                    quantity: quantity,
                                    color: color
                                });
                            }
                        });
                        
                        // å°‘ãªãã¨ã‚‚1ã¤ã®ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆãŒã‚ã‚‹å ´åˆã®ã¿ç™»éŒ²
                        if (colorSets.length > 0) {
                            productMaster[productNo] = {
                                site: site,
                                detail: detail,
                                colorSets: colorSets
                            };
                            loadedCount++;
                        }
                    }
                }
                
                console.log(`Product master loaded: ${loadedCount} products`);
                console.log('Product master keys:', Object.keys(productMaster));
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                const masterStatus = document.getElementById('masterStatus');
                masterStatus.textContent = `âœ… å•†å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${loadedCount}ä»¶`;
                masterStatus.className = 'file-status success';
                
            } catch (error) {
                console.error('å•†å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const masterStatus = document.getElementById('masterStatus');
                masterStatus.textContent = `âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                masterStatus.className = 'file-status';
                masterStatus.style.color = '#e53e3e';
                productMaster = {};
            }
        }

        function updateConvertButton() {
            // å•†å“ãƒã‚¹ã‚¿ã¯å¿…é ˆã€ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å°‘ãªãã¨ã‚‚1ã¤ã¯å¿…è¦
            const hasMaster = selectedFiles.master && Object.keys(productMaster).length > 0;
            const hasData = selectedFiles.amazon || selectedFiles.rakuten || selectedFiles.yahoo;
            
            convertButton.disabled = !hasMaster || !hasData;
            
            console.log('Button update:', { hasMaster, hasData, disabled: convertButton.disabled });
        }

        // å¤‰æ›å‡¦ç†
        convertButton.addEventListener('click', async () => {
            try {
                showProgress();
                updateProgress(10, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

                const results = [];
                
                // Amazonãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.amazon) {
                    updateProgress(25, 'Amazonãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const amazonData = await readFileWithEncoding(selectedFiles.amazon);
                    const amazonOrders = await processAmazonData(amazonData);
                    results.push(...amazonOrders);
                }

                // æ¥½å¤©ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.rakuten) {
                    updateProgress(45, 'æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const rakutenData = await readFileWithEncoding(selectedFiles.rakuten);
                    const rakutenOrders = await processRakutenData(rakutenData);
                    results.push(...rakutenOrders);
                }

                // Yahooãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.yahoo) {
                    updateProgress(65, 'Yahooãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const yahooData = await readFileWithEncoding(selectedFiles.yahoo);
                    const yahooOrders = await processYahooData(yahooData);
                    results.push(...yahooOrders);
                }

                // ãƒ‡ãƒ¼ã‚¿çµ±åˆ
                updateProgress(80, 'ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆä¸­...');
                const mergedOrders = mergeOrdersByRecipient(results);
                
                updateProgress(90, 'CSVç”Ÿæˆä¸­...');
                const csvContent = generateYamatoCSV(mergedOrders);
                
                updateProgress(100, 'å¤‰æ›å®Œäº†!');
                
                setTimeout(() => {
                    // é‡é‡åˆ¥ã®çµ±è¨ˆã‚’è¨ˆç®—
                    const lightOrders = mergedOrders.filter(order => order.weight <= 1000);
                    const heavyOrders = mergedOrders.filter(order => order.weight > 1000);
                    
                    // ã‚¨ãƒ©ãƒ¼å•†å“ã®ç¢ºèª
                    const errorOrders = mergedOrders.filter(order => 
                        order.productName && order.productName.includes('âŒã‚¨ãƒ©ãƒ¼')
                    );
                    
                    // ã‚¨ãƒ©ãƒ¼å•†å“ã®è©³ç´°ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                    const errorOrdersList = errorOrders.map(order => ({
                        fileName: order.fileName || 'ä¸æ˜ãªãƒ•ã‚¡ã‚¤ãƒ«',
                        rowIndex: order.rowIndex || 'ä¸æ˜',
                        productName: order.productName,
                        orderId: order.orderId
                    }));
                    
                    if (errorOrders.length > 0) {
                        console.error(`âš ï¸ ${errorOrders.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:`);
                        errorOrdersList.forEach(error => {
                            console.error(`  - ${error.fileName} ${error.rowIndex}è¡Œç›®: ${error.productName} (æ³¨æ–‡ID: ${error.orderId})`);
                        });
                    }
                    
                    showResult(csvContent, {
                        original: results.length,
                        merged: mergedOrders.length,
                        amazon: results.filter(r => r.source === 'Amazon').length,
                        rakuten: results.filter(r => r.source === 'æ¥½å¤©').length,
                        yahoo: results.filter(r => r.source === 'Yahoo').length,
                        lightOrders: lightOrders.length,
                        heavyOrders: heavyOrders.length,
                        errorOrders: errorOrders.length,
                        errorOrdersList: errorOrdersList
                    });
                }, 500);

            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                showError(error.message);
            }
        });

        async function readFileWithEncoding(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const buffer = new Uint8Array(e.target.result);
                        
                        // ãƒ•ã‚¡ã‚¤ãƒ«åã§åˆ¤å®šã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é¸æŠ
                        let result;
                        if (file.name.includes('æ¥½å¤©') || file.name.includes('rakuten')) {
                            // æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ã¯Shift-JISã‚’å„ªå…ˆ
                            try {
                                result = new TextDecoder('shift-jis', { fatal: false }).decode(buffer);
                                console.log('Used Shift-JIS encoding for Rakuten data');
                            } catch {
                                // Shift-JISã§ãƒ€ãƒ¡ãªã‚‰UTF-8ã‚’è©¦è¡Œ
                                result = new TextDecoder('utf-8', { fatal: false }).decode(buffer);
                                console.log('Fallback to UTF-8 for Rakuten data');
                            }
                        } else {
                            // ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯UTF-8ã‚’å„ªå…ˆ
                            try {
                                result = new TextDecoder('utf-8', { fatal: true }).decode(buffer);
                                console.log('Used UTF-8 encoding');
                            } catch {
                                // UTF-8ã§ãƒ€ãƒ¡ãªã‚‰Shift-JISã‚’è©¦è¡Œ
                                try {
                                    result = new TextDecoder('shift-jis', { fatal: false }).decode(buffer);
                                    console.log('Fallback to Shift-JIS');
                                } catch {
                                    // æœ€å¾Œã®æ‰‹æ®µï¼šéå³å¯†ãªUTF-8
                                    result = new TextDecoder('utf-8', { fatal: false }).decode(buffer);
                                    console.log('Used non-strict UTF-8 as last resort');
                                }
                            }
                        }
                        
                        resolve(result);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function processAmazonData(amazonData) {
            const orders = [];
            const lines = amazonData.split('\n').filter(line => line.trim());
            
            if (lines.length <= 1) return orders;
            
            const headers = lines[0].split('\t');
            console.log('Amazon headers count:', headers.length);
            
            for (let i = 1; i < lines.length; i++) {
                const fields = lines[i].split('\t');
                if (fields.length < 20) continue; // æœ€ä½é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ãƒã‚§ãƒƒã‚¯
                
                try {
                    const sku = fields[11]?.trim();
                    const productName = fields[13]?.trim();
                    const quantity = parseInt(fields[14]) || 1;
                    const recipientName = fields[19]?.trim();
                    
                    // Amazonä½æ‰€ã®å®Œå…¨ãªçµåˆ: ship-state + ship-address-1 + ship-address-2 + ship-address-3
                    const shipState = fields[24]?.trim() || '';
                    const shipAddress1 = fields[20]?.trim() || '';
                    const shipAddress2 = fields[21]?.trim() || '';
                    const shipAddress3 = fields[22]?.trim() || '';
                    const shipAddress = [shipState, shipAddress1, shipAddress2, shipAddress3]
                        .filter(addr => addr && addr.trim())
                        .join('');
                    
                    const zipCode = fields[25]?.trim();
                    const phoneNumber = fields[10]?.trim();
                    const orderId = fields[0]?.trim();
                    const orderItemId = fields[1]?.trim();

                    if (!recipientName || !shipAddress || !zipCode || !phoneNumber) continue;

                    // ã€ä¿®æ­£ã€‘å•†å“ãƒã‚¹ã‚¿ã‹ã‚‰é‡é‡æƒ…å ±å–å¾—ï¼ˆè¤‡æ•°ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆå¯¾å¿œï¼‰
                    const masterInfo = productMaster[sku];
                    let weight = 50 * quantity; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡é‡Ã—æ³¨æ–‡æ•°
                    let productDetail = productName;
                    let hasError = false;

                    if (masterInfo && masterInfo.colorSets) {
                        // ç·é‡é‡è¨ˆç®—: å„ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆã®(é‡ã•Ã—å€‹æ•°)ã‚’åˆè¨ˆã—ã¦ã‹ã‚‰æ³¨æ–‡æ•°ã‚’æ›ã‘ã‚‹
                        let unitTotalWeight = 0;
                        const detailParts = [];
                        
                        masterInfo.colorSets.forEach(set => {
                            unitTotalWeight += set.weight * set.quantity;
                            detailParts.push(`${set.color}: ${set.weight}gÃ—${set.quantity}`);
                        });
                        
                        weight = unitTotalWeight * quantity;
                        productDetail = detailParts.join(', ');
                        console.log(`âœ… Amazon master match: ${sku} -> ${productDetail} Ã— ${quantity}`);
                    } else {
                        // å•†å“ãƒã‚¹ã‚¿ã«ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                        console.error(`âŒ ERROR: Amazon product not found: "${sku}"`);
                        console.error(`   - Not found in product master (å•†å“ãƒã‚¹ã‚¿ Cåˆ—)`);
                        console.error(`   - Available master keys:`, Object.keys(productMaster || {}));
                        
                        // å•†å“åã‹ã‚‰é‡é‡ã‚’æ¨å®šï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
                        const weightMatch = productName?.match(/(\d+)g/);
                        if (weightMatch) {
                            weight = parseInt(weightMatch[1]) * quantity;
                            productDetail = `âŒã‚¨ãƒ©ãƒ¼: ${sku} (${productName}) - å•†å“ãƒã‚¹ã‚¿æœªç™»éŒ²`;
                        } else {
                            productDetail = `âŒã‚¨ãƒ©ãƒ¼: ${sku} (${productName}) - å•†å“ãƒã‚¹ã‚¿æœªç™»éŒ²ãƒ»é‡é‡ä¸æ˜`;
                        }
                        hasError = true;
                    }

                    orders.push({
                        source: 'Amazon',
                        sku: sku,
                        productName: productDetail,
                        quantity: quantity,
                        recipientName: recipientName,
                        shipAddress: shipAddress,
                        zipCode: formatZipCode(zipCode),
                        phoneNumber: formatPhoneNumber(phoneNumber),
                        weight: weight,
                        orderId: `${orderId}:${orderItemId}:${quantity}`,
                        fileName: 'Amazon TSVãƒ•ã‚¡ã‚¤ãƒ«', // ã‚¨ãƒ©ãƒ¼è¿½è·¡ç”¨
                        rowIndex: i + 1, // TSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†+1ã§Excelè¡Œç•ªå·
                        hasError: hasError
                    });
                } catch (error) {
                    console.error(`Amazon row ${i} error:`, error);
                }
            }
            
            console.log('Amazon orders processed:', orders.length);
            return orders;
        }

        async function processRakutenData(rakutenData) {
            const orders = [];
            
            const parsed = Papa.parse(rakutenData, { 
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
            });
            
            if (!parsed.data || parsed.data.length === 0) return orders;
            
            console.log('Rakuten headers:', Object.keys(parsed.data[0]));
            
            parsed.data.forEach((row, index) => {
                try {
                    const orderId = row['æ³¨æ–‡ç•ªå·']?.trim();
                    const itemId = row['å•†å“ç®¡ç†ç•ªå·']?.trim();
                    const itemName = row['å•†å“å']?.trim();
                    const quantity = parseInt(row['å€‹æ•°']) || 1;
                    const skuInfo = row['SKUæƒ…å ±']?.trim() || ''; // FBåˆ—ã®SKUæƒ…å ±
                    
                    const shipLastName = row['é€ä»˜å…ˆå§“']?.trim() || '';
                    const shipFirstName = row['é€ä»˜å…ˆå']?.trim() || '';
                    const shipName = `${shipLastName} ${shipFirstName}`.trim();
                    
                    const shipPhone1 = row['é€ä»˜å…ˆé›»è©±ç•ªå·1']?.trim() || '';
                    const shipPhone2 = row['é€ä»˜å…ˆé›»è©±ç•ªå·2']?.trim() || '';
                    const shipPhone3 = row['é€ä»˜å…ˆé›»è©±ç•ªå·3']?.trim() || '';
                    const phoneNumber = formatPhoneNumber(`${shipPhone1}-${shipPhone2}-${shipPhone3}`);
                    
                    const shipZip1 = row['é€ä»˜å…ˆéƒµä¾¿ç•ªå·1']?.toString().trim() || '';
                    const shipZip2 = row['é€ä»˜å…ˆéƒµä¾¿ç•ªå·2']?.toString().trim() || '';
                    
                    // æ¥½å¤©éƒµä¾¿ç•ªå·: AJåˆ—ã‚’3æ¡ã€AKåˆ—ã‚’4æ¡ã«0åŸ‹ã‚
                    const paddedZip1 = shipZip1.padStart(3, '0');
                    const paddedZip2 = shipZip2.padStart(4, '0');
                    const zipCode = formatZipCode(`${paddedZip1}${paddedZip2}`);
                    
                    const shipPref = row['é€ä»˜å…ˆä½æ‰€éƒ½é“åºœçœŒ']?.trim() || '';
                    const shipCity = row['é€ä»˜å…ˆä½æ‰€éƒ¡å¸‚åŒº']?.trim() || '';
                    const shipAddr = row['é€ä»˜å…ˆä½æ‰€ãã‚Œä»¥é™ã®ä½æ‰€']?.trim() || '';
                    const shipApart = row['é€ä»˜å…ˆä½æ‰€ã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å']?.trim() || '';
                    
                    // æ¥½å¤©ä½æ‰€ã®å®Œå…¨ãªçµåˆ
                    const fullAddress = [shipPref, shipCity, shipAddr, shipApart]
                        .filter(addr => addr && addr.trim())
                        .join('');

                    if (!shipName || !fullAddress || !zipCode || !phoneNumber || !orderId) return;

                    // é‡é‡è¨ˆç®—ã®æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯
                    let weight = 50 * quantity; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡é‡Ã—æ³¨æ–‡æ•°
                    let productDetail = itemName;
                    let hasError = false;

                    // 1. ã¾ãšSKUæƒ…å ±ï¼ˆFBåˆ—ï¼‰ã‹ã‚‰ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã‚’æ¤œç´¢
                    if (skuInfo && colorWeightTable.byRakuten) {
                        // SKUæƒ…å ±ã‹ã‚‰"ã‚«ãƒ©ãƒ¼:"ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
                        let cleanSKU = skuInfo;
                        if (skuInfo.startsWith('ã‚«ãƒ©ãƒ¼:')) {
                            cleanSKU = skuInfo.substring(4); // "ã‚«ãƒ©ãƒ¼:"ã‚’é™¤å»ï¼ˆ4æ–‡å­—ï¼‰
                        }
                        
                        console.log(`Rakuten SKU processing: "${skuInfo}" -> "${cleanSKU}"`);
                        
                        if (colorWeightTable.byRakuten[cleanSKU]) {
                            const colorInfo = colorWeightTable.byRakuten[cleanSKU];
                            weight = colorInfo.weight * quantity;
                            productDetail = `${colorInfo.color}: ${colorInfo.weight}gÃ—${quantity}`;
                            console.log(`âœ… Rakuten SKU match: ${cleanSKU} -> ${colorInfo.color}: ${colorInfo.weight}g`);
                        } else {
                            console.log(`Rakuten SKU not found in table: "${cleanSKU}"`);
                            // SKUæƒ…å ±ãŒã‚ã‚‹ãŒå¯¾å¿œè¡¨ã«ãªã„å ´åˆã¯å¾“æ¥ã®å‡¦ç†ã¸
                            const masterInfo = productMaster[itemId];
                            if (masterInfo && masterInfo.colorSets) {
                                // è¤‡æ•°ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆå¯¾å¿œ
                                let unitTotalWeight = 0;
                                const detailParts = [];
                                
                                masterInfo.colorSets.forEach(set => {
                                    unitTotalWeight += set.weight * set.quantity;
                                    detailParts.push(`${set.color}: ${set.weight}gÃ—${set.quantity}`);
                                });
                                
                                weight = unitTotalWeight * quantity;
                                productDetail = detailParts.join(', ');
                                console.log(`âœ… Rakuten master match: ${itemId} -> ${detailParts.join(', ')} Ã— ${quantity}`);
                            } else {
                                // ã‚¨ãƒ©ãƒ¼: ã©ã¡ã‚‰ã‹ã‚‰ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„
                                console.error(`âŒ ERROR: Rakuten product not found: "${cleanSKU}" / "${itemId}"`);
                                console.error(`   - Not found in color weight table (æ¥½å¤©è¡¨è¨˜ Cåˆ—)`);
                                console.error(`   - Not found in product master (å•†å“ãƒã‚¹ã‚¿ Cåˆ—)`);
                                
                                // å•†å“åã‹ã‚‰é‡é‡æ¨å®šï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
                                const weightMatch = itemName?.match(/(\d+)g/);
                                if (weightMatch) {
                                    weight = parseInt(weightMatch[1]) * quantity;
                                }
                                productDetail = `âŒã‚¨ãƒ©ãƒ¼: ${cleanSKU}/${itemId} (${itemName}) - æœªç™»éŒ²å•†å“`;
                                hasError = true;
                            }
                        }
                    }
                    // 2. SKUæƒ…å ±ãŒãªã„å ´åˆã€å¾“æ¥é€šã‚Šå•†å“ç®¡ç†ç•ªå·ã§å•†å“ãƒã‚¹ã‚¿ã‚’ç¢ºèª
                    else {
                        console.log(`No Rakuten SKU info, using itemId: ${itemId}`);
                        const masterInfo = productMaster[itemId];
                        if (masterInfo && masterInfo.colorSets) {
                            // è¤‡æ•°ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆå¯¾å¿œ
                            let unitTotalWeight = 0;
                            const detailParts = [];
                            
                            masterInfo.colorSets.forEach(set => {
                                unitTotalWeight += set.weight * set.quantity;
                                detailParts.push(`${set.color}: ${set.weight}gÃ—${set.quantity}`);
                            });
                            
                            weight = unitTotalWeight * quantity;
                            productDetail = detailParts.join(', ');
                            console.log(`âœ… Rakuten master match: ${itemId} -> ${detailParts.join(', ')} Ã— ${quantity}`);
                        } else {
                            // ã‚¨ãƒ©ãƒ¼: å•†å“ãƒã‚¹ã‚¿ã«ãªã„
                            console.error(`âŒ ERROR: Rakuten product not found: "${itemId}"`);
                            console.error(`   - Not found in product master (å•†å“ãƒã‚¹ã‚¿ Cåˆ—)`);
                            
                            // å•†å“åã‹ã‚‰é‡é‡æ¨å®šï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
                            const weightMatch = itemName?.match(/(\d+)g/);
                            if (weightMatch) {
                                weight = parseInt(weightMatch[1]) * quantity;
                            }
                            productDetail = `âŒã‚¨ãƒ©ãƒ¼: ${itemId} (${itemName}) - å•†å“ãƒã‚¹ã‚¿æœªç™»éŒ²`;
                            hasError = true;
                        }
                    }

                    orders.push({
                        source: 'æ¥½å¤©',
                        sku: itemId,
                        productName: productDetail,
                        quantity: quantity,
                        recipientName: shipName,
                        shipAddress: fullAddress,
                        zipCode: zipCode,
                        phoneNumber: phoneNumber,
                        weight: weight,
                        orderId: orderId,
                        fileName: 'æ¥½å¤© CSVãƒ•ã‚¡ã‚¤ãƒ«', // ã‚¨ãƒ©ãƒ¼è¿½è·¡ç”¨
                        rowIndex: index + 2, // ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†+1ã§Excelè¡Œç•ªå·
                        hasError: hasError
                    });
                } catch (error) {
                    console.error(`Rakuten row ${index} error:`, error);
                }
            });
            
            console.log('Rakuten orders processed:', orders.length);
            return orders;
        }

        async function processYahooData(yahooData) {
            const orders = [];
            
            const parsed = Papa.parse(yahooData, { 
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
            });
            
            if (!parsed.data || parsed.data.length === 0) return orders;
            
            console.log('Yahoo headers:', Object.keys(parsed.data[0]));
            
            parsed.data.forEach((row, index) => {
                try {
                    const orderId = row['OrderId']?.trim();
                    let itemId = row['ItemId']?.trim();
                    const subCode = row['SubCode']?.trim() || ''; // SubCodeè¿½åŠ 
                    const title = row['Title']?.trim();
                    const quantityDetail = row['QuantityDetail']?.trim();
                    const shipName = row['ShipName']?.trim();
                    const shipAddress1 = row['ShipAddress1']?.trim() || '';
                    const shipAddress2 = row['ShipAddress2']?.trim() || '';
                    const shipCity = row['ShipCity']?.trim() || '';
                    const shipPrefecture = row['ShipPrefecture']?.trim() || '';
                    const shipAddressFull = row['ShipAddressFull']?.trim() || '';
                    
                    // Yahooä½æ‰€: ShipAddressFullã‚’å„ªå…ˆã€ãªã‘ã‚Œã°å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’çµåˆ
                    const shipAddress = shipAddressFull || 
                        [shipPrefecture, shipCity, shipAddress1, shipAddress2]
                            .filter(addr => addr && addr.trim())
                            .join('');
                    
                    const shipZip = row['ShipZipCode']?.toString().trim();
                    const shipPhone = formatPhoneNumber(row['ShipPhoneNumber']?.toString().trim());

                    if (!shipName || !shipAddress || !shipZip || !shipPhone || !orderId) return;

                    // ã€ä¿®æ­£ã€‘é‡é‡è¨ˆç®—ã®æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯
                    let totalWeight = 0;
                    let productDetails = [];
                    let totalQuantity = 0;
                    let hasError = false;
                    let processedProducts = []; // ãƒ‡ãƒãƒƒã‚°ç”¨

                    // Yahoo!å•†å“æ¤œç´¢ã®çµ±ä¸€å‡¦ç†é–¢æ•°
                    const processYahooProduct = (productCode, quantity) => {
                        console.log(`ğŸ” Processing Yahoo product: "${productCode}" Ã— ${quantity}`);
                        processedProducts.push(`${productCode} Ã— ${quantity}`);
                        
                        // 1. ã¾ãšSubCodeã¾ãŸã¯ItemIdã‹ã‚‰ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã®Båˆ—ã‚’æ¤œç´¢
                        if (colorWeightTable.byYahoo && colorWeightTable.byYahoo[productCode]) {
                            const colorInfo = colorWeightTable.byYahoo[productCode];
                            const itemTotalWeight = colorInfo.weight * quantity;
                            totalWeight += itemTotalWeight;
                            productDetails.push(`${colorInfo.color}: ${colorInfo.weight}gÃ—${quantity}`);
                            totalQuantity += quantity;
                            console.log(`âœ… Yahoo color table match: ${productCode} -> ${colorInfo.color}: ${colorInfo.weight}gÃ—${quantity}`);
                            return true;
                        }
                        
                        // 2. ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã«ãªã„å ´åˆã€å•†å“ãƒã‚¹ã‚¿ã®Cåˆ—ã‚’æ¤œç´¢
                        if (productMaster[productCode] && productMaster[productCode].colorSets) {
                            const masterInfo = productMaster[productCode];
                            let itemUnitWeight = 0;
                            const itemDetailParts = [];
                            
                            masterInfo.colorSets.forEach(set => {
                                itemUnitWeight += set.weight * set.quantity;
                                itemDetailParts.push(`${set.color}: ${set.weight}gÃ—${set.quantity}`);
                            });
                            
                            const itemTotalWeight = itemUnitWeight * quantity;
                            totalWeight += itemTotalWeight;
                            productDetails.push(`${itemDetailParts.join(', ')} Ã— ${quantity}`);
                            totalQuantity += quantity;
                            console.log(`âœ… Yahoo master match: ${productCode} -> ${itemDetailParts.join(', ')} Ã— ${quantity}`);
                            return true;
                        }
                        
                        // 3. ã©ã¡ã‚‰ã‹ã‚‰ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                        console.error(`âŒ ERROR: Yahoo product not found: "${productCode}"`);
                        console.error(`   - Not found in color weight table (Yahooè¡¨è¨˜ Båˆ—)`);
                        console.error(`   - Not found in product master (å•†å“ãƒã‚¹ã‚¿ Cåˆ—)`);
                        console.error(`   - Available color table keys:`, Object.keys(colorWeightTable.byYahoo || {}));
                        console.error(`   - Available master keys:`, Object.keys(productMaster || {}));
                        
                        // ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å•†å“è©³ç´°ã«è¿½åŠ 
                        productDetails.push(`âŒã‚¨ãƒ©ãƒ¼: ${productCode} (æœªç™»éŒ²å•†å“) Ã— ${quantity}`);
                        totalQuantity += quantity;
                        hasError = true;
                        
                        return false;
                    };

                    // ã€ä¿®æ­£ã€‘SubCodeã‚’å„ªå…ˆå‡¦ç†
                    console.log(`ğŸ” Yahoo processing - OrderId: ${orderId}, ItemId: "${itemId}", SubCode: "${subCode}"`);
                    
                    if (subCode) {
                        console.log(`ğŸ“‹ Processing Yahoo SubCode: "${subCode}"`);
                        
                        if (subCode.includes('&')) {
                            // è¤‡æ•°å•†å“ã®å ´åˆï¼ˆä¾‹: L1=greenmix60&L2=yellowgreen80ï¼‰
                            const items = subCode.split('&');
                            items.forEach(item => {
                                console.log(`  ğŸ“¦ Processing SubCode item: "${item}"`);
                                // L1=greenmix60 -> greenmix60 ã‚’æŠ½å‡º
                                let cleanItemCode = '';
                                if (item.includes('=')) {
                                    cleanItemCode = item.split('=')[1];
                                } else {
                                    cleanItemCode = item.trim();
                                }
                                
                                // QuantityDetailã‹ã‚‰è©²å½“å•†å“ã®æ•°é‡ã‚’å–å¾—
                                let quantity = 1;
                                if (quantityDetail) {
                                    const quantityMatch = quantityDetail.match(new RegExp(`${cleanItemCode.replace(/[.*+?^${}()|[\]\\]/g, '\\                // ãƒ‡ãƒ¼ã‚¿')}:(\\d+)`));
                                    quantity = quantityMatch ? parseInt(quantityMatch[1]) : 1;
                                }
                                
                                console.log(`  ğŸ“¦ Extracted: "${cleanItemCode}" Ã— ${quantity}`);
                                processYahooProduct(cleanItemCode, quantity);
                            });
                        } else {
                            // å˜ä¸€å•†å“ã®å ´åˆ
                            const quantity = parseInt(quantityDetail) || 1;
                            let cleanItemCode = subCode;
                            if (subCode.includes('=')) {
                                cleanItemCode = subCode.split('=')[1];
                            }
                            
                            console.log(`  ğŸ“¦ Single SubCode: "${cleanItemCode}" Ã— ${quantity}`);
                            processYahooProduct(cleanItemCode, quantity);
                        }
                    }
                    
                    // SubCodeã§å‡¦ç†ã§ããªã‹ã£ãŸå ´åˆã€ItemIdã§å‡¦ç†
                    if (totalWeight === 0 && itemId) {
                        console.log(`âš ï¸ SubCode failed, processing Yahoo ItemId: "${itemId}"`);
                        
                        if (itemId.includes('&')) {
                            // è¤‡æ•°å•†å“ã®å ´åˆ
                            const items = itemId.split('&');
                            items.forEach(item => {
                                console.log(`  ğŸ“¦ Processing ItemId item: "${item}"`);
                                let cleanItemCode = '';
                                if (item.includes('=')) {
                                    cleanItemCode = item.split('=')[1];
                                } else {
                                    cleanItemCode = item.trim();
                                }
                                
                                // QuantityDetailã‹ã‚‰è©²å½“å•†å“ã®æ•°é‡ã‚’å–å¾—
                                let quantity = 1;
                                if (quantityDetail) {
                                    const quantityMatch = quantityDetail.match(new RegExp(`${cleanItemCode.replace(/[.*+?^${}()|[\]\\]/g, '\\                // ãƒ‡ãƒ¼ã‚¿')}:(\\d+)`));
                                    quantity = quantityMatch ? parseInt(quantityMatch[1]) : 1;
                                }
                                
                                console.log(`  ğŸ“¦ Extracted: "${cleanItemCode}" Ã— ${quantity}`);
                                processYahooProduct(cleanItemCode, quantity);
                            });
                        } else {
                            // å˜ä¸€å•†å“ã®å ´åˆ
                            const quantity = parseInt(quantityDetail) || 1;
                            let cleanItemCode = itemId;
                            if (itemId.includes('=')) {
                                cleanItemCode = itemId.split('=')[1];
                            }
                            
                            console.log(`  ğŸ“¦ Single ItemId: "${cleanItemCode}" Ã— ${quantity}`);
                            processYahooProduct(cleanItemCode, quantity);
                        }
                    }
                    
                    // å‡¦ç†çµæœã®ã¾ã¨ã‚
                    console.log(`ğŸ“Š Yahoo processing summary for OrderId ${orderId}:`);
                    console.log(`   - Processed products: [${processedProducts.join(', ')}]`);
                    console.log(`   - Total weight: ${totalWeight}g`);
                    console.log(`   - Total quantity: ${totalQuantity}`);
                    console.log(`   - Has error: ${hasError}`);
                    console.log(`   - Product details: ${productDetails.join(', ')}`);

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡é‡å‡¦ç†ï¼ˆå‰Šé™¤ - å¿…ãšã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºï¼‰
                    if (totalWeight === 0) {
                        totalWeight = 50; // æœ€ä½é™ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡é‡
                        if (productDetails.length === 0) {
                            productDetails.push(`âŒã‚¨ãƒ©ãƒ¼: å•†å“æƒ…å ±å–å¾—å¤±æ•— (${title})`);
                            hasError = true;
                        }
                    }

                    orders.push({
                        source: 'Yahoo',
                        sku: itemId,
                        productName: productDetails.join(', '),
                        quantity: totalQuantity,
                        recipientName: shipName,
                        shipAddress: shipAddress,
                        zipCode: formatZipCode(shipZip),
                        phoneNumber: shipPhone,
                        weight: totalWeight,
                        orderId: orderId,
                        fileName: 'Yahoo CSVãƒ•ã‚¡ã‚¤ãƒ«', // ã‚¨ãƒ©ãƒ¼è¿½è·¡ç”¨
                        rowIndex: index + 2, // ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†+1ã§Excelè¡Œç•ªå·
                        hasError: hasError
                    });
                } catch (error) {
                    console.error(`Yahoo row ${index} error:`, error);
                }
            });
            
            console.log('Yahoo orders processed:', orders.length);
            return orders;
        }

        function mergeOrdersByRecipient(orders) {
            const merged = {};
            
            orders.forEach(order => {
                const key = `${order.recipientName}_${order.shipAddress}_${order.phoneNumber}`;
                
                if (merged[key]) {
                    merged[key].weight += order.weight;
                    merged[key].quantity += order.quantity;
                    merged[key].orderId += `,${order.orderId}`;
                    
                    if (!merged[key].productName.includes(order.productName)) {
                        merged[key].productName += `, ${order.productName}`;
                    }
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ©ã‚°ã®çµ±åˆ
                    if (order.hasError) {
                        merged[key].hasError = true;
                    }
                } else {
                    merged[key] = { ...order };
                }
            });
            
            return Object.values(merged);
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            
            const cleaned = phone.replace(/[^\d]/g, '');
            const withZero = cleaned.startsWith('0') ? cleaned : '0' + cleaned;
            
            if (withZero.length === 10) {
                return `${withZero.substr(0, 3)}-${withZero.substr(3, 3)}-${withZero.substr(6, 4)}`;
            } else if (withZero.length === 11) {
                return `${withZero.substr(0, 3)}-${withZero.substr(3, 4)}-${withZero.substr(7, 4)}`;
            }
            
            return withZero;
        }

        function formatZipCode(zipCode) {
            if (!zipCode) return '';
            
            const cleaned = zipCode.replace(/[^\d]/g, '');
            
            // æ¥½å¤©ã®éƒµä¾¿ç•ªå·ä¿®æ­£å‡¦ç†
            if (cleaned.length === 5) {
                if (cleaned.startsWith('133') && cleaned.endsWith('55')) {
                    return '133-0055';
                }
                if (cleaned.startsWith('590') && cleaned.endsWith('06')) {
                    return '590-0006';
                }
            }
            
            if (cleaned.length === 7) {
                return `${cleaned.substr(0, 3)}-${cleaned.substr(3, 4)}`;
            }
            
            return cleaned;
        }

        function generateYamatoCSV(orders) {
            const headers = [
                'é€ã‚ŠçŠ¶ç¨®é¡','å‡ºè·äºˆå®šæ—¥','ãŠå±Šã‘äºˆå®šæ—¥','é…é”æ™‚é–“å¸¯','ãŠå±Šã‘å…ˆé›»è©±ç•ªå·',
                'ãŠå±Šã‘å…ˆéƒµä¾¿ç•ªå·','ãŠå±Šã‘å…ˆä½æ‰€','ãŠå±Šã‘å…ˆã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å','ãŠå±Šã‘å…ˆå',
                'ã”ä¾é ¼ä¸»é›»è©±ç•ªå·','ã”ä¾é ¼ä¸»éƒµä¾¿ç•ªå·','ã”ä¾é ¼ä¸»ä½æ‰€','ã”ä¾é ¼ä¸»å','å“åï¼‘',
                'ç·é‡é‡(g)','å“åè©³ç´°','ä¸æ˜å“å','è²©å£²ID','',''
            ];

            const rows = [headers.join(',')];
            
            const today = new Date();
            const shipDate = `${today.getFullYear()}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getDate().toString().padStart(2, '0')}`;

            // é‡é‡ã§åˆ†é¡ï¼ˆ1kgä»¥ä¸‹ã¨1kgè¶…éï¼‰
            const lightOrders = orders.filter(order => order.weight <= 1000);
            const heavyOrders = orders.filter(order => order.weight > 1000);
            
            // ã™ã¹ã¦ã®æ³¨æ–‡ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
            const processOrders = (orderList, shipType) => {
                orderList.forEach(order => {
                    const escapeCSV = (str) => {
                        if (!str) return '';
                        const strValue = String(str);
                        if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) {
                            return '"' + strValue.replace(/"/g, '""') + '"';
                        }
                        return strValue;
                    };
                    
                    const fullProductName = order.productName || '';
                    const truncatedProductName = fullProductName.substring(0, 25); // å…¨è§’25æ–‡å­—åˆ¶é™
                    const hasOverflow = fullProductName.length > 25;
                    
                    // ECã‚µã‚¤ãƒˆåˆ¥ã®ä¾é ¼ä¸»åã‚’è¨­å®š
                    let requesterName = 'JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥';
                    if (order.source === 'Amazon') {
                        requesterName = 'JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥ (Amazonåº—)';
                    } else if (order.source === 'æ¥½å¤©') {
                        requesterName = 'JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥ (æ¥½å¤©å¸‚å ´åº—)';
                    } else if (order.source === 'Yahoo') {
                        requesterName = 'JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥ (yahoo!ï½¼ï½®ï½¯ï¾‹ï¾Ÿï¾ï½¸ï¾åº—)';
                    }
                    
                    const row = [
                        shipType, // é€ã‚ŠçŠ¶ç¨®é¡ï¼šAï¼ˆ1kgä»¥ä¸‹ï¼‰ã¾ãŸã¯Zï¼ˆ1kgè¶…éï¼‰
                        shipDate,
                        '', // ãŠå±Šã‘äºˆå®šæ—¥
                        '', // é…é”æ™‚é–“å¸¯
                        escapeCSV(order.phoneNumber),
                        escapeCSV(order.zipCode),
                        escapeCSV(order.shipAddress),
                        '', // ã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å
                        escapeCSV(order.recipientName),
                        '050-3590-1444', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥é›»è©±ç•ªå·
                        '104-0061', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥éƒµä¾¿ç•ªå·
                        'æ±äº¬éƒ½ä¸­å¤®åŒºéŠ€åº§1-22-11 2F', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥ä½æ‰€
                        requesterName, // ECã‚µã‚¤ãƒˆåˆ¥ã®JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥å
                        escapeCSV(truncatedProductName), // å“åï¼‘ï¼ˆå…¨è§’25æ–‡å­—åˆ¶é™ï¼‰
                        Math.round(order.weight || 50),
                        hasOverflow ? escapeCSV(fullProductName) : '', // å“åè©³ç´°ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼æ™‚ã¯å®Œå…¨ç‰ˆï¼‰
                        '', // ä¸æ˜å“å
                        escapeCSV(order.orderId),
                        '', ''
                    ];
                    rows.push(row.join(','));
                });
            };

            // 1kgä»¥ä¸‹ã®æ³¨æ–‡ã‚’å…ˆã«å‡¦ç†ï¼ˆé€ã‚ŠçŠ¶ç¨®é¡ï¼šAï¼‰
            processOrders(lightOrders, 'A');
            
            // 1kgè¶…éã®æ³¨æ–‡ã‚’æœ€ä¸‹éƒ¨ã«å‡¦ç†ï¼ˆé€ã‚ŠçŠ¶ç¨®é¡ï¼šZï¼‰
            processOrders(heavyOrders, 'Z');

            return rows.join('\r\n');
        }

        function showProgress() {
            document.querySelector('.upload-section').style.display = 'none';
            convertButton.style.display = 'none';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
        }

        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function showResult(csvContent, stats) {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            // é‡é‡åˆ¥ã®çµ±è¨ˆã‚’è¨ˆç®—
            const lightCount = stats.lightOrders || 0;
            const heavyCount = stats.heavyOrders || 0;
            const errorCount = stats.errorOrders || 0;
            const errorOrdersList = stats.errorOrdersList || [];
            
            let messageContent = `
                <div class="success-message">
                    <strong>ğŸ‰ å¤‰æ›å®Œäº†ï¼</strong><br>
                    ${stats.original}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’${stats.merged}ä»¶ã«ã¾ã¨ã‚ã¦ãƒ¤ãƒãƒˆé‹è¼¸å½¢å¼ã«å¤‰æ›ã—ã¾ã—ãŸã€‚
                </div>
            `;
            
            // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Šè¡¨ç¤º
            if (errorCount > 0) {
                messageContent += `
                    <div class="error-message">
                        <strong>âš ï¸ è­¦å‘Š: ${errorCount}ä»¶ã®ã‚¨ãƒ©ãƒ¼å•†å“ãŒã‚ã‚Šã¾ã™</strong><br>
                        ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã¾ãŸã¯å•†å“ãƒã‚¹ã‚¿ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„å•†å“ãŒã‚ã‚Šã¾ã™ã€‚<br>
                        è©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ã‚­ãƒ¼ï¼‰ã§ã”ç¢ºèªãã ã•ã„ã€‚
                    </div>
                `;
            }
            
            messageContent += `
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="stat-number">${stats.amazon}</div>
                        <div class="stat-label">Amazon</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.rakuten}</div>
                        <div class="stat-label">æ¥½å¤©</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.yahoo}</div>
                        <div class="stat-label">Yahoo</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.merged}</div>
                        <div class="stat-label">æœ€çµ‚ä»¶æ•°</div>
                    </div>
                </div>
                
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="stat-number">${lightCount}</div>
                        <div class="stat-label">1kgä»¥ä¸‹ (A)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${heavyCount}</div>
                        <div class="stat-label">1kgè¶…é (Z)</div>
                    </div>
            `;
            
            if (errorCount > 0) {
                messageContent += `
                    <div class="stat-box" style="border-color: #e53e3e;">
                        <div class="stat-number" style="color: #e53e3e;">${errorCount}</div>
                        <div class="stat-label" style="color: #e53e3e;">ã‚¨ãƒ©ãƒ¼å•†å“</div>
                    </div>
                `;
            }
            
            messageContent += `</div>`;
            
            // ã‚¨ãƒ©ãƒ¼å•†å“ã®è©³ç´°ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
            if (errorOrdersList.length > 0) {
                messageContent += `
                    <div class="error-details" style="background: #fed7d7; border: 1px solid #feb2b2; border-radius: 8px; padding: 16px; margin-top: 16px;">
                        <div style="font-weight: 600; color: #742a2a; margin-bottom: 8px;">ğŸ” ã‚¨ãƒ©ãƒ¼å•†å“è©³ç´°:</div>
                        <div style="font-size: 14px; color: #742a2a;">
                `;
                
                errorOrdersList.forEach(error => {
                    messageContent += `
                        <div style="margin-bottom: 4px;">
                            â€¢ <strong>${error.fileName}</strong> ${error.rowIndex}è¡Œç›®: ${error.productName} (æ³¨æ–‡ID: ${error.orderId})
                        </div>
                    `;
                });
                
                messageContent += `
                        </div>
                    </div>
                `;
            }
            
            messageArea.innerHTML = messageContent;
            
            downloadButton.style.display = 'block';
            window.csvData = csvContent;
            
            downloadButton.onclick = () => downloadCSV(csvContent, stats.merged);
        }

        function downloadCSV(csvContent, recordCount) {
            try {
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `YBMdata_${getCurrentDateString()}.csv`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                downloadButton.textContent = 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼';
                downloadButton.style.background = '#218838';
                
            } catch (error) {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function getCurrentDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function showError(message) {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            messageArea.innerHTML = `
                <div class="error-message">
                    <strong>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong><br>
                    ${message}<br><br>
                    <small>ç¢ºèªé …ç›®ï¼š<br>
                    â€¢ å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹<br>
                    â€¢ ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ã„ã‹ï¼ˆAmazon: TSVã€æ¥½å¤©ãƒ»Yahoo: CSVï¼‰<br>
                    â€¢ ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ãªã„ã‹</small>
                </div>
            `;
            
            downloadButton.style.display = 'none';
        }

        // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        resetButton.addEventListener('click', () => {
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            masterFile.value = '';
            amazonFile.value = '';
            rakutenFile.value = '';
            yahooFile.value = '';
            
            selectedFiles = { master: null, amazon: null, rakuten: null, yahoo: null };
            productMaster = {};
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const statusElements = [
                { id: 'masterStatus', text: 'å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'amazonStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'rakutenStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'yahooStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' }
            ];
            
            statusElements.forEach(({ id, text }) => {
                const element = document.getElementById(id);
                element.textContent = text;
                element.className = 'file-status';
                element.style.color = '';
            });
            
            // ã‚¤ãƒ³ãƒ—ãƒƒãƒˆè¦ç´ ã®ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            [masterFile, amazonFile, rakutenFile, yahooFile].forEach(input => {
                input.classList.remove('has-file');
            });
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelector('.upload-section').style.display = 'block';
            convertButton.style.display = 'block';
            convertButton.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            
            downloadButton.textContent = 'ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            downloadButton.style.background = '#28a745';
            
            updateConvertButton();
        });

        // åˆæœŸåŒ–å‡¦ç†
        async function initialize() {
            console.log('Initializing application...');
            
            // ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
            const colorTableLoaded = await loadColorWeightTable();
            
            if (colorTableLoaded) {
                console.log('âœ… ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã®èª­ã¿è¾¼ã¿å®Œäº†');
            } else {
                console.log('âš ï¸ ã‚«ãƒ©ãƒ¼ã‚ªãƒ¢ãƒªå¯¾å¿œè¡¨ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰');
            }
            
            updateConvertButton();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        initialize();
    </script>
</body>
</html>
