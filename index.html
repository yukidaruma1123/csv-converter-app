<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVçµ±åˆå¤‰æ›ã‚·ã‚¹ãƒ†ãƒ  Ver.12 - ãƒ¤ãƒãƒˆé‹è¼¸ãƒ‡ãƒ¼ã‚¿ä½œæˆ</title>
    <meta name="description" content="Amazonãƒ»æ¥½å¤©ãƒ»Yahoo ã®CSVãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã«å¤‰æ›ã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .version-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .file-group {
            margin-bottom: 20px;
        }

        .file-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #f7fafc;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-family: inherit;
        }

        .file-input:hover {
            border-color: #007bff;
            background: #edf2f7;
        }

        .file-input.has-file {
            border-color: #28a745;
            background: #f0fff4;
            border-style: solid;
        }

        .file-status {
            font-size: 12px;
            margin-top: 4px;
            color: #718096;
        }

        .file-status.success {
            color: #28a745;
        }

        .convert-button {
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 20px;
        }

        .convert-button:hover:not(:disabled) {
            background: #0056b3;
        }

        .convert-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            color: #4a5568;
            font-size: 14px;
        }

        .result-section {
            display: none;
        }

        .success-message {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .error-message {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #742a2a;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .download-button {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .download-button:hover {
            background: #218838;
        }

        .reset-button {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .reset-button:hover {
            background: #f7fafc;
        }

        .info-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .info-list {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-list li {
            margin-bottom: 4px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-box {
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .required-label {
            color: #e53e3e;
        }

        .new-features {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
        }

        .new-features h3 {
            color: #2d5a2d;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .new-features ul {
            color: #2d5a2d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CSVçµ±åˆå¤‰æ›ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>Amazonãƒ»æ¥½å¤©ãƒ»Yahoo ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¤ãƒãƒˆé‹è¼¸ç”¨ã«å¤‰æ›</p>
            <div class="version-badge">Version 12</div>
        </div>

        <div class="upload-section">
            <div class="file-group">
                <label class="file-label">å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« <span class="required-label">*å¿…é ˆ</span></label>
                <input type="file" id="masterFile" class="file-input" accept=".xlsx,.xlsm,.xls">
                <div class="file-status" id="masterStatus">å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">Amazonãƒ‡ãƒ¼ã‚¿ (TSVå½¢å¼)</label>
                <input type="file" id="amazonFile" class="file-input" accept=".txt,.tsv,.csv">
                <div class="file-status" id="amazonStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</label>
                <input type="file" id="rakutenFile" class="file-input" accept=".csv">
                <div class="file-status" id="rakutenStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">Yahooãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</label>
                <input type="file" id="yahooFile" class="file-input" accept=".csv">
                <div class="file-status" id="yahooStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
        </div>

        <button class="convert-button" id="convertButton" disabled>
            ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡¦ç†ä¸­...</div>
        </div>

        <div class="result-section" id="resultSection">
            <div id="messageArea"></div>
            <button class="download-button" id="downloadButton" style="display: none;">
                ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
            <button class="reset-button" id="resetButton">
                æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
            </button>
        </div>

        <div class="new-features">
            <h3>ğŸ†• Version 12 æ–°æ©Ÿèƒ½</h3>
            <ul>
                <li><strong>æ¥½å¤©SKUæƒ…å ±å¯¾å¿œ</strong>ï¼šSKUæƒ…å ±ã‹ã‚‰è‰²ã¨é‡é‡ã‚’è‡ªå‹•åˆ¤å®š</li>
                <li><strong>Yahoo SubCodeå¯¾å¿œ</strong>ï¼šSubCodeã‹ã‚‰å•†å“æƒ…å ±ã‚’å–å¾—</li>
                <li><strong>1kgè¶…éè‡ªå‹•åˆ†é¡</strong>ï¼šé‡é‡1kgè¶…éå•†å“ã¯Zç¨®åˆ¥ã§ä¸‹æ®µè¡¨ç¤º</li>
                <li><strong>è‰²åä¸€æ–‡å­—è¡¨ç¤º</strong>ï¼šèµ¤è‰²â†’èµ¤ã€ç·‘è‰²â†’ç·‘ã«è‡ªå‹•å¤‰æ›</li>
                <li><strong>å•†å“å25æ–‡å­—åˆ¶é™</strong>ï¼šè¶…éåˆ†ã¯å“åè©³ç´°æ¬„ã«è‡ªå‹•è¨˜è¼‰</li>
                <li><strong>é€ã‚ŠçŠ¶ç¨®åˆ¥å¤‰æ›´</strong>ï¼šAç¨®åˆ¥ï¼ˆå¾“æ¥7ï¼‰ã€1kgè¶…éã¯Zç¨®åˆ¥</li>
            </ul>
        </div>

        <div class="info-section">
            <div class="info-title">ä½¿ç”¨æ–¹æ³•</div>
            <ul class="info-list">
                <li>1. å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠ</li>
                <li>2. å„ECã‚µã‚¤ãƒˆã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</li>
                <li>3. ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>4. å¤‰æ›å®Œäº†å¾Œã€ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                <li>â€» ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼šAmazon(TSV)ã€æ¥½å¤©ãƒ»Yahoo(CSV)</li>
                <li>â€» åŒä¸€é…é€å…ˆã¯è‡ªå‹•çµ±åˆã•ã‚Œã¾ã™</li>
                <li>â€» æ¥½å¤©ã®SKUæƒ…å ±ãƒ»Yahooã®SubCodeã‹ã‚‰è‰²ã¨é‡é‡ã‚’è‡ªå‹•åˆ¤å®š</li>
                <li>â€» 1kgè¶…éå•†å“ã¯è‡ªå‹•ã§Zç¨®åˆ¥ã«åˆ†é¡ã—ä¸‹æ®µã«è¡¨ç¤º</li>
                <li>â€» è‰²åã¯ä¸€æ–‡å­—è¡¨ç¤ºï¼ˆèµ¤è‰²â†’èµ¤ã€ç·‘è‰²â†’ç·‘ï¼‰</li>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let productMaster = {};
        let colorMaster = {}; // ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿ç”¨ï¼ˆæ¥½å¤©SKUæƒ…å ±ãƒ»Yahoo SubCodeå¯¾å¿œï¼‰
        let selectedFiles = {
            master: null,
            amazon: null,
            rakuten: null,
            yahoo: null
        };

        // DOMè¦ç´ 
        const masterFile = document.getElementById('masterFile');
        const amazonFile = document.getElementById('amazonFile');
        const rakutenFile = document.getElementById('rakutenFile');
        const yahooFile = document.getElementById('yahooFile');
        const convertButton = document.getElementById('convertButton');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultSection = document.getElementById('resultSection');
        const messageArea = document.getElementById('messageArea');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        masterFile.addEventListener('change', (e) => handleFileSelect(e, 'master', 'masterStatus'));
        amazonFile.addEventListener('change', (e) => handleFileSelect(e, 'amazon', 'amazonStatus'));
        rakutenFile.addEventListener('change', (e) => handleFileSelect(e, 'rakuten', 'rakutenStatus'));
        yahooFile.addEventListener('change', (e) => handleFileSelect(e, 'yahoo', 'yahooStatus'));

        function handleFileSelect(event, type, statusId) {
            const file = event.target.files[0];
            const statusElement = document.getElementById(statusId);
            const inputElement = event.target;

            console.log(`File selected for ${type}:`, file ? file.name : 'none');

            if (file) {
                selectedFiles[type] = file;
                statusElement.textContent = `é¸æŠæ¸ˆã¿: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`;
                statusElement.className = 'file-status success';
                inputElement.classList.add('has-file');
                
                // å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯å³åº§ã«èª­ã¿è¾¼ã¿
                if (type === 'master') {
                    loadProductMaster(file);
                }
            } else {
                selectedFiles[type] = null;
                statusElement.textContent = type === 'master' ? 
                    'å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„' : 
                    'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
                statusElement.className = 'file-status';
                inputElement.classList.remove('has-file');
                
                if (type === 'master') {
                    productMaster = {};
                    colorMaster = {};
                }
            }

            updateConvertButton();
        }

        async function loadProductMaster(file) {
            try {
                console.log('Loading product master...');
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                console.log('Workbook sheets:', workbook.SheetNames);
                
                // ãƒ¡ã‚¤ãƒ³ã®å•†å“ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‚’æ¢ã™ï¼ˆå¾“æ¥é€šã‚Šï¼‰
                let masterSheet = null;
                for (const sheetName of workbook.SheetNames) {
                    if (masterInfo && masterInfo.colorSets) {
                        // ç·é‡é‡è¨ˆç®—: å„ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆã®(é‡ã•Ã—å€‹æ•°)ã‚’åˆè¨ˆã—ã¦ã‹ã‚‰æ³¨æ–‡æ•°ã‚’æ›ã‘ã‚‹
                        let unitTotalWeight = 0;
                        const detailParts = [];
                        
                        masterInfo.colorSets.forEach(set => {
                            unitTotalWeight += set.weight * set.quantity;
                            // ä¸€æ–‡å­—è‰²è¡¨ç¤ºã«å¤‰æ›
                            let shortColor = set.color;
                            if (set.color.includes('èµ¤')) shortColor = 'èµ¤';
                            else if (set.color.includes('ç·‘')) shortColor = 'ç·‘';
                            else if (set.color.includes('é’')) shortColor = 'é’';
                            else if (set.color.includes('é»„')) shortColor = 'é»„';
                            else if (set.color.includes('æ¡ƒ') || set.color.includes('ãƒ”ãƒ³ã‚¯')) shortColor = 'æ¡ƒ';
                            else if (set.color.includes('è™¹')) shortColor = 'è™¹';
                            else if (set.color.includes('æ··')) shortColor = 'æ··';
                            else if (set.color.includes('ç™½')) shortColor = 'ç™½';
                            else if (set.color.includes('é»’')) shortColor = 'é»’';
                            else if (set.color.includes('ç´«')) shortColor = 'ç´«';
                            else if (set.color.includes('æ©™') || set.color.includes('ã‚ªãƒ¬ãƒ³ã‚¸')) shortColor = 'æ©™';
                            else if (set.color.length > 0) shortColor = set.color.charAt(0);
                            
                            detailParts.push(`${shortColor}${set.weight}g`);
                        });
                        
                        weight = unitTotalWeight * quantity;
                        productDetail = detailParts.join('');
                    } else {
                        // å•†å“åã‹ã‚‰é‡é‡ã‚’æ¨å®š
                        const weightMatch = productName?.match(/(\d+)g/);
                        if (weightMatch) {
                            weight = parseInt(weightMatch[1]) * quantity;
                        }
                    }

                    orders.push({
                        source: 'Amazon',
                        sku: sku,
                        productName: productDetail,
                        quantity: quantity,
                        recipientName: recipientName,
                        shipAddress: shipAddress,
                        zipCode: formatZipCode(zipCode),
                        phoneNumber: formatPhoneNumber(phoneNumber),
                        weight: weight,
                        orderId: `${orderId}:${orderItemId}:${quantity}`
                    });
                } catch (error) {
                    console.error(`Amazon row ${i} error:`, error);
                }
            }
            
            console.log('Amazon orders processed:', orders.length);
            return orders;
        }

        async function processRakutenData(rakutenData) {
            const orders = [];
            
            const parsed = Papa.parse(rakutenData, { 
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
            });
            
            if (!parsed.data || parsed.data.length === 0) return orders;
            
            console.log('Rakuten headers:', Object.keys(parsed.data[0]));
            
            parsed.data.forEach((row, index) => {
                try {
                    const orderId = row['æ³¨æ–‡ç•ªå·']?.trim();
                    const itemId = row['å•†å“ç®¡ç†ç•ªå·']?.trim();
                    const itemName = row['å•†å“å']?.trim();
                    const quantity = parseInt(row['å€‹æ•°']) || 1;
                    const skuInfo = row['SKUæƒ…å ±']?.trim(); // SKUæƒ…å ±ã‚’å–å¾—
                    
                    const shipLastName = row['é€ä»˜å…ˆå§“']?.trim() || '';
                    const shipFirstName = row['é€ä»˜å…ˆå']?.trim() || '';
                    const shipName = `${shipLastName} ${shipFirstName}`.trim();
                    
                    const shipPhone1 = row['é€ä»˜å…ˆé›»è©±ç•ªå·1']?.trim() || '';
                    const shipPhone2 = row['é€ä»˜å…ˆé›»è©±ç•ªå·2']?.trim() || '';
                    const shipPhone3 = row['é€ä»˜å…ˆé›»è©±ç•ªå·3']?.trim() || '';
                    const phoneNumber = formatPhoneNumber(`${shipPhone1}-${shipPhone2}-${shipPhone3}`);
                    
                    const shipZip1 = row['é€ä»˜å…ˆéƒµä¾¿ç•ªå·1']?.toString().trim() || '';
                    const shipZip2 = row['é€ä»˜å…ˆéƒµä¾¿ç•ªå·2']?.toString().trim() || '';
                    
                    // æ¥½å¤©éƒµä¾¿ç•ªå·: AJåˆ—ã‚’3æ¡ã€AKåˆ—ã‚’4æ¡ã«0åŸ‹ã‚
                    const paddedZip1 = shipZip1.padStart(3, '0');
                    const paddedZip2 = shipZip2.padStart(4, '0');
                    const zipCode = formatZipCode(`${paddedZip1}${paddedZip2}`);
                    
                    const shipPref = row['é€ä»˜å…ˆä½æ‰€éƒ½é“åºœçœŒ']?.trim() || '';
                    const shipCity = row['é€ä»˜å…ˆä½æ‰€éƒ¡å¸‚åŒº']?.trim() || '';
                    const shipAddr = row['é€ä»˜å…ˆä½æ‰€ãã‚Œä»¥é™ã®ä½æ‰€']?.trim() || '';
                    const shipApart = row['é€ä»˜å…ˆä½æ‰€ã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å']?.trim() || '';
                    
                    // æ¥½å¤©ä½æ‰€ã®å®Œå…¨ãªçµåˆ
                    const fullAddress = [shipPref, shipCity, shipAddr, shipApart]
                        .filter(addr => addr && addr.trim())
                        .join('');

                    if (!shipName || !fullAddress || !zipCode || !phoneNumber || !orderId) return;

                    // SKUæƒ…å ±ã¾ãŸã¯å•†å“ç®¡ç†ç•ªå·ã‹ã‚‰é‡é‡ãƒ»è‰²æƒ…å ±ã‚’å–å¾—
                    let weight = 50 * quantity; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡é‡Ã—æ³¨æ–‡æ•°
                    let productDetail = '';
                    let colorInfo = '';

                    // SKUæƒ…å ±ã‹ã‚‰è‰²ã¨é‡ã•ã‚’å–å¾—ï¼ˆä¾‹: "ã‚«ãƒ©ãƒ¼:ãƒ”ãƒ³ã‚¯ç¸80g"ï¼‰
                    if (skuInfo && colorMaster[skuInfo]) {
                        const masterInfo = colorMaster[skuInfo];
                        weight = masterInfo.weight * quantity;
                        colorInfo = masterInfo.shortColor; // ä¸€æ–‡å­—è¡¨ç¤ºç”¨
                        productDetail = `${colorInfo}${masterInfo.weight}g`;
                    } else if (productMaster[itemId]) {
                        // å¾“æ¥ã®å•†å“ç®¡ç†ç•ªå·ã§ã®æ¤œç´¢
                        const masterInfo = productMaster[itemId];
                        if (masterInfo.colorSets) {
                            let unitTotalWeight = 0;
                            const detailParts = [];
                            
                            masterInfo.colorSets.forEach(set => {
                                unitTotalWeight += set.weight * set.quantity;
                                // ä¸€æ–‡å­—è‰²è¡¨ç¤ºã«å¤‰æ›
                                let shortColor = set.color;
                                if (set.color.includes('èµ¤')) shortColor = 'èµ¤';
                                else if (set.color.includes('ç·‘')) shortColor = 'ç·‘';
                                else if (set.color.includes('é’')) shortColor = 'é’';
                                else if (set.color.includes('é»„')) shortColor = 'é»„';
                                else if (set.color.includes('æ¡ƒ') || set.color.includes('ãƒ”ãƒ³ã‚¯')) shortColor = 'æ¡ƒ';
                                else if (set.color.includes('è™¹')) shortColor = 'è™¹';
                                else if (set.color.includes('æ··')) shortColor = 'æ··';
                                else if (set.color.includes('ç™½')) shortColor = 'ç™½';
                                else if (set.color.includes('é»’')) shortColor = 'é»’';
                                else if (set.color.includes('ç´«')) shortColor = 'ç´«';
                                else if (set.color.includes('æ©™') || set.color.includes('ã‚ªãƒ¬ãƒ³ã‚¸')) shortColor = 'æ©™';
                                else if (set.color.length > 0) shortColor = set.color.charAt(0);
                                
                                detailParts.push(`${shortColor}${set.weight}g`);
                            });
                            
                            weight = unitTotalWeight * quantity;
                            productDetail = detailParts.join('');
                        }
                    } else {
                        // å•†å“åã‹ã‚‰é‡é‡æ¨å®š
                        const weightMatch = itemName?.match(/(\d+)g/);
                        if (weightMatch) {
                            weight = parseInt(weightMatch[1]) * quantity;
                            productDetail = `${weightMatch[1]}g`;
                        }
                    }

                    orders.push({
                        source: 'æ¥½å¤©',
                        sku: itemId,
                        productName: productDetail,
                        quantity: quantity,
                        recipientName: shipName,
                        shipAddress: fullAddress,
                        zipCode: zipCode,
                        phoneNumber: phoneNumber,
                        weight: weight,
                        orderId: orderId
                    });
                } catch (error) {
                    console.error(`Rakuten row ${index} error:`, error);
                }
            });
            
            console.log('Rakuten orders processed:', orders.length);
            return orders;
        }

        async function processYahooData(yahooData) {
            const orders = [];
            
            const parsed = Papa.parse(yahooData, { 
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
            });
            
            if (!parsed.data || parsed.data.length === 0) return orders;
            
            console.log('Yahoo headers:', Object.keys(parsed.data[0]));
            
            parsed.data.forEach((row, index) => {
                try {
                    const orderId = row['OrderId']?.trim();
                    let itemId = row['ItemId']?.trim();
                    const subCode = row['SubCode']?.trim(); // SubCodeã‚’å–å¾—
                    const title = row['Title']?.trim();
                    const quantityDetail = row['QuantityDetail']?.trim();
                    const shipName = row['ShipName']?.trim();
                    const shipAddress1 = row['ShipAddress1']?.trim() || '';
                    const shipAddress2 = row['ShipAddress2']?.trim() || '';
                    const shipCity = row['ShipCity']?.trim() || '';
                    const shipPrefecture = row['ShipPrefecture']?.trim() || '';
                    const shipAddressFull = row['ShipAddressFull']?.trim() || '';
                    
                    // Yahooä½æ‰€: ShipAddressFullã‚’å„ªå…ˆã€ãªã‘ã‚Œã°å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’çµåˆ
                    const shipAddress = shipAddressFull || 
                        [shipPrefecture, shipCity, shipAddress1, shipAddress2]
                            .filter(addr => addr && addr.trim())
                            .join('');
                    
                    const shipZip = row['ShipZipCode']?.toString().trim();
                    const shipPhone = formatPhoneNumber(row['ShipPhoneNumber']?.toString().trim());

                    if (!shipName || !shipAddress || !shipZip || !shipPhone || !orderId) return;

                    // SubCodeã‹ã‚‰å•†å“æƒ…å ±ã‚’å–å¾—
                    let totalWeight = 0;
                    let productDetails = [];
                    let totalQuantity = 0;

                    if (subCode && subCode.includes('&')) {
                        // è¤‡æ•°å•†å“ã®å ´åˆï¼ˆä¾‹: L1=greenmix60&L2=yellowgreen80ï¼‰
                        const items = subCode.split('&');
                        items.forEach(item => {
                            let cleanItemCode = '';
                            if (item.includes('=')) {
                                cleanItemCode = item.split('=')[1]; // = ã‚ˆã‚Šå¾Œã‚ã‚’å–å¾—
                            } else {
                                cleanItemCode = item.trim();
                            }
                            
                            console.log(`Yahoo multiple item: ${item} -> ${cleanItemCode}`);
                            
                            // QuantityDetailã‹ã‚‰è©²å½“å•†å“ã®æ•°é‡ã‚’å–å¾—
                            let quantity = 1;
                            if (quantityDetail) {
                                const quantityMatch = quantityDetail.match(new RegExp(`${cleanItemCode}:(\\d+)`));
                                quantity = quantityMatch ? parseInt(quantityMatch[1]) : 1;
                            }
                            
                            // ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿ã‹ã‚‰æƒ…å ±å–å¾—
                            if (colorMaster[cleanItemCode]) {
                                const masterInfo = colorMaster[cleanItemCode];
                                const itemTotalWeight = masterInfo.weight * quantity;
                                totalWeight += itemTotalWeight;
                                productDetails.push(`${masterInfo.shortColor}${masterInfo.weight}g`);
                                totalQuantity += quantity;
                            } else {
                                console.log(`Product not found in color master: ${cleanItemCode}`);
                                totalWeight += 50 * quantity;
                                productDetails.push(`ä¸æ˜:${cleanItemCode}`);
                                totalQuantity += quantity;
                            }
                        });
                    } else if (subCode) {
                        // å˜ä¸€å•†å“ã®å ´åˆ
                        const quantity = parseInt(quantityDetail) || 1;
                        
                        let cleanItemCode = subCode;
                        if (subCode.includes('=')) {
                            cleanItemCode = subCode.split('=')[1]; // = ã‚ˆã‚Šå¾Œã‚ã‚’å–å¾—
                        }
                        
                        console.log(`Yahoo single item: ${subCode} -> ${cleanItemCode}`);
                        
                        if (colorMaster[cleanItemCode]) {
                            const masterInfo = colorMaster[cleanItemCode];
                            totalWeight = masterInfo.weight * quantity;
                            productDetails.push(`${masterInfo.shortColor}${masterInfo.weight}g`);
                        } else {
                            console.log(`Product not found in color master: ${cleanItemCode}`);
                            // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é‡é‡æ¨å®š
                            const weightMatch = title?.match(/(\d+)g/);
                            totalWeight = weightMatch ? parseInt(weightMatch[1]) * quantity : 50 * quantity;
                            productDetails.push(`ä¸æ˜:${cleanItemCode}`);
                        }
                        totalQuantity = quantity;
                    } else {
                        // SubCodeãŒç©ºã®å ´åˆã¯å¾“æ¥ã®ItemIdå‡¦ç†
                        const quantity = parseInt(quantityDetail) || 1;
                        totalQuantity = quantity;
                        
                        if (itemId?.includes('&')) {
                            // è¤‡æ•°å•†å“ã®å ´åˆï¼ˆä¾‹: L1=bara60&L2=bara80ï¼‰
                            const items = itemId.split('&');
                            items.forEach(item => {
                                let cleanItemCode = '';
                                if (item.includes('=')) {
                                    cleanItemCode = item.split('=')[1]; // = ã‚ˆã‚Šå¾Œã‚ã‚’å–å¾—
                                } else {
                                    cleanItemCode = item.trim();
                                }
                                
                                const masterInfo = productMaster[cleanItemCode];
                                if (masterInfo && masterInfo.colorSets) {
                                    let itemUnitWeight = 0;
                                    const itemDetailParts = [];
                                    
                                    masterInfo.colorSets.forEach(set => {
                                        itemUnitWeight += set.weight * set.quantity;
                                        // ä¸€æ–‡å­—è‰²è¡¨ç¤ºã«å¤‰æ›
                                        let shortColor = set.color;
                                        if (set.color.includes('èµ¤')) shortColor = 'èµ¤';
                                        else if (set.color.includes('ç·‘')) shortColor = 'ç·‘';
                                        else if (set.color.includes('é’')) shortColor = 'é’';
                                        else if (set.color.includes('é»„')) shortColor = 'é»„';
                                        else if (set.color.includes('æ¡ƒ') || set.color.includes('ãƒ”ãƒ³ã‚¯')) shortColor = 'æ¡ƒ';
                                        else if (set.color.includes('è™¹')) shortColor = 'è™¹';
                                        else if (set.color.includes('æ··')) shortColor = 'æ··';
                                        else if (set.color.includes('ç™½')) shortColor = 'ç™½';
                                        else if (set.color.includes('é»’')) shortColor = 'é»’';
                                        else if (set.color.includes('ç´«')) shortColor = 'ç´«';
                                        else if (set.color.includes('æ©™') || set.color.includes('ã‚ªãƒ¬ãƒ³ã‚¸')) shortColor = 'æ©™';
                                        else if (set.color.length > 0) shortColor = set.color.charAt(0);
                                        
                                        itemDetailParts.push(`${shortColor}${set.weight}g`);
                                    });
                                    
                                    const itemTotalWeight = itemUnitWeight * (quantity / items.length);
                                    totalWeight += itemTotalWeight;
                                    productDetails.push(itemDetailParts.join(''));
                                } else {
                                    totalWeight += 50 * (quantity / items.length);
                                    productDetails.push(`ä¸æ˜:${cleanItemCode}`);
                                }
                            });
                        } else {
                            // å˜ä¸€å•†å“ã®å ´åˆï¼ˆä¾‹: L1=bara60ï¼‰
                            let cleanItemCode = itemId;
                            if (itemId && itemId.includes('=')) {
                                cleanItemCode = itemId.split('=')[1]; // = ã‚ˆã‚Šå¾Œã‚ã‚’å–å¾—
                            }
                            
                            const masterInfo = productMaster[cleanItemCode];
                            if (masterInfo && masterInfo.colorSets) {
                                let unitTotalWeight = 0;
                                const detailParts = [];
                                
                                masterInfo.colorSets.forEach(set => {
                                    unitTotalWeight += set.weight * set.quantity;
                                    // ä¸€æ–‡å­—è‰²è¡¨ç¤ºã«å¤‰æ›
                                    let shortColor = set.color;
                                    if (set.color.includes('èµ¤')) shortColor = 'èµ¤';
                                    else if (set.color.includes('ç·‘')) shortColor = 'ç·‘';
                                    else if (set.color.includes('é’')) shortColor = 'é’';
                                    else if (set.color.includes('é»„')) shortColor = 'é»„';
                                    else if (set.color.includes('æ¡ƒ') || set.color.includes('ãƒ”ãƒ³ã‚¯')) shortColor = 'æ¡ƒ';
                                    else if (set.color.includes('è™¹')) shortColor = 'è™¹';
                                    else if (set.color.includes('æ··')) shortColor = 'æ··';
                                    else if (set.color.includes('ç™½')) shortColor = 'ç™½';
                                    else if (set.color.includes('é»’')) shortColor = 'é»’';
                                    else if (set.color.includes('ç´«')) shortColor = 'ç´«';
                                    else if (set.color.includes('æ©™') || set.color.includes('ã‚ªãƒ¬ãƒ³ã‚¸')) shortColor = 'æ©™';
                                    else if (set.color.length > 0) shortColor = set.color.charAt(0);
                                    
                                    detailParts.push(`${shortColor}${set.weight}g`);
                                });
                                
                                totalWeight = unitTotalWeight * quantity;
                                productDetails.push(detailParts.join(''));
                            } else {
                                const weightMatch = title?.match(/(\d+)g/);
                                totalWeight = weightMatch ? parseInt(weightMatch[1]) * quantity : 50 * quantity;
                                productDetails.push(`ä¸æ˜:${cleanItemCode}`);
                            }
                        }
                    }

                    orders.push({
                        source: 'Yahoo',
                        sku: itemId,
                        productName: productDetails.join(''),
                        quantity: totalQuantity,
                        recipientName: shipName,
                        shipAddress: shipAddress,
                        zipCode: formatZipCode(shipZip),
                        phoneNumber: shipPhone,
                        weight: totalWeight,
                        orderId: orderId
                    });
                } catch (error) {
                    console.error(`Yahoo row ${index} error:`, error);
                }
            });
            
            console.log('Yahoo orders processed:', orders.length);
            return orders;
        }

        function mergeOrdersByRecipient(orders) {
            const merged = {};
            
            orders.forEach(order => {
                const key = `${order.recipientName}_${order.shipAddress}_${order.phoneNumber}`;
                
                if (merged[key]) {
                    merged[key].weight += order.weight;
                    merged[key].quantity += order.quantity;
                    merged[key].orderId += `,${order.orderId}`;
                    
                    if (!merged[key].productName.includes(order.productName)) {
                        merged[key].productName += `${order.productName}`;
                    }
                } else {
                    merged[key] = { ...order };
                }
            });
            
            return Object.values(merged);
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            
            const cleaned = phone.replace(/[^\d]/g, '');
            const withZero = cleaned.startsWith('0') ? cleaned : '0' + cleaned;
            
            if (withZero.length === 10) {
                return `${withZero.substr(0, 3)}-${withZero.substr(3, 3)}-${withZero.substr(6, 4)}`;
            } else if (withZero.length === 11) {
                return `${withZero.substr(0, 3)}-${withZero.substr(3, 4)}-${withZero.substr(7, 4)}`;
            }
            
            return withZero;
        }

        function formatZipCode(zipCode) {
            if (!zipCode) return '';
            
            const cleaned = zipCode.replace(/[^\d]/g, '');
            
            // æ¥½å¤©ã®éƒµä¾¿ç•ªå·ä¿®æ­£å‡¦ç†
            if (cleaned.length === 5) {
                if (cleaned.startsWith('133') && cleaned.endsWith('55')) {
                    return '133-0055';
                }
                if (cleaned.startsWith('590') && cleaned.endsWith('06')) {
                    return '590-0006';
                }
            }
            
            if (cleaned.length === 7) {
                return `${cleaned.substr(0, 3)}-${cleaned.substr(3, 4)}`;
            }
            
            return cleaned;
        }

        function generateYamatoCSV(orders) {
            const headers = [
                'é€ã‚ŠçŠ¶ç¨®é¡','å‡ºè·äºˆå®šæ—¥','ãŠå±Šã‘äºˆå®šæ—¥','é…é”æ™‚é–“å¸¯','ãŠå±Šã‘å…ˆé›»è©±ç•ªå·',
                'ãŠå±Šã‘å…ˆéƒµä¾¿ç•ªå·','ãŠå±Šã‘å…ˆä½æ‰€','ãŠå±Šã‘å…ˆã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å','ãŠå±Šã‘å…ˆå',
                'ã”ä¾é ¼ä¸»é›»è©±ç•ªå·','ã”ä¾é ¼ä¸»éƒµä¾¿ç•ªå·','ã”ä¾é ¼ä¸»ä½æ‰€','ã”ä¾é ¼ä¸»å','å“åï¼‘',
                'ç·é‡é‡(g)','å“åè©³ç´°','ä¸æ˜å“å','è²©å£²ID','',''
            ];

            const rows = [headers.join(',')];
            
            const today = new Date();
            const shipDate = `${today.getFullYear()}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getDate().toString().padStart(2, '0')}`;

            // 1kgè¶…ãˆã®åˆ¤å®šã¨ã‚½ãƒ¼ãƒˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³12å¯¾å¿œï¼‰
            const normalOrders = [];
            const heavyOrders = [];
            
            orders.forEach(order => {
                if (order.weight > 1000) {
                    heavyOrders.push(order);
                } else {
                    normalOrders.push(order);
                }
            });
            
            // é€šå¸¸ã®æ³¨æ–‡ã‚’å…ˆã«ã€1kgè¶…ãˆã‚’å¾Œã«é…ç½®
            const sortedOrders = [...normalOrders, ...heavyOrders];

            sortedOrders.forEach(order => {
                const escapeCSV = (str) => {
                    if (!str) return '';
                    const strValue = String(str);
                    if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) {
                        return '"' + strValue.replace(/"/g, '""') + '"';
                    }
                    return strValue;
                };
                
                // é€ã‚ŠçŠ¶ç¨®é¡ã®åˆ¤å®šï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³12å¯¾å¿œï¼‰
                let shipType = 'A'; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³10ã§7â†’Aå¤‰æ›´
                if (order.weight > 1000) {
                    shipType = 'Z'; // 1kgè¶…ãˆã¯Zè¡¨ç¤º
                }
                
                // å•†å“åã®å‡¦ç†ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³12å¯¾å¿œï¼‰
                const productName = order.productName || '';
                let displayProductName = productName;
                let detailProductName = '';
                
                // 25æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã®å‡¦ç†
                if (productName.length > 25) {
                    displayProductName = productName.substring(0, 25); // 25æ–‡å­—ã§åˆ‡ã‚Šè©°ã‚
                    detailProductName = productName; // Påˆ—ã«å®Œå…¨ãªå•†å“åã‚’è¨˜è¼‰
                }
                
                const row = [
                    shipType, // é€ã‚ŠçŠ¶ç¨®é¡ï¼ˆA ã¾ãŸã¯ Zï¼‰
                    shipDate,
                    '', // ãŠå±Šã‘äºˆå®šæ—¥
                    '', // é…é”æ™‚é–“å¸¯
                    escapeCSV(order.phoneNumber),
                    escapeCSV(order.zipCode),
                    escapeCSV(order.shipAddress),
                    '', // ã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å
                    escapeCSV(order.recipientName),
                    '050-3590-1444', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥é›»è©±ç•ªå·
                    '104-0061', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥éƒµä¾¿ç•ªå·
                    'æ±äº¬éƒ½ä¸­å¤®åŒºéŠ€åº§1-22-11 2F', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥ä½æ‰€
                    'JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥å
                    escapeCSV(displayProductName), // å“åï¼ˆ25æ–‡å­—åˆ¶é™ï¼‰
                    Math.round(order.weight || 50),
                    escapeCSV(detailProductName), // å“åè©³ç´°ï¼ˆPåˆ—ï¼‰
                    '', // ä¸æ˜å“å
                    escapeCSV(order.orderId),
                    '', ''
                ];
                rows.push(row.join(','));
            });

            return rows.join('\r\n');
        }

        function showProgress() {
            document.querySelector('.upload-section').style.display = 'none';
            convertButton.style.display = 'none';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
        }

        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function showResult(csvContent, stats) {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            messageArea.innerHTML = `
                <div class="success-message">
                    <strong>ğŸ‰ å¤‰æ›å®Œäº†ï¼</strong><br>
                    ${stats.original}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’${stats.merged}ä»¶ã«ã¾ã¨ã‚ã¦ãƒ¤ãƒãƒˆé‹è¼¸å½¢å¼ã«å¤‰æ›ã—ã¾ã—ãŸã€‚
                </div>
                
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="stat-number">${stats.amazon}</div>
                        <div class="stat-label">Amazon</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.rakuten}</div>
                        <div class="stat-label">æ¥½å¤©</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.yahoo}</div>
                        <div class="stat-label">Yahoo</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.merged}</div>
                        <div class="stat-label">æœ€çµ‚ä»¶æ•°</div>
                    </div>
                    ${stats.heavy > 0 ? `<div class="stat-box" style="background: #fff3cd; border-color: #ffeaa7;">
                        <div class="stat-number" style="color: #856404;">${stats.heavy}</div>
                        <div class="stat-label" style="color: #856404;">1kgè¶…é(Zç¨®åˆ¥)</div>
                    </div>` : ''}
                </div>
            `;
            
            downloadButton.style.display = 'block';
            window.csvData = csvContent;
            
            downloadButton.onclick = () => downloadCSV(csvContent, stats.merged);
        }

        function downloadCSV(csvContent, recordCount) {
            try {
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `YBMdata_Ver12_${getCurrentDateString()}.csv`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                downloadButton.textContent = 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼';
                downloadButton.style.background = '#218838';
                
            } catch (error) {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function getCurrentDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function showError(message) {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            messageArea.innerHTML = `
                <div class="error-message">
                    <strong>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong><br>
                    ${message}<br><br>
                    <small>ç¢ºèªé …ç›®ï¼š<br>
                    â€¢ å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹<br>
                    â€¢ ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ã„ã‹ï¼ˆAmazon: TSVã€æ¥½å¤©ãƒ»Yahoo: CSVï¼‰<br>
                    â€¢ ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ãªã„ã‹<br>
                    â€¢ ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆSheet2ï¼‰ãŒå­˜åœ¨ã™ã‚‹ã‹</small>
                </div>
            `;
            
            downloadButton.style.display = 'none';
        }

        // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        resetButton.addEventListener('click', () => {
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            masterFile.value = '';
            amazonFile.value = '';
            rakutenFile.value = '';
            yahooFile.value = '';
            
            selectedFiles = { master: null, amazon: null, rakuten: null, yahoo: null };
            productMaster = {};
            colorMaster = {};
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const statusElements = [
                { id: 'masterStatus', text: 'å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'amazonStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'rakutenStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'yahooStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' }
            ];
            
            statusElements.forEach(({ id, text }) => {
                const element = document.getElementById(id);
                element.textContent = text;
                element.className = 'file-status';
                element.style.color = '';
            });
            
            // ã‚¤ãƒ³ãƒ—ãƒƒãƒˆè¦ç´ ã®ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            [masterFile, amazonFile, rakutenFile, yahooFile].forEach(input => {
                input.classList.remove('has-file');
            });
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelector('.upload-section').style.display = 'block';
            convertButton.style.display = 'block';
            convertButton.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            
            downloadButton.textContent = 'ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            downloadButton.style.background = '#28a745';
            
            updateConvertButton();
        });

        // åˆæœŸåŒ–
        updateConvertButton();
    </script>
</body>
</html>
        sheetName.includes('å•†å“ãƒã‚¹ã‚¿') || sheetName.includes('master') || sheetName.includes('Master')) {
                        masterSheet = workbook.Sheets[sheetName];
                        console.log('Found master sheet:', sheetName);
                        break;
                    }
                }
                
                // ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‚’æ¢ã™ï¼ˆæ–°è¦ï¼‰
                let colorSheet = null;
                for (const sheetName of workbook.SheetNames) {
                    if (sheetName.includes('Sheet2') || sheetName.includes('ã‚«ãƒ©ãƒ¼') || sheetName.includes('å¯¾å¿œè¡¨')) {
                        colorSheet = workbook.Sheets[sheetName];
                        console.log('Found color sheet:', sheetName);
                        break;
                    }
                }
                
                // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨
                if (!masterSheet && workbook.SheetNames.length > 0) {
                    masterSheet = workbook.Sheets[workbook.SheetNames[0]];
                    console.log('Using first sheet as master:', workbook.SheetNames[0]);
                }
                
                if (!colorSheet && workbook.SheetNames.length > 1) {
                    colorSheet = workbook.Sheets[workbook.SheetNames[1]];
                    console.log('Using second sheet as color:', workbook.SheetNames[1]);
                } else if (!colorSheet && workbook.SheetNames.length > 0) {
                    colorSheet = workbook.Sheets[workbook.SheetNames[0]];
                    console.log('Using first sheet as color:', workbook.SheetNames[0]);
                }
                
                let loadedCount = 0;
                let colorLoadedCount = 0;
                
                // å¾“æ¥ã®å•†å“ãƒã‚¹ã‚¿å‡¦ç†
                if (masterSheet) {
                    const jsonData = XLSX.utils.sheet_to_json(masterSheet, { 
                        header: 1,
                        defval: '',
                        blankrows: false
                    });
                    
                    console.log('Master data rows:', jsonData.length);
                    console.log('Headers:', jsonData[0]);
                    
                    productMaster = {};
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length >= 3 && row[0] && row[2] && row[0] !== 'FBA') {
                            const site = String(row[0]).trim();
                            const detail = String(row[1] || '').trim();
                            const productNo = String(row[2]).trim();
                            
                            const colorSets = [];
                            const columnGroups = [
                                [3, 4, 5],   // D, E, F
                                [6, 7, 8],   // G, H, I  
                                [9, 10, 11], // J, K, L
                                [12, 13, 14], // M, N, O
                                [15, 16, 17]  // P, Q, R
                            ];
                            
                            columnGroups.forEach(([weightCol, quantityCol, colorCol]) => {
                                const weight = parseFloat(row[weightCol]) || 0;
                                const quantity = parseInt(row[quantityCol]) || 0;
                                const color = String(row[colorCol] || '').trim();
                                
                                if (weight > 0 && quantity > 0 && color) {
                                    colorSets.push({
                                        weight: weight,
                                        quantity: quantity,
                                        color: color
                                    });
                                }
                            });
                            
                            if (colorSets.length > 0) {
                                productMaster[productNo] = {
                                    site: site,
                                    detail: detail,
                                    colorSets: colorSets
                                };
                                loadedCount++;
                            }
                        }
                    }
                }
                
                // ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿å‡¦ç†ï¼ˆæ–°è¦ï¼‰
                if (colorSheet) {
                    const colorData = XLSX.utils.sheet_to_json(colorSheet, { 
                        header: 1,
                        defval: '',
                        blankrows: false
                    });
                    
                    console.log('Color data rows:', colorData.length);
                    console.log('Color headers:', colorData[0]);
                    
                    colorMaster = {};
                    
                    for (let i = 1; i < colorData.length; i++) {
                        const row = colorData[i];
                        if (row.length >= 5) {
                            const yahooCode = String(row[1] || '').trim(); // Yahooè¡¨è¨˜
                            const rakutenCode = String(row[2] || '').trim(); // æ¥½å¤©è¡¨è¨˜
                            const color = String(row[3] || '').trim(); // è‰²
                            const weightStr = String(row[4] || '').trim(); // é‡ã•
                            
                            // é‡é‡ã‚’æ•°å€¤ã«å¤‰æ›
                            const weightMatch = weightStr.match(/(\d+)/);
                            const weight = weightMatch ? parseInt(weightMatch[1]) : 0;
                            
                            // ä¸€æ–‡å­—è‰²è¡¨ç¤ºï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³12å¯¾å¿œï¼‰
                            let shortColor = color;
                            if (color.includes('èµ¤')) shortColor = 'èµ¤';
                            else if (color.includes('ç·‘')) shortColor = 'ç·‘';
                            else if (color.includes('é’')) shortColor = 'é’';
                            else if (color.includes('é»„')) shortColor = 'é»„';
                            else if (color.includes('æ¡ƒ') || color.includes('ãƒ”ãƒ³ã‚¯')) shortColor = 'æ¡ƒ';
                            else if (color.includes('è™¹')) shortColor = 'è™¹';
                            else if (color.includes('æ··')) shortColor = 'æ··';
                            else if (color.includes('ç™½')) shortColor = 'ç™½';
                            else if (color.includes('é»’')) shortColor = 'é»’';
                            else if (color.includes('ç´«')) shortColor = 'ç´«';
                            else if (color.includes('æ©™') || color.includes('ã‚ªãƒ¬ãƒ³ã‚¸')) shortColor = 'æ©™';
                            else if (color.length > 0) shortColor = color.charAt(0);
                            
                            // Yahooè¡¨è¨˜ã§ã®ç™»éŒ²
                            if (yahooCode && weight > 0) {
                                colorMaster[yahooCode] = {
                                    color: color,
                                    shortColor: shortColor,
                                    weight: weight,
                                    source: 'yahoo'
                                };
                                colorLoadedCount++;
                            }
                            
                            // æ¥½å¤©è¡¨è¨˜ã§ã®ç™»éŒ²
                            if (rakutenCode && weight > 0) {
                                colorMaster[rakutenCode] = {
                                    color: color,
                                    shortColor: shortColor,
                                    weight: weight,
                                    source: 'rakuten'
                                };
                                colorLoadedCount++;
                            }
                        }
                    }
                }
                
                console.log(`Product master loaded: ${loadedCount} products`);
                console.log(`Color master loaded: ${colorLoadedCount} items`);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                const masterStatus = document.getElementById('masterStatus');
                masterStatus.textContent = `âœ… å•†å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${loadedCount}ä»¶ã€ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿: ${colorLoadedCount}ä»¶`;
                masterStatus.className = 'file-status success';
                
            } catch (error) {
                console.error('å•†å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const masterStatus = document.getElementById('masterStatus');
                masterStatus.textContent = `âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                masterStatus.className = 'file-status';
                masterStatus.style.color = '#e53e3e';
                productMaster = {};
                colorMaster = {};
            }
        }

        function updateConvertButton() {
            // å•†å“ãƒã‚¹ã‚¿ã¯å¿…é ˆã€ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å°‘ãªãã¨ã‚‚1ã¤ã¯å¿…è¦
            const hasMaster = selectedFiles.master && (Object.keys(productMaster).length > 0 || Object.keys(colorMaster).length > 0);
            const hasData = selectedFiles.amazon || selectedFiles.rakuten || selectedFiles.yahoo;
            
            convertButton.disabled = !hasMaster || !hasData;
            
            console.log('Button update:', { hasMaster, hasData, disabled: convertButton.disabled });
        }

        // å¤‰æ›å‡¦ç†
        convertButton.addEventListener('click', async () => {
            try {
                showProgress();
                updateProgress(10, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

                const results = [];
                
                // Amazonãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.amazon) {
                    updateProgress(25, 'Amazonãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const amazonData = await readFileWithEncoding(selectedFiles.amazon);
                    const amazonOrders = await processAmazonData(amazonData);
                    results.push(...amazonOrders);
                }

                // æ¥½å¤©ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.rakuten) {
                    updateProgress(45, 'æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const rakutenData = await readFileWithEncoding(selectedFiles.rakuten);
                    const rakutenOrders = await processRakutenData(rakutenData);
                    results.push(...rakutenOrders);
                }

                // Yahooãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.yahoo) {
                    updateProgress(65, 'Yahooãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const yahooData = await readFileWithEncoding(selectedFiles.yahoo);
                    const yahooOrders = await processYahooData(yahooData);
                    results.push(...yahooOrders);
                }

                // ãƒ‡ãƒ¼ã‚¿çµ±åˆ
                updateProgress(80, 'ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆä¸­...');
                const mergedOrders = mergeOrdersByRecipient(results);
                
                updateProgress(90, 'CSVç”Ÿæˆä¸­...');
                const csvContent = generateYamatoCSV(mergedOrders);
                
                updateProgress(100, 'å¤‰æ›å®Œäº†!');
                
                setTimeout(() => {
                    showResult(csvContent, {
                        original: results.length,
                        merged: mergedOrders.length,
                        amazon: results.filter(r => r.source === 'Amazon').length,
                        rakuten: results.filter(r => r.source === 'æ¥½å¤©').length,
                        yahoo: results.filter(r => r.source === 'Yahoo').length,
                        heavy: mergedOrders.filter(r => r.weight > 1000).length,
                        unknownProducts: []
                    });
                }, 500);

            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                showError(error.message);
            }
        });

        async function readFileWithEncoding(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const buffer = new Uint8Array(e.target.result);
                        
                        // UTF-8ã§è©¦è¡Œ
                        let result;
                        try {
                            result = new TextDecoder('utf-8', { fatal: true }).decode(buffer);
                        } catch {
                            // Shift-JISã§è©¦è¡Œ
                            try {
                                result = new TextDecoder('shift-jis', { fatal: false }).decode(buffer);
                            } catch {
                                // æœ€å¾Œã®æ‰‹æ®µï¼šéå³å¯†ãªUTF-8
                                result = new TextDecoder('utf-8', { fatal: false }).decode(buffer);
                            }
                        }
                        
                        resolve(result);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function processAmazonData(amazonData) {
            const orders = [];
            const lines = amazonData.split('\n').filter(line => line.trim());
            
            if (lines.length <= 1) return orders;
            
            const headers = lines[0].split('\t');
            console.log('Amazon headers count:', headers.length);
            
            for (let i = 1; i < lines.length; i++) {
                const fields = lines[i].split('\t');
                if (fields.length < 20) continue; // æœ€ä½é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ãƒã‚§ãƒƒã‚¯
                
                try {
                    const sku = fields[11]?.trim();
                    const productName = fields[13]?.trim();
                    const quantity = parseInt(fields[14]) || 1;
                    const recipientName = fields[19]?.trim();
                    
                    // Amazonä½æ‰€ã®å®Œå…¨ãªçµåˆ: ship-state + ship-address-1 + ship-address-2 + ship-address-3
                    const shipState = fields[24]?.trim() || '';
                    const shipAddress1 = fields[20]?.trim() || '';
                    const shipAddress2 = fields[21]?.trim() || '';
                    const shipAddress3 = fields[22]?.trim() || '';
                    const shipAddress = [shipState, shipAddress1, shipAddress2, shipAddress3]
                        .filter(addr => addr && addr.trim())
                        .join('');
                    
                    const zipCode = fields[25]?.trim();
                    const phoneNumber = fields[10]?.trim();
                    const orderId = fields[0]?.trim();
                    const orderItemId = fields[1]?.trim();

                    if (!recipientName || !shipAddress || !zipCode || !phoneNumber) continue;

                    // å•†å“ãƒã‚¹ã‚¿ã‹ã‚‰é‡é‡æƒ…å ±å–å¾—ï¼ˆè¤‡æ•°ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆå¯¾å¿œï¼‰
                    const masterInfo = productMaster[sku];
                    let weight = 50 * quantity; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡é‡Ã—æ³¨æ–‡æ•°
                    let productDetail = productName;

                    if (
