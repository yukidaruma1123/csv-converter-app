<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ヤマト運輸発送データ作成マクロ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 30px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .sidebar h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .config-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .config-section input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .action-buttons {
            display: grid;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .main-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .upload-area.dragover {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .file-input {
            display: none;
        }

        .file-select-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table-header {
            background: #343a40;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
        }

        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #495057;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s;
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ヤマト運輸発送データ作成マクロ</h1>
            <p>ECサイトデータをヤマト運輸発送データに変換</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h2>📋 発送元データ</h2>
                
                <div class="config-section">
                    <label for="phone">ご依頼主電話番号 (半角数字15文字ハイフン含む)</label>
                    <input type="text" id="phone" value="050-3590-1444" maxlength="15">
                </div>

                <div class="config-section">
                    <label for="zipcode">ご依頼主郵便番号 (半角数字8文字)</label>
                    <input type="text" id="zipcode" value="104-0061" maxlength="8">
                </div>

                <div class="config-section">
                    <label for="address">ご依頼主住所 (全角32文字)</label>
                    <input type="text" id="address" value="東京都中央区銀座 1-22-11 2F" maxlength="32">
                </div>

                <div class="config-section">
                    <label for="name">ご依頼主名 (全角16文字)</label>
                    <input type="text" id="name" value="JGSフィッシュ" maxlength="16">
                </div>

                <h2>📝 使用方法</h2>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="clearData()">
                        <span>🗑️</span> ①：発送データを消去する
                    </button>
                    <button class="btn btn-primary" onclick="importData()">
                        <span>📥</span> ②：ECサイトの販売データを取り込む
                    </button>
                    <button class="btn btn-warning" onclick="previewData()">
                        <span>👁️</span> ③：取得した発送データを確認する
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <span>📤</span> ④：ヤマト輸送発送データをCSV出力
                    </button>
                </div>

                <div class="config-section">
                    <label>商品マスタ更新</label>
                    <input type="file" id="masterFile" class="file-input" accept=".xlsx,.xlsm" onchange="updateMaster(this)">
                    <button class="file-select-btn" onclick="document.getElementById('masterFile').click()">
                        📊 マスタファイル選択
                    </button>
                </div>
            </div>

            <div class="main-area">
                <div class="upload-area" id="uploadArea">
                    <h3>📁 ECサイトデータファイルをドロップまたは選択</h3>
                    <p>Amazon, Yahoo, 楽天のCSVファイルに対応</p>
                    <input type="file" id="dataFile" class="file-input" multiple accept=".csv,.txt" onchange="handleFiles(this.files)">
                    <button class="file-select-btn" onclick="document.getElementById('dataFile').click()">
                        ファイル選択
                    </button>
                </div>

                <div id="statusMessage"></div>
                <div id="progressBar" class="progress-bar" style="display: none;">
                    <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                </div>

                <div class="data-table" id="dataTable" style="display: none;">
                    <div class="table-header">
                        📦 処理結果プレビュー
                    </div>
                    <div class="table-content">
                        <table id="resultTable">
                            <thead id="tableHeader"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let productMaster = [];
        let processedData = [];
        let currentFiles = [];

        // 初期化時に商品マスタをデフォルトで設定
        window.onload = function() {
            initializeDefaultMaster();
            setupDragAndDrop();
        };

        // デフォルト商品マスタの初期化
        function initializeDefaultMaster() {
            productMaster = [
                ["販売サイト", "商品詳細", "商品No", "重さ", "個数", "色"],
                ["Yahoo", "15g 2個入 ゴールド金 メタルジグ タングステン", "jg152", 15, 2, "金"],
                ["Amazon", "メタルジグ タングステン 高純度 無塗装 定番形状", "jg256", 25, 6, "金"],
                // ... 他の商品データも同様に追加可能
            ];
            showStatus("デフォルト商品マスタを読み込みました", "info");
        }

        // ドラッグ&ドロップ設定
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
        }

        // ファイル処理
        function handleFiles(files) {
            currentFiles = Array.from(files);
            showStatus(`${files.length}個のファイルが選択されました`, "info");
            
            // ファイル名を表示
            const fileNames = Array.from(files).map(file => file.name).join(', ');
            document.getElementById('uploadArea').innerHTML = `
                <h3>📁 選択されたファイル</h3>
                <p>${fileNames}</p>
                <button class="file-select-btn" onclick="document.getElementById('dataFile').click()">
                    別のファイルを選択
                </button>
            `;
        }

        // 商品マスタ更新
        async function updateMaster(input) {
            const file = input.files[0];
            if (!file) return;

            try {
                showStatus("商品マスタを読み込み中...", "info");
                
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // 商品マスタシートを読み込み
                const masterSheetName = workbook.SheetNames.find(name => 
                    name.includes('商品マスタ') || name.includes('マスタ')
                ) || workbook.SheetNames[0];
                
                const worksheet = workbook.Sheets[masterSheetName];
                productMaster = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                showStatus(`商品マスタを更新しました (${productMaster.length - 1}件の商品)`, "success");
            } catch (error) {
                showStatus(`商品マスタの読み込みエラー: ${error.message}`, "error");
            }
        }

        // ①発送データを消去
        function clearData() {
            if (confirm('発送データを消去しますか？')) {
                processedData = [];
                currentFiles = [];
                document.getElementById('dataTable').style.display = 'none';
                document.getElementById('uploadArea').innerHTML = `
                    <h3>📁 ECサイトデータファイルをドロップまたは選択</h3>
                    <p>Amazon, Yahoo, 楽天のCSVファイルに対応</p>
                    <input type="file" id="dataFile" class="file-input" multiple accept=".csv,.txt" onchange="handleFiles(this.files)">
                    <button class="file-select-btn" onclick="document.getElementById('dataFile').click()">
                        ファイル選択
                    </button>
                `;
                showStatus("発送データを消去しました", "success");
            }
        }

        // ②ECサイトの販売データを取り込む
        async function importData() {
            if (currentFiles.length === 0) {
                showStatus("先にファイルを選択してください", "error");
                return;
            }

            try {
                showProgress(0);
                showStatus("データを取り込み中...", "info");
                
                processedData = [];
                
                for (let i = 0; i < currentFiles.length; i++) {
                    const file = currentFiles[i];
                    showProgress((i / currentFiles.length) * 100);
                    
                    const text = await file.text();
                    const data = parseCSV(text);
                    
                    // ファイル名からECサイトを判定
                    const ecSite = detectECSite(file.name, data);
                    const converted = convertToYamatoFormat(data, ecSite);
                    
                    processedData = processedData.concat(converted);
                }
                
                showProgress(100);
                showStatus(`${processedData.length}件のデータを取り込みました`, "success");
                
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                showStatus(`データ取り込みエラー: ${error.message}`, "error");
                document.getElementById('progressBar').style.display = 'none';
            }
        }

        // ③取得した発送データを確認
        function previewData() {
            if (processedData.length === 0) {
                showStatus("先にデータを取り込んでください", "error");
                return;
            }

            displayDataTable(processedData);
            showStatus(`${processedData.length}件のデータを表示中`, "info");
        }

        // ④ヤマト輸送発送データをCSV出力
        function exportData() {
            if (processedData.length === 0) {
                showStatus("出力するデータがありません", "error");
                return;
            }

            try {
                const csvContent = generateYamatoCSV(processedData);
                downloadCSV(csvContent, `yamato_shipping_${getDateString()}.csv`);
                showStatus(`${processedData.length}件のデータをCSVファイルに出力しました`, "success");
            } catch (error) {
                showStatus(`CSV出力エラー: ${error.message}`, "error");
            }
        }

        // CSV解析
        function parseCSV(text) {
            // 文字コード判定と変換
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const data = lines.map(line => {
                // CSVパース（簡易版）
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            });
            
            return data;
        }

        // ECサイト判定
        function detectECSite(filename, data) {
            const name = filename.toLowerCase();
            if (name.includes('amazon') || name.includes('18208008508020269')) return 'Amazon';
            if (name.includes('yahoo') || name.includes('yahooall')) return 'Yahoo';
            if (name.includes('rakuten') || name.includes('楽天') || name.includes('20250630')) return 'Rakuten';
            
            // ヘッダーから判定
            if (data.length > 0) {
                const header = data[0].join('').toLowerCase();
                if (header.includes('order-id') || header.includes('sku')) return 'Amazon';
                if (header.includes('orderid') || header.includes('itemid')) return 'Yahoo';
                if (header.includes('注文番号') || header.includes('商品名')) return 'Rakuten';
            }
            
            return 'Unknown';
        }

        // ヤマト形式への変換
        function convertToYamatoFormat(data, ecSite) {
            if (data.length === 0) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            const converted = [];
            
            const senderInfo = {
                phone: document.getElementById('phone').value,
                zipcode: document.getElementById('zipcode').value,
                address: document.getElementById('address').value,
                name: document.getElementById('name').value
            };

            rows.forEach(row => {
                try {
                    let convertedRow;
                    
                    switch (ecSite) {
                        case 'Amazon':
                            convertedRow = convertAmazonData(headers, row, senderInfo);
                            break;
                        case 'Yahoo':
                            convertedRow = convertYahooData(headers, row, senderInfo);
                            break;
                        case 'Rakuten':
                            convertedRow = convertRakutenData(headers, row, senderInfo);
                            break;
                        default:
                            convertedRow = convertGenericData(headers, row, senderInfo);
                    }
                    
                    if (convertedRow) {
                        converted.push(convertedRow);
                    }
                } catch (error) {
                    console.warn('行の変換でエラー:', error);
                }
            });
            
            return converted;
        }

        // Amazon データ変換
        function convertAmazonData(headers, row, senderInfo) {
            const getField = (fieldName) => {
                const index = headers.findIndex(h => h.toLowerCase().includes(fieldName.toLowerCase()));
                return index >= 0 ? row[index] : '';
            };

            const recipientName = getField('recipient-name') || getField('ship-name');
            const recipientAddress1 = getField('ship-address-1');
            const recipientAddress2 = getField('ship-address-2');
            const recipientCity = getField('ship-city');
            const recipientState = getField('ship-state');
            const recipientZip = getField('ship-postal-code');
            const productName = getField('product-name');
            const quantity = getField('quantity-purchased') || getField('quantity-shipped');

            // 商品情報の検索
            const productInfo = findProductInfo(productName);
            const totalWeight = calculateTotalWeight(productInfo, quantity);

            return [
                '0', // 送り状種類（発払い）
                formatDate(new Date()), // 出荷予定日
                '', // お届け予定日
                '', // 配達時間帯
                '', // お届け先電話番号（Amazonでは通常提供されない）
                formatZipCode(recipientZip),
                `${recipientState}${recipientCity}${recipientAddress1}`,
                recipientAddress2 || '',
                recipientName,
                senderInfo.phone,
                senderInfo.zipcode,
                senderInfo.address,
                senderInfo.name,
                productInfo.simpleName || productName.substring(0, 25),
                totalWeight || '',
                productName,
                '', // 不明品名
                getField('order-id') || getField('order-item-id')
            ];
        }

        // Yahoo データ変換
        function convertYahooData(headers, row, senderInfo) {
            const getField = (fieldName) => {
                const index = headers.findIndex(h => h.toLowerCase().includes(fieldName.toLowerCase()));
                return index >= 0 ? row[index] : '';
            };

            const shipName = getField('shipname') || getField('billname');
            const shipAddress1 = getField('shipaddress1') || getField('billaddress1');
            const shipAddress2 = getField('shipaddress2') || getField('billaddress2');
            const shipCity = getField('shipcity') || getField('billcity');
            const shipPrefecture = getField('shipprefecture') || getField('billprefecture');
            const shipZipCode = getField('shipzipcode') || getField('billzipcode');
            const title = getField('title');
            const quantity = getField('quantitydetail') || 1;

            // 商品情報の検索
            const productInfo = findProductInfo(title);
            const totalWeight = calculateTotalWeight(productInfo, quantity);

            return [
                '0', // 送り状種類
                formatDate(new Date()),
                '',
                '',
                '',
                formatZipCode(shipZipCode),
                `${shipPrefecture}${shipCity}${shipAddress1}`,
                shipAddress2 || '',
                shipName,
                senderInfo.phone,
                senderInfo.zipcode,
                senderInfo.address,
                senderInfo.name,
                productInfo.simpleName || title.substring(0, 25),
                totalWeight || '',
                title,
                '',
                getField('orderid') || getField('id')
            ];
        }

        // 楽天データ変換
        function convertRakutenData(headers, row, senderInfo) {
            const getField = (fieldName) => {
                const index = headers.findIndex(h => h.includes(fieldName));
                return index >= 0 ? row[index] : '';
            };

            const deliveryName = getField('配送先名') || getField('注文者名');
            const deliveryZip1 = getField('配送先郵便番号1');
            const deliveryZip2 = getField('配送先郵便番号2');
            const deliveryPrefecture = getField('配送先都道府県');
            const deliveryCity = getField('配送先市区町村');
            const deliveryAddress1 = getField('配送先住所1');
            const deliveryAddress2 = getField('配送先住所2') || '';
            const productName = getField('商品名');
            const quantity = getField('個数') || getField('数量') || 1;

            const productInfo = findProductInfo(productName);
            const totalWeight = calculateTotalWeight(productInfo, quantity);

            return [
                '0',
                formatDate(new Date()),
                '',
                '',
                '',
                `${deliveryZip1}-${deliveryZip2}`,
                `${deliveryPrefecture}${deliveryCity}${deliveryAddress1}`,
                deliveryAddress2,
                deliveryName,
                senderInfo.phone,
                senderInfo.zipcode,
                senderInfo.address,
                senderInfo.name,
                productInfo.simpleName || productName.substring(0, 25),
                totalWeight || '',
                productName,
                '',
                getField('注文番号') || getField('伝票番号')
            ];
        }

        // 汎用データ変換
        function convertGenericData(headers, row, senderInfo) {
            // 基本的な変換ロジック
            return [
                '0',
                formatDate(new Date()),
                '', '', '', '', '', '', '',
                senderInfo.phone,
                senderInfo.zipcode,
                senderInfo.address,
                senderInfo.name,
                '商品', '', '', '', ''
            ];
        }

        // 商品情報検索
        function findProductInfo(productName) {
            if (!productName || productMaster.length <= 1) {
                return { simpleName: '商品', weight: 0, quantity: 1 };
            }

            const searchName = productName.toLowerCase();
            
            for (let i = 1; i < productMaster.length; i++) {
                const product = productMaster[i];
                const productDetail = (product[1] || '').toLowerCase();
                const productNo = (product[2] || '').toLowerCase();
                
                if (searchName.includes(productNo) || productDetail.includes(searchName.substring(0, 10))) {
                    return {
                        simpleName: 'メタルジグ',
                        weight: product[3] || 0,
                        quantity: product[4] || 1,
                        color: product[5] || ''
                    };
                }
            }

            // 重量を商品名から推定
            const weightMatch = productName.match(/(\d+)g/);
            const weight = weightMatch ? parseInt(weightMatch[1]) : 0;

            return {
                simpleName: 'メタルジグ',
                weight: weight,
                quantity: 1,
                color: ''
            };
        }

        // 総重量計算
        function calculateTotalWeight(productInfo, quantity) {
            const qty = parseInt(quantity) || 1;
            const weight = productInfo.weight || 0;
            const productQty = productInfo.quantity || 1;
            return weight * productQty * qty;
        }

        // 日付フォーマット
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // 郵便番号フォーマット
        function formatZipCode(zipCode) {
            if (!zipCode) return '';
            const cleaned = zipCode.replace(/[^\d]/g, '');
            if (cleaned.length === 7) {
                return `${cleaned.substring(0, 3)}-${cleaned.substring(3)}`;
            }
            return zipCode;
        }

        // 日付文字列生成
        function getDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // データテーブル表示
        function displayDataTable(data) {
            if (data.length === 0) return;

            const headers = [
                '送り状種類', '出荷予定日', 'お届け予定日', '配達時間帯',
                'お届け先電話番号', 'お届け先郵便番号', 'お届け先住所',
                'お届け先アパートマンション名', 'お届け先名',
                'ご依頼主電話番号', 'ご依頼主郵便番号', 'ご依頼主住所', 'ご依頼主名',
                '品名', '総重量(g)', '品名詳細', '不明品名', '販売ID'
            ];

            let html = '<tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr>';

            document.getElementById('tableHeader').innerHTML = html;

            let bodyHtml = '';
            data.slice(0, 100).forEach(row => { // 最初の100行のみ表示
                bodyHtml += '<tr>';
                row.forEach(cell => {
                    bodyHtml += `<td>${cell || ''}</td>`;
                });
                bodyHtml += '</tr>';
            });

            document.getElementById('tableBody').innerHTML = bodyHtml;
            document.getElementById('dataTable').style.display = 'block';
        }

        // ヤマトCSV生成
        function generateYamatoCSV(data) {
            const headers = [
                '送り状種類', '出荷予定日', 'お届け予定日', '配達時間帯',
                'お届け先電話番号', 'お届け先郵便番号', 'お届け先住所',
                'お届け先アパートマンション名', 'お届け先名',
                'ご依頼主電話番号', 'ご依頼主郵便番号', 'ご依頼主住所', 'ご依頼主名',
                '品名１', '総重量(g)', '品名詳細', '不明品名', '販売ID'
            ];

            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                const escapedRow = row.map(cell => {
                    const str = String(cell || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                });
                csv += escapedRow.join(',') + '\n';
            });

            return csv;
        }

        // CSV ダウンロード
        function downloadCSV(content, filename) {
            const bom = '\uFEFF'; // UTF-8 BOM
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ステータス表示
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // プログレスバー表示
        function showProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = `${percentage}%`;
        }

        // XLSX ライブラリを動的に読み込み
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
