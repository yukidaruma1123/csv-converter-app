<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3äº¤ä»£å‹¤å‹™è‡ªå‹•ã‚·ãƒ•ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 70vh;
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .section h3 {
            color: #4a90e2;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
        }
        
        .employee-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
        }
        
        .schedule-container {
            overflow-x: auto;
            overflow-y: visible;
            margin-top: 20px;
            border: 1px solid #ddd;
            background: white;
            -webkit-overflow-scrolling: touch;
        }
        
        .schedule-grid {
            display: table;
            border-collapse: collapse;
            background: white;
            width: max-content;
            min-width: 100%;
        }
        
        .schedule-row {
            display: table-row;
        }
        
        .schedule-cell {
            display: table-cell;
            background: white;
            padding: 10px 8px;
            text-align: center;
            width: 60px;
            vertical-align: middle;
            font-size: 13px;
            font-weight: normal;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        
        .schedule-cell.schedule-name {
            width: 100px;
            min-width: 100px;
            text-align: left;
            padding-left: 12px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .schedule-header {
            background: #f5f5f5;
            color: #333;
            font-weight: bold;
            border: 1px solid #bbb;
        }
        
        .schedule-name {
            background: #f9f9f9;
            font-weight: bold;
            color: #333;
            border: 1px solid #bbb;
        }
        
        .shift-day {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .shift-evening {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .shift-night {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .shift-off {
            background: #ffebee;
            color: #c62828;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border: 1px solid #999;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .constraints-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .constraints-grid {
                grid-template-columns: 1fr;
            }
            
            .schedule-container {
                margin: 10px -15px;
                border: none;
            }
            
            .schedule-cell {
                padding: 8px 4px;
                font-size: 12px;
                width: 45px;
            }
            
            .schedule-cell.schedule-name {
                width: 70px;
                min-width: 70px;
                font-size: 11px;
                padding-left: 8px;
            }
            
            .legend {
                gap: 10px;
                margin: 15px 0;
            }
            
            .legend-item {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>3äº¤ä»£å‹¤å‹™è‡ªå‹•ã‚·ãƒ•ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«</h1>
            <p>AIæ­è¼‰ãƒ»åŠ´åƒåŸºæº–æ³•å¯¾å¿œãƒ»Excelå‡ºåŠ›å¯¾å¿œ</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="section">
                    <h3>åŸºæœ¬è¨­å®š</h3>
                    <div class="form-group">
                        <label>å¯¾è±¡æœˆ</label>
                        <input type="month" id="targetMonth" />
                    </div>
                    <div class="form-group">
                        <label>ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </label>
                        <input type="text" id="employeeName" placeholder="ã‚¹ã‚¿ãƒƒãƒ•å" />
                        <button class="btn btn-primary btn-small" onclick="addEmployee()" style="margin-top: 8px;">è¿½åŠ </button>
                    </div>
                    <div class="employee-list" id="employeeList">
                        <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
                
                <div class="section">
                    <h3>åˆ¶ç´„æ¡ä»¶</h3>
                    <div class="constraints-grid">
                        <div class="form-group">
                            <label>æœ€å¤§é€£ç¶šå‹¤å‹™æ—¥æ•°</label>
                            <input type="number" id="maxConsecutiveDays" value="5" min="1" max="10" />
                        </div>
                        <div class="form-group">
                            <label>æœ€å°ä¼‘æ—¥æ•°/æœˆ</label>
                            <input type="number" id="minDaysOff" value="8" min="4" max="15" />
                        </div>
                        <div class="form-group">
                            <label>æ·±å¤œå‹¤å‹™å¾Œã®ä¼‘æ†©æ™‚é–“</label>
                            <input type="number" id="nightShiftRest" value="16" min="8" max="24" />
                        </div>
                        <div class="form-group">
                            <label>æœˆé–“åŠ´åƒæ™‚é–“ä¸Šé™</label>
                            <input type="number" id="maxMonthlyHours" value="160" min="120" max="200" />
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ã‚·ãƒ•ãƒˆç”Ÿæˆ</h3>
                    <button class="btn btn-success" onclick="generateSchedule()" style="width: 100%; margin-bottom: 15px;">
                        AIã‚·ãƒ•ãƒˆè‡ªå‹•ç”Ÿæˆ
                    </button>
                    <button class="btn btn-primary" onclick="exportToExcel()" style="width: 100%;">
                        Excelå‡ºåŠ›
                    </button>
                </div>
            </div>
            
            <div class="content">
                <div class="section">
                    <h3>ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ•ãƒˆè¡¨</h3>
                    <div id="scheduleResult">
                        <div class="loading">
                            ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¦ã€ŒAIã‚·ãƒ•ãƒˆè‡ªå‹•ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>å‹¤å‹™å¸Œæœ›ãƒ»åˆ¶ç´„</h3>
                    <div class="form-group">
                        <label>ç‰¹åˆ¥ãªå¸Œæœ›ã‚„åˆ¶ç´„äº‹é …</label>
                        <textarea id="specialRequests" rows="4" placeholder="ä¾‹ï¼šç”°ä¸­ã•ã‚“ã¯æ¯é€±æ°´æ›œæ—¥ä¼‘ã¿å¸Œæœ›ã€ä½è—¤ã•ã‚“ã¯æ·±å¤œå‹¤å‹™ä¸å¯ãªã©"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let employees = [];
        let currentSchedule = null;
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç¾åœ¨ã®æœˆã‚’è¨­å®š
            const now = new Date();
            const monthString = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('targetMonth').value = monthString;
            
            // ã‚µãƒ³ãƒ—ãƒ«ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ 
            employees = ['ç”°ä¸­å¤ªéƒ', 'ä½è—¤èŠ±å­', 'å±±ç”°æ¬¡éƒ', 'éˆ´æœ¨ç¾å’²', 'é«˜æ©‹å¥å¤ª'];
            updateEmployeeList();
        });
        
        // ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
        function addEmployee() {
            const nameInput = document.getElementById('employeeName');
            const name = nameInput.value.trim();
            
            if (name && !employees.includes(name)) {
                employees.push(name);
                nameInput.value = '';
                updateEmployeeList();
            }
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆæ›´æ–°
        function updateEmployeeList() {
            const listElement = document.getElementById('employeeList');
            listElement.innerHTML = employees.map(name => `
                <div class="employee-item">
                    <span>${name}</span>
                    <button class="btn btn-danger" onclick="removeEmployee('${name}')">å‰Šé™¤</button>
                </div>
            `).join('');
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤
        function removeEmployee(name) {
            employees = employees.filter(emp => emp !== name);
            updateEmployeeList();
        }
        
        // ã‚·ãƒ•ãƒˆç”Ÿæˆï¼ˆAIã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
        function generateSchedule() {
            if (employees.length === 0) {
                showError('ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            
            const targetMonth = document.getElementById('targetMonth').value;
            if (!targetMonth) {
                showError('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            showLoading();
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
            const constraints = {
                maxConsecutiveDays: parseInt(document.getElementById('maxConsecutiveDays').value),
                minDaysOff: parseInt(document.getElementById('minDaysOff').value),
                nightShiftRest: parseInt(document.getElementById('nightShiftRest').value),
                maxMonthlyHours: parseInt(document.getElementById('maxMonthlyHours').value),
                specialRequests: document.getElementById('specialRequests').value
            };
            
            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå‡¦ç†ï¼ˆå®Ÿéš›ã®AIå‡¦ç†ã®ä»£æ›¿ï¼‰
            setTimeout(() => {
                try {
                    const schedule = generateOptimalSchedule(targetMonth, employees, constraints);
                    currentSchedule = schedule;
                    displaySchedule(schedule);
                    showSuccess('ã‚·ãƒ•ãƒˆãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼');
                } catch (error) {
                    showError('ã‚·ãƒ•ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }, 2000);
        }
        
        // æœ€é©åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        function generateOptimalSchedule(targetMonth, staff, constraints) {
            const [year, month] = targetMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const shifts = ['æ—¥å‹¤', 'æº–å¤œ', 'æ·±å¤œ', 'ä¼‘ã¿'];
            
            // åˆæœŸåŒ–
            const schedule = {};
            staff.forEach(person => {
                schedule[person] = new Array(daysInMonth).fill('ä¼‘ã¿');
            });
            
            // å„æ—¥ã®å¿…è¦äººæ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const dailyNeeds = {
                'æ—¥å‹¤': Math.ceil(staff.length * 0.4),
                'æº–å¤œ': Math.ceil(staff.length * 0.3),
                'æ·±å¤œ': Math.ceil(staff.length * 0.3)
            };
            
            // éºä¼çš„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚‹æœ€é©åŒ–
            for (let generation = 0; generation < 100; generation++) {
                // å„æ—¥ã®ã‚·ãƒ•ãƒˆå‰²ã‚Šå½“ã¦
                for (let day = 0; day < daysInMonth; day++) {
                    assignDailyShifts(schedule, staff, day, dailyNeeds, constraints);
                }
                
                // åˆ¶ç´„é•åã®ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
                fixConstraintViolations(schedule, staff, constraints, daysInMonth);
            }
            
            return {
                year,
                month,
                daysInMonth,
                schedule,
                staff
            };
        }
        
        // æ—¥åˆ¥ã‚·ãƒ•ãƒˆå‰²ã‚Šå½“ã¦
        function assignDailyShifts(schedule, staff, day, dailyNeeds, constraints) {
            const availableStaff = staff.filter(person => {
                // å‰æ—¥ãŒæ·±å¤œå‹¤å‹™ã®å ´åˆã¯ä¼‘æ†©æ™‚é–“ãƒã‚§ãƒƒã‚¯
                if (day > 0 && schedule[person][day - 1] === 'æ·±å¤œ') {
                    return Math.random() < 0.3; // 30%ã®ç¢ºç‡ã§å‹¤å‹™å¯èƒ½
                }
                
                // é€£ç¶šå‹¤å‹™æ—¥æ•°ãƒã‚§ãƒƒã‚¯
                const consecutiveDays = getConsecutiveDays(schedule[person], day);
                if (consecutiveDays >= constraints.maxConsecutiveDays) {
                    return false;
                }
                
                return true;
            });
            
            // ã‚·ãƒ•ãƒˆå‰²ã‚Šå½“ã¦
            const shiftTypes = ['æ—¥å‹¤', 'æº–å¤œ', 'æ·±å¤œ'];
            shiftTypes.forEach(shiftType => {
                const needed = dailyNeeds[shiftType];
                const candidates = availableStaff.filter(person => schedule[person][day] === 'ä¼‘ã¿');
                
                for (let i = 0; i < Math.min(needed, candidates.length); i++) {
                    const randomIndex = Math.floor(Math.random() * candidates.length);
                    const selectedPerson = candidates.splice(randomIndex, 1)[0];
                    schedule[selectedPerson][day] = shiftType;
                }
            });
        }
        
        // é€£ç¶šå‹¤å‹™æ—¥æ•°å–å¾—
        function getConsecutiveDays(personSchedule, currentDay) {
            let count = 0;
            for (let i = currentDay - 1; i >= 0; i--) {
                if (personSchedule[i] !== 'ä¼‘ã¿') {
                    count++;
                } else {
                    break;
                }   
            }
            return count;
        }
        
        // åˆ¶ç´„é•åä¿®æ­£
        function fixConstraintViolations(schedule, staff, constraints, daysInMonth) {
            staff.forEach(person => {
                // æœ€å°ä¼‘æ—¥æ•°ãƒã‚§ãƒƒã‚¯
                const daysOff = schedule[person].filter(shift => shift === 'ä¼‘ã¿').length;
                if (daysOff < constraints.minDaysOff) {
                    // ãƒ©ãƒ³ãƒ€ãƒ ã«å‹¤å‹™æ—¥ã‚’ä¼‘ã¿ã«å¤‰æ›´
                    const workingDays = [];
                    schedule[person].forEach((shift, index) => {
                        if (shift !== 'ä¼‘ã¿') workingDays.push(index);
                    });
                    
                    const needToChange = constraints.minDaysOff - daysOff;
                    for (let i = 0; i < needToChange && workingDays.length > 0; i++) {
                        const randomIndex = Math.floor(Math.random() * workingDays.length);
                        const dayToChange = workingDays.splice(randomIndex, 1)[0];
                        schedule[person][dayToChange] = 'ä¼‘ã¿';
                    }
                }
            });
        }
        
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
        function displaySchedule(scheduleData) {
            const resultElement = document.getElementById('scheduleResult');
            
            let html = '<div class="legend">';
            html += '<div class="legend-item"><div class="legend-color shift-day" style="background: #e3f2fd;"></div><span>æ—¥å‹¤</span></div>';
            html += '<div class="legend-item"><div class="legend-color shift-evening" style="background: #fff3e0;"></div><span>æº–å¤œ</span></div>';
            html += '<div class="legend-item"><div class="legend-color shift-night" style="background: #e8f5e8;"></div><span>æ·±å¤œ</span></div>';
            html += '<div class="legend-item"><div class="legend-color shift-off" style="background: #ffebee;"></div><span>ä¼‘ã¿</span></div>';
            html += '</div>';
            
            html += '<div style="margin-bottom: 10px; color: #666; font-size: 13px; text-align: center;">æ¨ªã«ã‚¹ãƒ©ã‚¤ãƒ‰ã§ãã¾ã™</div>';
            
            html += '<div class="schedule-container">';
            html += '<div class="schedule-grid">';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            html += '<div class="schedule-row">';
            html += '<div class="schedule-cell schedule-header schedule-name">ã‚¹ã‚¿ãƒƒãƒ•å</div>';
            for (let day = 1; day <= scheduleData.daysInMonth; day++) {
                const date = new Date(scheduleData.year, scheduleData.month - 1, day);
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                html += `<div class="schedule-cell schedule-header" style="${isWeekend ? 'background: #ffcc80; color: #e65100;' : ''}">${day}<br><small>${dayOfWeek}</small></div>`;
            }
            html += '</div>';
            
            // ã‚¹ã‚¿ãƒƒãƒ•è¡Œ
            scheduleData.staff.forEach(person => {
                html += '<div class="schedule-row">';
                html += `<div class="schedule-cell schedule-name">${person}</div>`;
                scheduleData.schedule[person].forEach((shift, dayIndex) => {
                    const cellClass = getShiftClass(shift);
                    const displayShift = getShiftDisplay(shift);
                    html += `<div class="schedule-cell ${cellClass}">${displayShift}</div>`;
                });
                html += '</div>';
            });
            
            html += '</div></div>';
            
            // çµ±è¨ˆæƒ…å ±
            html += generateScheduleStats(scheduleData);
            
            resultElement.innerHTML = html;
        }
        
        // ã‚·ãƒ•ãƒˆã‚¯ãƒ©ã‚¹å–å¾—
        function getShiftClass(shift) {
            switch(shift) {
                case 'æ—¥å‹¤': return 'shift-day';
                case 'æº–å¤œ': return 'shift-evening';
                case 'æ·±å¤œ': return 'shift-night';
                case 'ä¼‘ã¿': return 'shift-off';
                default: return '';
            }
        }
        
        // ã‚·ãƒ•ãƒˆè¡¨ç¤ºåå–å¾—ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function getShiftDisplay(shift) {
            switch(shift) {
                case 'æ—¥å‹¤': return 'æ—¥å‹¤';
                case 'æº–å¤œ': return 'æº–å¤œ';
                case 'æ·±å¤œ': return 'æ·±å¤œ';
                case 'ä¼‘ã¿': return 'ä¼‘';
                default: return shift;
            }
        }
        
        // çµ±è¨ˆæƒ…å ±ç”Ÿæˆ
        function generateScheduleStats(scheduleData) {
            let html = '<div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">';
            html += '<h4 style="margin-bottom: 20px; color: #4a90e2; font-size: 1.3em; border-bottom: 2px solid #4a90e2; padding-bottom: 10px;">ğŸ“Š ã‚·ãƒ•ãƒˆçµ±è¨ˆãƒ»å‹¤å‹™ãƒãƒ©ãƒ³ã‚¹</h4>';
            
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            scheduleData.staff.forEach(person => {
                const schedule = scheduleData.schedule[person];
                const stats = {
                    'æ—¥å‹¤': schedule.filter(s => s === 'æ—¥å‹¤').length,
                    'æº–å¤œ': schedule.filter(s => s === 'æº–å¤œ').length,
                    'æ·±å¤œ': schedule.filter(s => s === 'æ·±å¤œ').length,
                    'ä¼‘ã¿': schedule.filter(s => s === 'ä¼‘ã¿').length
                };
                
                const totalWorkDays = stats['æ—¥å‹¤'] + stats['æº–å¤œ'] + stats['æ·±å¤œ'];
                const estimatedHours = stats['æ—¥å‹¤'] * 8 + stats['æº–å¤œ'] * 8 + stats['æ·±å¤œ'] * 8;
                
                // åŠ´åƒåŸºæº–æ³•ãƒã‚§ãƒƒã‚¯
                const isCompliant = estimatedHours <= 160 && stats['ä¼‘ã¿'] >= 8;
                const complianceIcon = isCompliant ? 'âœ…' : 'âš ï¸';
                const complianceColor = isCompliant ? '#28a745' : '#dc3545';
                
                html += `<div style="
                    background: white; 
                    padding: 20px; 
                    border-radius: 10px; 
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    border-left: 5px solid ${complianceColor};
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <strong style="font-size: 1.1em; color: #333;">${person}</strong>
                        <span style="font-size: 1.2em;">${complianceIcon}</span>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>ğŸŒ… æ—¥å‹¤:</span><strong style="color: #1976d2;">${stats['æ—¥å‹¤']}æ—¥</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ğŸŒ† æº–å¤œ:</span><strong style="color: #f57c00;">${stats['æº–å¤œ']}æ—¥</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ğŸŒ™ æ·±å¤œ:</span><strong style="color: #388e3c;">${stats['æ·±å¤œ']}æ—¥</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ğŸ˜´ ä¼‘ã¿:</span><strong style="color: #d32f2f;">${stats['ä¼‘ã¿']}æ—¥</strong>
                        </div>
                    </div>
                    
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
                    
                    <div style="font-size: 0.9em; color: #666;">
                        <div>ç·å‹¤å‹™æ—¥æ•°: <strong>${totalWorkDays}æ—¥</strong></div>
                        <div>äºˆæƒ³åŠ´åƒæ™‚é–“: <strong style="color: ${estimatedHours > 160 ? '#dc3545' : '#28a745'};">${estimatedHours}æ™‚é–“</strong></div>
                        <div style="margin-top: 8px; color: ${complianceColor};">
                            ${isCompliant ? 'åŠ´åƒåŸºæº–æ³•é©åˆ' : 'è¦èª¿æ•´ï¼ˆæ™‚é–“è¶…éã¾ãŸã¯ä¼‘æ—¥ä¸è¶³ï¼‰'}
                        </div>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            
            // å…¨ä½“ã‚µãƒãƒªãƒ¼
            const totalStats = {
                totalStaff: scheduleData.staff.length,
                avgWorkDays: Math.round(scheduleData.staff.reduce((sum, person) => {
                    const schedule = scheduleData.schedule[person];
                    return sum + schedule.filter(s => s !== 'ä¼‘ã¿').length;
                }, 0) / scheduleData.staff.length),
                avgHours: Math.round(scheduleData.staff.reduce((sum, person) => {
                    const schedule = scheduleData.schedule[person];
                    const workDays = schedule.filter(s => s !== 'ä¼‘ã¿').length;
                    return sum + (workDays * 8);
                }, 0) / scheduleData.staff.length)
            };
            
            html += `<div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; border-radius: 10px; text-align: center;">
                <h5 style="margin-bottom: 15px; font-size: 1.2em;">ğŸ“ˆ å…¨ä½“ã‚µãƒãƒªãƒ¼</h5>
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                    <div><strong>ç·ã‚¹ã‚¿ãƒƒãƒ•æ•°:</strong> ${totalStats.totalStaff}å</div>
                    <div><strong>å¹³å‡å‹¤å‹™æ—¥æ•°:</strong> ${totalStats.avgWorkDays}æ—¥/æœˆ</div>
                    <div><strong>å¹³å‡åŠ´åƒæ™‚é–“:</strong> ${totalStats.avgHours}æ™‚é–“/æœˆ</div>
                </div>
            </div>`;
            
            html += '</div>';
            return html;
        }
        
        // Excelå‡ºåŠ›
        function exportToExcel() {
            if (!currentSchedule) {
                showError('ã¾ãšã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                return;
            }
            
            // CSVãƒ‡ãƒ¼ã‚¿ä½œæˆ
            let csvContent = 'ã‚¹ã‚¿ãƒƒãƒ•å';
            for (let day = 1; day <= currentSchedule.daysInMonth; day++) {
                csvContent += `,${day}æ—¥`;
            }
            csvContent += '\n';
            
            currentSchedule.staff.forEach(person => {
                csvContent += person;
                currentSchedule.schedule[person].forEach(shift => {
                    csvContent += `,${shift}`;
                });
                csvContent += '\n';
            });
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ã‚·ãƒ•ãƒˆè¡¨_${currentSchedule.year}å¹´${currentSchedule.month}æœˆ.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('Excelï¼ˆCSVï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ');
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showLoading() {
            document.getElementById('scheduleResult').innerHTML = '<div class="loading">AIãŒã‚·ãƒ•ãƒˆã‚’æœ€é©åŒ–ä¸­ã§ã™...</div>';
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => document.body.removeChild(errorDiv), 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => document.body.removeChild(successDiv), 5000);
        }
        
        // Enterã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
        document.getElementById('employeeName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addEmployee();
            }
        });
    </script>
</body>
</html>
