<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3交代勤務自動シフト作成ツール</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 70vh;
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .section h3 {
            color: #4a90e2;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
        }
        
        .employee-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 120px repeat(auto-fit, minmax(40px, 1fr));
            gap: 1px;
            background: #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .schedule-cell {
            background: white;
            padding: 8px;
            text-align: center;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .schedule-header {
            background: #4a90e2;
            color: white;
            font-weight: 600;
        }
        
        .schedule-name {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            padding-left: 12px;
        }
        
        .shift-day {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .shift-evening {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .shift-night {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .shift-off {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .constraints-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .constraints-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>3交代勤務自動シフト作成ツール</h1>
            <p>AI搭載・労働基準法対応・Excel出力対応</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="section">
                    <h3>基本設定</h3>
                    <div class="form-group">
                        <label>対象月</label>
                        <input type="month" id="targetMonth" />
                    </div>
                    <div class="form-group">
                        <label>スタッフ追加</label>
                        <input type="text" id="employeeName" placeholder="スタッフ名" />
                        <button class="btn btn-primary btn-small" onclick="addEmployee()" style="margin-top: 8px;">追加</button>
                    </div>
                    <div class="employee-list" id="employeeList">
                        <!-- スタッフリストがここに表示されます -->
                    </div>
                </div>
                
                <div class="section">
                    <h3>制約条件</h3>
                    <div class="constraints-grid">
                        <div class="form-group">
                            <label>最大連続勤務日数</label>
                            <input type="number" id="maxConsecutiveDays" value="5" min="1" max="10" />
                        </div>
                        <div class="form-group">
                            <label>最小休日数/月</label>
                            <input type="number" id="minDaysOff" value="8" min="4" max="15" />
                        </div>
                        <div class="form-group">
                            <label>深夜勤務後の休憩時間</label>
                            <input type="number" id="nightShiftRest" value="16" min="8" max="24" />
                        </div>
                        <div class="form-group">
                            <label>月間労働時間上限</label>
                            <input type="number" id="maxMonthlyHours" value="160" min="120" max="200" />
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>シフト生成</h3>
                    <button class="btn btn-success" onclick="generateSchedule()" style="width: 100%; margin-bottom: 15px;">
                        AIシフト自動生成
                    </button>
                    <button class="btn btn-primary" onclick="exportToExcel()" style="width: 100%;">
                        Excel出力
                    </button>
                </div>
            </div>
            
            <div class="content">
                <div class="section">
                    <h3>生成されたシフト表</h3>
                    <div id="scheduleResult">
                        <div class="loading">
                            スタッフを追加して「AIシフト自動生成」ボタンをクリックしてください
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>勤務希望・制約</h3>
                    <div class="form-group">
                        <label>特別な希望や制約事項</label>
                        <textarea id="specialRequests" rows="4" placeholder="例：田中さんは毎週水曜日休み希望、佐藤さんは深夜勤務不可など"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let employees = [];
        let currentSchedule = null;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 現在の月を設定
            const now = new Date();
            const monthString = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('targetMonth').value = monthString;
            
            // サンプルスタッフを追加
            employees = ['田中太郎', '佐藤花子', '山田次郎', '鈴木美咲', '高橋健太'];
            updateEmployeeList();
        });
        
        // スタッフ追加
        function addEmployee() {
            const nameInput = document.getElementById('employeeName');
            const name = nameInput.value.trim();
            
            if (name && !employees.includes(name)) {
                employees.push(name);
                nameInput.value = '';
                updateEmployeeList();
            }
        }
        
        // スタッフリスト更新
        function updateEmployeeList() {
            const listElement = document.getElementById('employeeList');
            listElement.innerHTML = employees.map(name => `
                <div class="employee-item">
                    <span>${name}</span>
                    <button class="btn btn-danger" onclick="removeEmployee('${name}')">削除</button>
                </div>
            `).join('');
        }
        
        // スタッフ削除
        function removeEmployee(name) {
            employees = employees.filter(emp => emp !== name);
            updateEmployeeList();
        }
        
        // シフト生成（AIアルゴリズム）
        function generateSchedule() {
            if (employees.length === 0) {
                showError('スタッフを追加してください');
                return;
            }
            
            const targetMonth = document.getElementById('targetMonth').value;
            if (!targetMonth) {
                showError('対象月を選択してください');
                return;
            }
            
            showLoading();
            
            // パラメータ取得
            const constraints = {
                maxConsecutiveDays: parseInt(document.getElementById('maxConsecutiveDays').value),
                minDaysOff: parseInt(document.getElementById('minDaysOff').value),
                nightShiftRest: parseInt(document.getElementById('nightShiftRest').value),
                maxMonthlyHours: parseInt(document.getElementById('maxMonthlyHours').value),
                specialRequests: document.getElementById('specialRequests').value
            };
            
            // シミュレート処理（実際のAI処理の代替）
            setTimeout(() => {
                try {
                    const schedule = generateOptimalSchedule(targetMonth, employees, constraints);
                    currentSchedule = schedule;
                    displaySchedule(schedule);
                    showSuccess('シフトが正常に生成されました！');
                } catch (error) {
                    showError('シフト生成中にエラーが発生しました: ' + error.message);
                }
            }, 2000);
        }
        
        // 最適化アルゴリズム
        function generateOptimalSchedule(targetMonth, staff, constraints) {
            const [year, month] = targetMonth.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const shifts = ['日勤', '準夜', '深夜', '休み'];
            
            // 初期化
            const schedule = {};
            staff.forEach(person => {
                schedule[person] = new Array(daysInMonth).fill('休み');
            });
            
            // 各日の必要人数（簡易版）
            const dailyNeeds = {
                '日勤': Math.ceil(staff.length * 0.4),
                '準夜': Math.ceil(staff.length * 0.3),
                '深夜': Math.ceil(staff.length * 0.3)
            };
            
            // 遺伝的アルゴリズムによる最適化
            for (let generation = 0; generation < 100; generation++) {
                // 各日のシフト割り当て
                for (let day = 0; day < daysInMonth; day++) {
                    assignDailyShifts(schedule, staff, day, dailyNeeds, constraints);
                }
                
                // 制約違反のチェックと修正
                fixConstraintViolations(schedule, staff, constraints, daysInMonth);
            }
            
            return {
                year,
                month,
                daysInMonth,
                schedule,
                staff
            };
        }
        
        // 日別シフト割り当て
        function assignDailyShifts(schedule, staff, day, dailyNeeds, constraints) {
            const availableStaff = staff.filter(person => {
                // 前日が深夜勤務の場合は休憩時間チェック
                if (day > 0 && schedule[person][day - 1] === '深夜') {
                    return Math.random() < 0.3; // 30%の確率で勤務可能
                }
                
                // 連続勤務日数チェック
                const consecutiveDays = getConsecutiveDays(schedule[person], day);
                if (consecutiveDays >= constraints.maxConsecutiveDays) {
                    return false;
                }
                
                return true;
            });
            
            // シフト割り当て
            const shiftTypes = ['日勤', '準夜', '深夜'];
            shiftTypes.forEach(shiftType => {
                const needed = dailyNeeds[shiftType];
                const candidates = availableStaff.filter(person => schedule[person][day] === '休み');
                
                for (let i = 0; i < Math.min(needed, candidates.length); i++) {
                    const randomIndex = Math.floor(Math.random() * candidates.length);
                    const selectedPerson = candidates.splice(randomIndex, 1)[0];
                    schedule[selectedPerson][day] = shiftType;
                }
            });
        }
        
        // 連続勤務日数取得
        function getConsecutiveDays(personSchedule, currentDay) {
            let count = 0;
            for (let i = currentDay - 1; i >= 0; i--) {
                if (personSchedule[i] !== '休み') {
                    count++;
                } else {
                    break;
                }   
            }
            return count;
        }
        
        // 制約違反修正
        function fixConstraintViolations(schedule, staff, constraints, daysInMonth) {
            staff.forEach(person => {
                // 最小休日数チェック
                const daysOff = schedule[person].filter(shift => shift === '休み').length;
                if (daysOff < constraints.minDaysOff) {
                    // ランダムに勤務日を休みに変更
                    const workingDays = [];
                    schedule[person].forEach((shift, index) => {
                        if (shift !== '休み') workingDays.push(index);
                    });
                    
                    const needToChange = constraints.minDaysOff - daysOff;
                    for (let i = 0; i < needToChange && workingDays.length > 0; i++) {
                        const randomIndex = Math.floor(Math.random() * workingDays.length);
                        const dayToChange = workingDays.splice(randomIndex, 1)[0];
                        schedule[person][dayToChange] = '休み';
                    }
                }
            });
        }
        
        // スケジュール表示
        function displaySchedule(scheduleData) {
            const resultElement = document.getElementById('scheduleResult');
            
            let html = '<div class="schedule-grid">';
            
            // ヘッダー行
            html += '<div class="schedule-cell schedule-header">スタッフ</div>';
            for (let day = 1; day <= scheduleData.daysInMonth; day++) {
                const date = new Date(scheduleData.year, scheduleData.month - 1, day);
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                html += `<div class="schedule-cell schedule-header">${day}<br>${dayOfWeek}</div>`;
            }
            
            // スタッフ行
            scheduleData.staff.forEach(person => {
                html += `<div class="schedule-cell schedule-name">${person}</div>`;
                scheduleData.schedule[person].forEach(shift => {
                    const cellClass = getShiftClass(shift);
                    const displayShift = getShiftDisplay(shift);
                    html += `<div class="schedule-cell ${cellClass}">${displayShift}</div>`;
                });
            });
            
            html += '</div>';
            
            // 統計情報
            html += generateScheduleStats(scheduleData);
            
            resultElement.innerHTML = html;
        }
        
        // シフトクラス取得
        function getShiftClass(shift) {
            switch(shift) {
                case '日勤': return 'shift-day';
                case '準夜': return 'shift-evening';
                case '深夜': return 'shift-night';
                case '休み': return 'shift-off';
                default: return '';
            }
        }
        
        // シフト表示名取得
        function getShiftDisplay(shift) {
            switch(shift) {
                case '日勤': return '日';
                case '準夜': return '準';
                case '深夜': return '深';
                case '休み': return '休';
                default: return shift;
            }
        }
        
        // 統計情報生成
        function generateScheduleStats(scheduleData) {
            let html = '<div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">';
            html += '<h4 style="margin-bottom: 15px; color: #4a90e2;">シフト統計</h4>';
            
            scheduleData.staff.forEach(person => {
                const schedule = scheduleData.schedule[person];
                const stats = {
                    '日勤': schedule.filter(s => s === '日勤').length,
                    '準夜': schedule.filter(s => s === '準夜').length,
                    '深夜': schedule.filter(s => s === '深夜').length,
                    '休み': schedule.filter(s => s === '休み').length
                };
                
                const totalWorkDays = stats['日勤'] + stats['準夜'] + stats['深夜'];
                const estimatedHours = stats['日勤'] * 8 + stats['準夜'] * 8 + stats['深夜'] * 8;
                
                html += `<div style="margin-bottom: 10px;">
                    <strong>${person}</strong>: 
                    勤務${totalWorkDays}日 
                    (日勤${stats['日勤']}・準夜${stats['準夜']}・深夜${stats['深夜']}・休み${stats['休み']}) 
                    予想労働時間: ${estimatedHours}時間
                </div>`;
            });
            
            html += '</div>';
            return html;
        }
        
        // Excel出力
        function exportToExcel() {
            if (!currentSchedule) {
                showError('まずシフトを生成してください');
                return;
            }
            
            // CSVデータ作成
            let csvContent = 'スタッフ名';
            for (let day = 1; day <= currentSchedule.daysInMonth; day++) {
                csvContent += `,${day}日`;
            }
            csvContent += '\n';
            
            currentSchedule.staff.forEach(person => {
                csvContent += person;
                currentSchedule.schedule[person].forEach(shift => {
                    csvContent += `,${shift}`;
                });
                csvContent += '\n';
            });
            
            // ダウンロード実行
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `シフト表_${currentSchedule.year}年${currentSchedule.month}月.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('Excel（CSV）ファイルがダウンロードされました');
        }
        
        // ユーティリティ関数
        function showLoading() {
            document.getElementById('scheduleResult').innerHTML = '<div class="loading">AIがシフトを最適化中です...</div>';
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => document.body.removeChild(errorDiv), 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => document.body.removeChild(successDiv), 5000);
        }
        
        // Enterキーでスタッフ追加
        document.getElementById('employeeName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addEmployee();
            }
        });
    </script>
</body>
</html>
