<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVçµ±åˆå¤‰æ›ã‚·ã‚¹ãƒ†ãƒ  - ãƒ¤ãƒãƒˆé‹è¼¸ãƒ‡ãƒ¼ã‚¿ä½œæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .file-group {
            margin-bottom: 20px;
        }

        .file-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #f7fafc;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-family: inherit;
        }

        .file-input:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-input.has-file {
            border-color: #48bb78;
            background: #f0fff4;
            border-style: solid;
        }

        .file-status {
            font-size: 12px;
            margin-top: 4px;
            color: #718096;
        }

        .file-status.success {
            color: #48bb78;
        }

        .convert-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .convert-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .convert-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            color: #4a5568;
            font-size: 14px;
        }

        .result-section {
            display: none;
        }

        .success-message {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .error-message {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #742a2a;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .download-button {
            width: 100%;
            padding: 12px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .download-button:hover {
            background: #38a169;
        }

        .reset-button {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .reset-button:hover {
            background: #f7fafc;
        }

        .info-section {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-title {
            font-weight: 600;
            color: #2b6cb0;
            margin-bottom: 8px;
        }

        .info-list {
            color: #2c5282;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-list li {
            margin-bottom: 4px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-box {
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .required-label {
            color: #e53e3e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CSVçµ±åˆå¤‰æ›ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>Amazonãƒ»æ¥½å¤©ãƒ»Yahoo ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¤ãƒãƒˆé‹è¼¸ç”¨ã«å¤‰æ›</p>
        </div>

        <div class="upload-section">
            <div class="file-group">
                <label class="file-label">å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« <span class="required-label">*å¿…é ˆ</span></label>
                <input type="file" id="masterFile" class="file-input" accept=".xlsx,.xlsm,.xls">
                <div class="file-status" id="masterStatus">å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">Amazonãƒ‡ãƒ¼ã‚¿ (TSVå½¢å¼)</label>
                <input type="file" id="amazonFile" class="file-input" accept=".txt,.tsv,.csv">
                <div class="file-status" id="amazonStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</label>
                <input type="file" id="rakutenFile" class="file-input" accept=".csv">
                <div class="file-status" id="rakutenStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>

            <div class="file-group">
                <label class="file-label">Yahooãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</label>
                <input type="file" id="yahooFile" class="file-input" accept=".csv">
                <div class="file-status" id="yahooStatus">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
        </div>

        <button class="convert-button" id="convertButton" disabled>
            ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡¦ç†ä¸­...</div>
        </div>

        <div class="result-section" id="resultSection">
            <div id="messageArea"></div>
            <button class="download-button" id="downloadButton" style="display: none;">
                ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
            <button class="reset-button" id="resetButton">
                æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
            </button>
        </div>

        <div class="info-section">
            <div class="info-title">ä½¿ç”¨æ–¹æ³•</div>
            <ul class="info-list">
                <li>1. å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠ</li>
                <li>2. å„ECã‚µã‚¤ãƒˆã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</li>
                <li>3. ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>4. å¤‰æ›å®Œäº†å¾Œã€ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                <li>â€» ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼šAmazon(TSV)ã€æ¥½å¤©ãƒ»Yahoo(CSV)</li>
                <li>â€» åŒä¸€é…é€å…ˆã¯è‡ªå‹•çµ±åˆã•ã‚Œã¾ã™</li>
                <li>â€» é‡é‡ã¯å•†å“ãƒã‚¹ã‚¿ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™</li>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let productMaster = {};
        let selectedFiles = {
            master: null,
            amazon: null,
            rakuten: null,
            yahoo: null
        };

        // DOMè¦ç´ 
        const masterFile = document.getElementById('masterFile');
        const amazonFile = document.getElementById('amazonFile');
        const rakutenFile = document.getElementById('rakutenFile');
        const yahooFile = document.getElementById('yahooFile');
        const convertButton = document.getElementById('convertButton');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultSection = document.getElementById('resultSection');
        const messageArea = document.getElementById('messageArea');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        masterFile.addEventListener('change', (e) => handleFileSelect(e, 'master', 'masterStatus'));
        amazonFile.addEventListener('change', (e) => handleFileSelect(e, 'amazon', 'amazonStatus'));
        rakutenFile.addEventListener('change', (e) => handleFileSelect(e, 'rakuten', 'rakutenStatus'));
        yahooFile.addEventListener('change', (e) => handleFileSelect(e, 'yahoo', 'yahooStatus'));

        function handleFileSelect(event, type, statusId) {
            const file = event.target.files[0];
            const statusElement = document.getElementById(statusId);
            const inputElement = event.target;

            console.log(`File selected for ${type}:`, file ? file.name : 'none');

            if (file) {
                selectedFiles[type] = file;
                statusElement.textContent = `é¸æŠæ¸ˆã¿: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`;
                statusElement.className = 'file-status success';
                inputElement.classList.add('has-file');
                
                // å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯å³åº§ã«èª­ã¿è¾¼ã¿
                if (type === 'master') {
                    loadProductMaster(file);
                }
            } else {
                selectedFiles[type] = null;
                statusElement.textContent = type === 'master' ? 
                    'å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„' : 
                    'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
                statusElement.className = 'file-status';
                inputElement.classList.remove('has-file');
                
                if (type === 'master') {
                    productMaster = {};
                }
            }

            updateConvertButton();
        }

        async function loadProductMaster(file) {
            try {
                console.log('Loading product master...');
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                console.log('Workbook sheets:', workbook.SheetNames);
                
                let masterSheet = null;
                // å•†å“ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‚’æ¢ã™
                for (const sheetName of workbook.SheetNames) {
                    if (sheetName.includes('å•†å“ãƒã‚¹ã‚¿') || sheetName.includes('master') || sheetName.includes('Master')) {
                        masterSheet = workbook.Sheets[sheetName];
                        console.log('Found master sheet:', sheetName);
                        break;
                    }
                }
                
                // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨
                if (!masterSheet && workbook.SheetNames.length > 0) {
                    masterSheet = workbook.Sheets[workbook.SheetNames[0]];
                    console.log('Using first sheet:', workbook.SheetNames[0]);
                }
                
                if (!masterSheet) {
                    throw new Error('å•†å“ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ã‚·ãƒ¼ãƒˆã‚’JSONã«å¤‰æ›
                const jsonData = XLSX.utils.sheet_to_json(masterSheet, { 
                    header: 1,
                    defval: '',
                    blankrows: false
                });
                
                console.log('Master data rows:', jsonData.length);
                console.log('Headers:', jsonData[0]);
                
                // å•†å“ãƒã‚¹ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ï¼ˆè¤‡æ•°ã‚«ãƒ©ãƒ ã‚»ãƒƒãƒˆå¯¾å¿œï¼‰
                productMaster = {};
                let loadedCount = 0;
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length >= 3 && row[0] && row[2] && row[0] !== 'FBA') { // è²©å£²ã‚µã‚¤ãƒˆã€å•†å“Noæœ€ä½é™å¿…è¦ã€FBAé™¤å¤–
                        const site = String(row[0]).trim();
                        const detail = String(row[1] || '').trim();
                        const productNo = String(row[2]).trim();
                        
                        // è¤‡æ•°ã‚«ãƒ©ãƒ ã‚»ãƒƒãƒˆã‚’å‡¦ç†ï¼ˆD-F, G-I, J-L, M-O, P-Rï¼‰
                        const colorSets = [];
                        const columnGroups = [
                            [3, 4, 5],   // D, E, F
                            [6, 7, 8],   // G, H, I  
                            [9, 10, 11], // J, K, L
                            [12, 13, 14], // M, N, O
                            [15, 16, 17]  // P, Q, R
                        ];
                        
                        columnGroups.forEach(([weightCol, quantityCol, colorCol]) => {
                            const weight = parseFloat(row[weightCol]) || 0;
                            const quantity = parseInt(row[quantityCol]) || 0;
                            const color = String(row[colorCol] || '').trim();
                            
                            if (weight > 0 && quantity > 0 && color) {
                                colorSets.push({
                                    weight: weight,
                                    quantity: quantity,
                                    color: color
                                });
                            }
                        });
                        
                        // å°‘ãªãã¨ã‚‚1ã¤ã®ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆãŒã‚ã‚‹å ´åˆã®ã¿ç™»éŒ²
                        if (colorSets.length > 0) {
                            productMaster[productNo] = {
                                site: site,
                                detail: detail,
                                colorSets: colorSets
                            };
                            loadedCount++;
                        }
                    }
                }
                
                console.log(`Product master loaded: ${loadedCount} products`);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                const masterStatus = document.getElementById('masterStatus');
                masterStatus.textContent = `âœ… å•†å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${loadedCount}ä»¶`;
                masterStatus.className = 'file-status success';
                
            } catch (error) {
                console.error('å•†å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const masterStatus = document.getElementById('masterStatus');
                masterStatus.textContent = `âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                masterStatus.className = 'file-status';
                masterStatus.style.color = '#e53e3e';
                productMaster = {};
            }
        }

        function updateConvertButton() {
            // å•†å“ãƒã‚¹ã‚¿ã¯å¿…é ˆã€ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å°‘ãªãã¨ã‚‚1ã¤ã¯å¿…è¦
            const hasMaster = selectedFiles.master && Object.keys(productMaster).length > 0;
            const hasData = selectedFiles.amazon || selectedFiles.rakuten || selectedFiles.yahoo;
            
            convertButton.disabled = !hasMaster || !hasData;
            
            console.log('Button update:', { hasMaster, hasData, disabled: convertButton.disabled });
        }

        // å¤‰æ›å‡¦ç†
        convertButton.addEventListener('click', async () => {
            try {
                showProgress();
                updateProgress(10, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

                const results = [];
                
                // Amazonãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.amazon) {
                    updateProgress(25, 'Amazonãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const amazonData = await readFileWithEncoding(selectedFiles.amazon);
                    const amazonOrders = await processAmazonData(amazonData);
                    results.push(...amazonOrders);
                }

                // æ¥½å¤©ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.rakuten) {
                    updateProgress(45, 'æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const rakutenData = await readFileWithEncoding(selectedFiles.rakuten);
                    const rakutenOrders = await processRakutenData(rakutenData);
                    results.push(...rakutenOrders);
                }

                // Yahooãƒ‡ãƒ¼ã‚¿å‡¦ç†
                if (selectedFiles.yahoo) {
                    updateProgress(65, 'Yahooãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
                    const yahooData = await readFileWithEncoding(selectedFiles.yahoo);
                    const yahooOrders = await processYahooData(yahooData);
                    results.push(...yahooOrders);
                }

                // ãƒ‡ãƒ¼ã‚¿çµ±åˆ
                updateProgress(80, 'ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆä¸­...');
                const mergedOrders = mergeOrdersByRecipient(results);
                
                updateProgress(90, 'CSVç”Ÿæˆä¸­...');
                const csvContent = generateYamatoCSV(mergedOrders);
                
                updateProgress(100, 'å¤‰æ›å®Œäº†!');
                
                setTimeout(() => {
                    showResult(csvContent, {
                        original: results.length,
                        merged: mergedOrders.length,
                        amazon: results.filter(r => r.source === 'Amazon').length,
                        rakuten: results.filter(r => r.source === 'æ¥½å¤©').length,
                        yahoo: results.filter(r => r.source === 'Yahoo').length,
                        unknownProducts: []
                    });
                }, 500);

            } catch (error) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                showError(error.message);
            }
        });

        async function readFileWithEncoding(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const buffer = new Uint8Array(e.target.result);
                        
                        // UTF-8ã§è©¦è¡Œ
                        let result;
                        try {
                            result = new TextDecoder('utf-8', { fatal: true }).decode(buffer);
                        } catch {
                            // Shift-JISã§è©¦è¡Œ
                            try {
                                result = new TextDecoder('shift-jis', { fatal: false }).decode(buffer);
                            } catch {
                                // æœ€å¾Œã®æ‰‹æ®µï¼šéå³å¯†ãªUTF-8
                                result = new TextDecoder('utf-8', { fatal: false }).decode(buffer);
                            }
                        }
                        
                        resolve(result);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function processAmazonData(amazonData) {
            const orders = [];
            const lines = amazonData.split('\n').filter(line => line.trim());
            
            if (lines.length <= 1) return orders;
            
            const headers = lines[0].split('\t');
            console.log('Amazon headers count:', headers.length);
            
            for (let i = 1; i < lines.length; i++) {
                const fields = lines[i].split('\t');
                if (fields.length < 20) continue; // æœ€ä½é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ãƒã‚§ãƒƒã‚¯
                
                try {
                    const sku = fields[11]?.trim();
                    const productName = fields[13]?.trim();
                    const quantity = parseInt(fields[14]) || 1;
                    const recipientName = fields[19]?.trim();
                    
                    // Amazonä½æ‰€ã®å®Œå…¨ãªçµåˆ: ship-state + ship-address-1 + ship-address-2 + ship-address-3
                    const shipState = fields[24]?.trim() || '';
                    const shipAddress1 = fields[20]?.trim() || '';
                    const shipAddress2 = fields[21]?.trim() || '';
                    const shipAddress3 = fields[22]?.trim() || '';
                    const shipAddress = [shipState, shipAddress1, shipAddress2, shipAddress3]
                        .filter(addr => addr && addr.trim())
                        .join('');
                    
                    const zipCode = fields[25]?.trim();
                    const phoneNumber = fields[10]?.trim();
                    const orderId = fields[0]?.trim();
                    const orderItemId = fields[1]?.trim();

                    if (!recipientName || !shipAddress || !zipCode || !phoneNumber) continue;

                    // å•†å“ãƒã‚¹ã‚¿ã‹ã‚‰é‡é‡æƒ…å ±å–å¾—ï¼ˆè¤‡æ•°ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆå¯¾å¿œï¼‰
                    const masterInfo = productMaster[sku];
                    let weight = 50 * quantity; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡é‡Ã—æ³¨æ–‡æ•°
                    let productDetail = productName;

                    if (masterInfo && masterInfo.colorSets) {
                        // ç·é‡é‡è¨ˆç®—: å„ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆã®(é‡ã•Ã—å€‹æ•°)ã‚’åˆè¨ˆã—ã¦ã‹ã‚‰æ³¨æ–‡æ•°ã‚’æ›ã‘ã‚‹
                        let unitTotalWeight = 0;
                        const detailParts = [];
                        
                        masterInfo.colorSets.forEach(set => {
                            unitTotalWeight += set.weight * set.quantity;
                            detailParts.push(`${set.color}: ${set.weight}gÃ—${set.quantity}`);
                        });
                        
                        weight = unitTotalWeight * quantity;
                        productDetail = detailParts.join(', ');
                    } else {
                        // å•†å“åã‹ã‚‰é‡é‡ã‚’æ¨å®š
                        const weightMatch = productName?.match(/(\d+)g/);
                        if (weightMatch) {
                            weight = parseInt(weightMatch[1]) * quantity;
                        }
                    }

                    orders.push({
                        source: 'Amazon',
                        sku: sku,
                        productName: productDetail,
                        quantity: quantity,
                        recipientName: recipientName,
                        shipAddress: shipAddress,
                        zipCode: formatZipCode(zipCode),
                        phoneNumber: formatPhoneNumber(phoneNumber),
                        weight: weight,
                        orderId: `${orderId}:${orderItemId}:${quantity}`
                    });
                } catch (error) {
                    console.error(`Amazon row ${i} error:`, error);
                }
            }
            
            console.log('Amazon orders processed:', orders.length);
            return orders;
        }

        async function processRakutenData(rakutenData) {
            const orders = [];
            
            const parsed = Papa.parse(rakutenData, { 
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
            });
            
            if (!parsed.data || parsed.data.length === 0) return orders;
            
            console.log('Rakuten headers:', Object.keys(parsed.data[0]));
            
            parsed.data.forEach((row, index) => {
                try {
                    const orderId = row['æ³¨æ–‡ç•ªå·']?.trim();
                    const itemId = row['å•†å“ç®¡ç†ç•ªå·']?.trim();
                    const itemName = row['å•†å“å']?.trim();
                    const quantity = parseInt(row['å€‹æ•°']) || 1;
                    
                    const shipLastName = row['é€ä»˜å…ˆå§“']?.trim() || '';
                    const shipFirstName = row['é€ä»˜å…ˆå']?.trim() || '';
                    const shipName = `${shipLastName} ${shipFirstName}`.trim();
                    
                    const shipPhone1 = row['é€ä»˜å…ˆé›»è©±ç•ªå·1']?.trim() || '';
                    const shipPhone2 = row['é€ä»˜å…ˆé›»è©±ç•ªå·2']?.trim() || '';
                    const shipPhone3 = row['é€ä»˜å…ˆé›»è©±ç•ªå·3']?.trim() || '';
                    const phoneNumber = formatPhoneNumber(`${shipPhone1}-${shipPhone2}-${shipPhone3}`);
                    
                    const shipZip1 = row['é€ä»˜å…ˆéƒµä¾¿ç•ªå·1']?.toString().trim() || '';
                    const shipZip2 = row['é€ä»˜å…ˆéƒµä¾¿ç•ªå·2']?.toString().trim() || '';
                    
                    // æ¥½å¤©éƒµä¾¿ç•ªå·: AJåˆ—ã‚’3æ¡ã€AKåˆ—ã‚’4æ¡ã«0åŸ‹ã‚
                    const paddedZip1 = shipZip1.padStart(3, '0');
                    const paddedZip2 = shipZip2.padStart(4, '0');
                    const zipCode = formatZipCode(`${paddedZip1}${paddedZip2}`);
                    
                    const shipPref = row['é€ä»˜å…ˆä½æ‰€éƒ½é“åºœçœŒ']?.trim() || '';
                    const shipCity = row['é€ä»˜å…ˆä½æ‰€éƒ¡å¸‚åŒº']?.trim() || '';
                    const shipAddr = row['é€ä»˜å…ˆä½æ‰€ãã‚Œä»¥é™ã®ä½æ‰€']?.trim() || '';
                    const shipApart = row['é€ä»˜å…ˆä½æ‰€ã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å']?.trim() || '';
                    
                    // æ¥½å¤©ä½æ‰€ã®å®Œå…¨ãªçµåˆ
                    const fullAddress = [shipPref, shipCity, shipAddr, shipApart]
                        .filter(addr => addr && addr.trim())
                        .join('');

                    if (!shipName || !fullAddress || !zipCode || !phoneNumber || !orderId) return;

                    // å•†å“ãƒã‚¹ã‚¿ã‹ã‚‰é‡é‡å–å¾—ï¼ˆè¤‡æ•°ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆå¯¾å¿œï¼‰
                    const masterInfo = productMaster[itemId];
                    let weight = 50 * quantity; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡é‡Ã—æ³¨æ–‡æ•°
                    let productDetail = itemName;

                    if (masterInfo && masterInfo.colorSets) {
                        // ç·é‡é‡è¨ˆç®—: å„ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆã®(é‡ã•Ã—å€‹æ•°)ã‚’åˆè¨ˆã—ã¦ã‹ã‚‰æ³¨æ–‡æ•°ã‚’æ›ã‘ã‚‹
                        let unitTotalWeight = 0;
                        const detailParts = [];
                        
                        masterInfo.colorSets.forEach(set => {
                            unitTotalWeight += set.weight * set.quantity;
                            detailParts.push(`${set.color}: ${set.weight}gÃ—${set.quantity}`);
                        });
                        
                        weight = unitTotalWeight * quantity;
                        productDetail = detailParts.join(', ');
                    } else {
                        const weightMatch = itemName?.match(/(\d+)g/);
                        if (weightMatch) {
                            weight = parseInt(weightMatch[1]) * quantity;
                        }
                    }

                    orders.push({
                        source: 'æ¥½å¤©',
                        sku: itemId,
                        productName: productDetail,
                        quantity: quantity,
                        recipientName: shipName,
                        shipAddress: fullAddress,
                        zipCode: zipCode,
                        phoneNumber: phoneNumber,
                        weight: weight,
                        orderId: orderId
                    });
                } catch (error) {
                    console.error(`Rakuten row ${index} error:`, error);
                }
            });
            
            console.log('Rakuten orders processed:', orders.length);
            return orders;
        }

        async function processYahooData(yahooData) {
            const orders = [];
            
            const parsed = Papa.parse(yahooData, { 
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
            });
            
            if (!parsed.data || parsed.data.length === 0) return orders;
            
            console.log('Yahoo headers:', Object.keys(parsed.data[0]));
            
            parsed.data.forEach((row, index) => {
                try {
                    const orderId = row['OrderId']?.trim();
                    let itemId = row['ItemId']?.trim();
                    const title = row['Title']?.trim();
                    const quantityDetail = row['QuantityDetail']?.trim();
                    const shipName = row['ShipName']?.trim();
                    const shipAddress1 = row['ShipAddress1']?.trim() || '';
                    const shipAddress2 = row['ShipAddress2']?.trim() || '';
                    const shipCity = row['ShipCity']?.trim() || '';
                    const shipPrefecture = row['ShipPrefecture']?.trim() || '';
                    const shipAddressFull = row['ShipAddressFull']?.trim() || '';
                    
                    // Yahooä½æ‰€: ShipAddressFullã‚’å„ªå…ˆã€ãªã‘ã‚Œã°å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’çµåˆ
                    const shipAddress = shipAddressFull || 
                        [shipPrefecture, shipCity, shipAddress1, shipAddress2]
                            .filter(addr => addr && addr.trim())
                            .join('');
                    
                    const shipZip = row['ShipZipCode']?.toString().trim();
                    const shipPhone = formatPhoneNumber(row['ShipPhoneNumber']?.toString().trim());

                    if (!shipName || !shipAddress || !shipZip || !shipPhone || !orderId) return;

                    // Yahooå•†å“IDã®å‡¦ç†
                    let totalWeight = 0;
                    let productDetails = [];
                    let totalQuantity = 0;

                    if (itemId?.includes('&')) {
                        // è¤‡æ•°å•†å“ã®å ´åˆï¼ˆä¾‹: L1=bara60&L2=bara80ï¼‰
                        const items = itemId.split('&');
                        items.forEach(item => {
                            // L1=bara60 -> bara60 ã‚’æŠ½å‡º
                            let cleanItemCode = '';
                            if (item.includes('=')) {
                                cleanItemCode = item.split('=')[1]; // = ã‚ˆã‚Šå¾Œã‚ã‚’å–å¾—
                            } else {
                                cleanItemCode = item.trim();
                            }
                            
                            console.log(`Yahoo multiple item: ${item} -> ${cleanItemCode}`);
                            
                            // QuantityDetailã‹ã‚‰è©²å½“å•†å“ã®æ•°é‡ã‚’å–å¾—ï¼ˆä¾‹: bara60:2,bara80:1ï¼‰
                            let quantity = 1;
                            if (quantityDetail) {
                                const quantityMatch = quantityDetail.match(new RegExp(`${cleanItemCode}:(\\d+)`));
                                quantity = quantityMatch ? parseInt(quantityMatch[1]) : 1;
                            }
                            
                            const masterInfo = productMaster[cleanItemCode];
                            console.log(`Searching for ${cleanItemCode}:`, masterInfo);
                            
                            if (masterInfo && masterInfo.colorSets) {
                                // è¤‡æ•°ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆå¯¾å¿œ
                                let itemUnitWeight = 0;
                                const itemDetailParts = [];
                                
                                masterInfo.colorSets.forEach(set => {
                                    itemUnitWeight += set.weight * set.quantity;
                                    itemDetailParts.push(`${set.color}: ${set.weight}gÃ—${set.quantity}`);
                                });
                                
                                const itemTotalWeight = itemUnitWeight * quantity;
                                totalWeight += itemTotalWeight;
                                productDetails.push(itemDetailParts.join(', '));
                                totalQuantity += quantity;
                            } else {
                                console.log(`Product not found in master: ${cleanItemCode}`);
                                totalWeight += 50 * quantity;
                                productDetails.push(`ä¸æ˜å•†å“: ${cleanItemCode}`);
                                totalQuantity += quantity;
                            }
                        });
                    } else {
                        // å˜ä¸€å•†å“ã®å ´åˆï¼ˆä¾‹: L1=bara60ï¼‰
                        const quantity = parseInt(quantityDetail) || 1;
                        
                        // å˜ä¸€å•†å“ã§ã‚‚ = ã‚ˆã‚Šå¾Œã‚ã‚’å–å¾—
                        let cleanItemCode = itemId;
                        if (itemId && itemId.includes('=')) {
                            cleanItemCode = itemId.split('=')[1]; // = ã‚ˆã‚Šå¾Œã‚ã‚’å–å¾—
                        }
                        
                        console.log(`Yahoo single item: ${itemId} -> ${cleanItemCode}`);
                        const masterInfo = productMaster[cleanItemCode];
                        console.log(`Searching for ${cleanItemCode}:`, masterInfo);
                        
                        if (masterInfo && masterInfo.colorSets) {
                            // è¤‡æ•°ã‚«ãƒ©ãƒ¼ã‚»ãƒƒãƒˆå¯¾å¿œ
                            let unitTotalWeight = 0;
                            const detailParts = [];
                            
                            masterInfo.colorSets.forEach(set => {
                                unitTotalWeight += set.weight * set.quantity;
                                detailParts.push(`${set.color}: ${set.weight}gÃ—${set.quantity}`);
                            });
                            
                            totalWeight = unitTotalWeight * quantity;
                            productDetails.push(detailParts.join(', '));
                        } else {
                            console.log(`Product not found in master: ${cleanItemCode}`);
                            // å•†å“ãƒã‚¹ã‚¿ã«ãªã„å ´åˆã€ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é‡é‡æ¨å®š
                            const weightMatch = title?.match(/(\d+)g/);
                            totalWeight = weightMatch ? parseInt(weightMatch[1]) * quantity : 50 * quantity;
                            productDetails.push(`ä¸æ˜å•†å“: ${cleanItemCode}`);
                        }
                        totalQuantity = quantity;
                    }

                    orders.push({
                        source: 'Yahoo',
                        sku: itemId,
                        productName: productDetails.join(', '),
                        quantity: totalQuantity,
                        recipientName: shipName,
                        shipAddress: shipAddress,
                        zipCode: formatZipCode(shipZip),
                        phoneNumber: shipPhone,
                        weight: totalWeight,
                        orderId: orderId
                    });
                } catch (error) {
                    console.error(`Yahoo row ${index} error:`, error);
                }
            });
            
            console.log('Yahoo orders processed:', orders.length);
            return orders;
        }

        function mergeOrdersByRecipient(orders) {
            const merged = {};
            
            orders.forEach(order => {
                const key = `${order.recipientName}_${order.shipAddress}_${order.phoneNumber}`;
                
                if (merged[key]) {
                    merged[key].weight += order.weight;
                    merged[key].quantity += order.quantity;
                    merged[key].orderId += `,${order.orderId}`;
                    
                    if (!merged[key].productName.includes(order.productName)) {
                        merged[key].productName += `, ${order.productName}`;
                    }
                } else {
                    merged[key] = { ...order };
                }
            });
            
            return Object.values(merged);
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            
            const cleaned = phone.replace(/[^\d]/g, '');
            const withZero = cleaned.startsWith('0') ? cleaned : '0' + cleaned;
            
            if (withZero.length === 10) {
                return `${withZero.substr(0, 3)}-${withZero.substr(3, 3)}-${withZero.substr(6, 4)}`;
            } else if (withZero.length === 11) {
                return `${withZero.substr(0, 3)}-${withZero.substr(3, 4)}-${withZero.substr(7, 4)}`;
            }
            
            return withZero;
        }

        function formatZipCode(zipCode) {
            if (!zipCode) return '';
            
            const cleaned = zipCode.replace(/[^\d]/g, '');
            
            // æ¥½å¤©ã®éƒµä¾¿ç•ªå·ä¿®æ­£å‡¦ç†
            if (cleaned.length === 5) {
                if (cleaned.startsWith('133') && cleaned.endsWith('55')) {
                    return '133-0055';
                }
                if (cleaned.startsWith('590') && cleaned.endsWith('06')) {
                    return '590-0006';
                }
            }
            
            if (cleaned.length === 7) {
                return `${cleaned.substr(0, 3)}-${cleaned.substr(3, 4)}`;
            }
            
            return cleaned;
        }

        function generateYamatoCSV(orders) {
            const headers = [
                'é€ã‚ŠçŠ¶ç¨®é¡','å‡ºè·äºˆå®šæ—¥','ãŠå±Šã‘äºˆå®šæ—¥','é…é”æ™‚é–“å¸¯','ãŠå±Šã‘å…ˆé›»è©±ç•ªå·',
                'ãŠå±Šã‘å…ˆéƒµä¾¿ç•ªå·','ãŠå±Šã‘å…ˆä½æ‰€','ãŠå±Šã‘å…ˆã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å','ãŠå±Šã‘å…ˆå',
                'ã”ä¾é ¼ä¸»é›»è©±ç•ªå·','ã”ä¾é ¼ä¸»éƒµä¾¿ç•ªå·','ã”ä¾é ¼ä¸»ä½æ‰€','ã”ä¾é ¼ä¸»å','å“åï¼‘',
                'ç·é‡é‡(g)','å“åè©³ç´°','ä¸æ˜å“å','è²©å£²ID','',''
            ];

            const rows = [headers.join(',')];
            
            const today = new Date();
            const shipDate = `${today.getFullYear()}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getDate().toString().padStart(2, '0')}`;

            orders.forEach(order => {
                const escapeCSV = (str) => {
                    if (!str) return '';
                    const strValue = String(str);
                    if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) {
                        return '"' + strValue.replace(/"/g, '""') + '"';
                    }
                    return strValue;
                };
                
                const row = [
                    '7', // ãƒã‚³ãƒã‚¹ãƒ»ã‚¯ãƒ­ãƒã‚³ã‚†ã†ãƒ‘ã‚±ãƒƒãƒˆ
                    shipDate,
                    '', // ãŠå±Šã‘äºˆå®šæ—¥
                    '', // é…é”æ™‚é–“å¸¯
                    escapeCSV(order.phoneNumber),
                    escapeCSV(order.zipCode),
                    escapeCSV(order.shipAddress),
                    '', // ã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å
                    escapeCSV(order.recipientName),
                    '050-3590-1444', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥é›»è©±ç•ªå·
                    '104-0061', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥éƒµä¾¿ç•ªå·
                    'æ±äº¬éƒ½ä¸­å¤®åŒºéŠ€åº§1-22-11 2F', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥ä½æ‰€
                    'JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥', // JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥å
                    escapeCSV(order.productName?.substring(0, 50) || ''), // å“åï¼ˆ50æ–‡å­—åˆ¶é™ï¼‰
                    Math.round(order.weight || 50),
                    '', // å“åè©³ç´°
                    '', // ä¸æ˜å“å
                    escapeCSV(order.orderId),
                    '', ''
                ];
                rows.push(row.join(','));
            });

            return rows.join('\r\n');
        }

        function showProgress() {
            document.querySelector('.upload-section').style.display = 'none';
            convertButton.style.display = 'none';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
        }

        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function showResult(csvContent, stats) {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            messageArea.innerHTML = `
                <div class="success-message">
                    <strong>ğŸ‰ å¤‰æ›å®Œäº†ï¼</strong><br>
                    ${stats.original}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’${stats.merged}ä»¶ã«ã¾ã¨ã‚ã¦ãƒ¤ãƒãƒˆé‹è¼¸å½¢å¼ã«å¤‰æ›ã—ã¾ã—ãŸã€‚
                </div>
                
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="stat-number">${stats.amazon}</div>
                        <div class="stat-label">Amazon</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.rakuten}</div>
                        <div class="stat-label">æ¥½å¤©</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.yahoo}</div>
                        <div class="stat-label">Yahoo</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.merged}</div>
                        <div class="stat-label">æœ€çµ‚ä»¶æ•°</div>
                    </div>
                </div>
            `;
            
            downloadButton.style.display = 'block';
            window.csvData = csvContent;
            
            downloadButton.onclick = () => downloadCSV(csvContent, stats.merged);
        }

        function downloadCSV(csvContent, recordCount) {
            try {
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `YBMdata_${getCurrentDateString()}.csv`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                downloadButton.textContent = 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼';
                downloadButton.style.background = '#38a169';
                
            } catch (error) {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function getCurrentDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function showError(message) {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            messageArea.innerHTML = `
                <div class="error-message">
                    <strong>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong><br>
                    ${message}<br><br>
                    <small>ç¢ºèªé …ç›®ï¼š<br>
                    â€¢ å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹<br>
                    â€¢ ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ã„ã‹ï¼ˆAmazon: TSVã€æ¥½å¤©ãƒ»Yahoo: CSVï¼‰<br>
                    â€¢ ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ãªã„ã‹</small>
                </div>
            `;
            
            downloadButton.style.display = 'none';
        }

        // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        resetButton.addEventListener('click', () => {
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            masterFile.value = '';
            amazonFile.value = '';
            rakutenFile.value = '';
            yahooFile.value = '';
            
            selectedFiles = { master: null, amazon: null, rakuten: null, yahoo: null };
            productMaster = {};
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const statusElements = [
                { id: 'masterStatus', text: 'å•†å“ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«(.xlsx/.xlsm)ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'amazonStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'rakutenStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' },
                { id: 'yahooStatus', text: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„' }
            ];
            
            statusElements.forEach(({ id, text }) => {
                const element = document.getElementById(id);
                element.textContent = text;
                element.className = 'file-status';
                element.style.color = '';
            });
            
            // ã‚¤ãƒ³ãƒ—ãƒƒãƒˆè¦ç´ ã®ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            [masterFile, amazonFile, rakutenFile, yahooFile].forEach(input => {
                input.classList.remove('has-file');
            });
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelector('.upload-section').style.display = 'block';
            convertButton.style.display = 'block';
            convertButton.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            
            downloadButton.textContent = 'ãƒ¤ãƒãƒˆé‹è¼¸ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            downloadButton.style.background = '#48bb78';
            
            updateConvertButton();
        });

        // åˆæœŸåŒ–
        updateConvertButton();
    </script>
</body>
</html>
