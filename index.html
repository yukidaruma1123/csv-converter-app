<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¤ãƒãƒˆé‹è¼¸ç™ºé€ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒã‚¯ãƒ­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 30px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .sidebar h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .config-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .config-section input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .action-buttons {
            display: grid;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .main-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .upload-area.dragover {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .file-input {
            display: none;
        }

        .file-select-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table-header {
            background: #343a40;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
        }

        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #495057;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s;
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ãƒ¤ãƒãƒˆé‹è¼¸ç™ºé€ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒã‚¯ãƒ­</h1>
            <p>ECã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¤ãƒãƒˆé‹è¼¸ç™ºé€ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h2>ğŸ“‹ ç™ºé€å…ƒãƒ‡ãƒ¼ã‚¿</h2>
                
                <div class="config-section">
                    <label for="phone">ã”ä¾é ¼ä¸»é›»è©±ç•ªå· (åŠè§’æ•°å­—15æ–‡å­—ãƒã‚¤ãƒ•ãƒ³å«ã‚€)</label>
                    <input type="text" id="phone" value="050-3590-1444" maxlength="15">
                </div>

                <div class="config-section">
                    <label for="zipcode">ã”ä¾é ¼ä¸»éƒµä¾¿ç•ªå· (åŠè§’æ•°å­—8æ–‡å­—)</label>
                    <input type="text" id="zipcode" value="104-0061" maxlength="8">
                </div>

                <div class="config-section">
                    <label for="address">ã”ä¾é ¼ä¸»ä½æ‰€ (å…¨è§’32æ–‡å­—)</label>
                    <input type="text" id="address" value="æ±äº¬éƒ½ä¸­å¤®åŒºéŠ€åº§ 1-22-11 2F" maxlength="32">
                </div>

                <div class="config-section">
                    <label for="name">ã”ä¾é ¼ä¸»å (å…¨è§’16æ–‡å­—)</label>
                    <input type="text" id="name" value="JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥" maxlength="16">
                </div>

                <h2>ğŸ“ ä½¿ç”¨æ–¹æ³•</h2>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="clearData()">
                        <span>ğŸ—‘ï¸</span> â‘ ï¼šç™ºé€ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã™ã‚‹
                    </button>
                    <button class="btn btn-primary" onclick="importData()">
                        <span>ğŸ“¥</span> â‘¡ï¼šECã‚µã‚¤ãƒˆã®è²©å£²ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€
                    </button>
                    <button class="btn btn-warning" onclick="previewData()">
                        <span>ğŸ‘ï¸</span> â‘¢ï¼šå–å¾—ã—ãŸç™ºé€ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <span>ğŸ“¤</span> â‘£ï¼šãƒ¤ãƒãƒˆè¼¸é€ç™ºé€ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›
                    </button>
                </div>

                <div class="config-section">
                    <label>å•†å“ãƒã‚¹ã‚¿æ›´æ–°</label>
                    <input type="file" id="masterFile" class="file-input" accept=".xlsx,.xlsm" onchange="updateMaster(this)">
                    <button class="file-select-btn" onclick="document.getElementById('masterFile').click()">
                        ğŸ“Š ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                    </button>
                </div>
            </div>

            <div class="main-area">
                <div class="upload-area" id="uploadArea">
                    <h3>ğŸ“ ECã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠ</h3>
                    <p>Amazon, Yahoo, æ¥½å¤©ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œ</p>
                    <input type="file" id="dataFile" class="file-input" multiple accept=".csv,.txt" onchange="handleFiles(this.files)">
                    <button class="file-select-btn" onclick="document.getElementById('dataFile').click()">
                        ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                    </button>
                </div>

                <div id="statusMessage"></div>
                <div id="progressBar" class="progress-bar" style="display: none;">
                    <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                </div>

                <div class="data-table" id="dataTable" style="display: none;">
                    <div class="table-header">
                        ğŸ“¦ å‡¦ç†çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                    </div>
                    <div class="table-content">
                        <table id="resultTable">
                            <thead id="tableHeader"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let productMaster = [];
        let processedData = [];
        let currentFiles = [];

        // åˆæœŸåŒ–æ™‚ã«å•†å“ãƒã‚¹ã‚¿ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®š
        window.onload = function() {
            initializeDefaultMaster();
            setupDragAndDrop();
        };

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•†å“ãƒã‚¹ã‚¿ã®åˆæœŸåŒ–
        function initializeDefaultMaster() {
            productMaster = [
                ["è²©å£²ã‚µã‚¤ãƒˆ", "å•†å“è©³ç´°", "å•†å“No", "é‡ã•", "å€‹æ•°", "è‰²"],
                ["Yahoo", "15g 2å€‹å…¥ ã‚´ãƒ¼ãƒ«ãƒ‰é‡‘ ãƒ¡ã‚¿ãƒ«ã‚¸ã‚° ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³", "jg152", 15, 2, "é‡‘"],
                ["Amazon", "ãƒ¡ã‚¿ãƒ«ã‚¸ã‚° ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³ é«˜ç´”åº¦ ç„¡å¡—è£… å®šç•ªå½¢çŠ¶", "jg256", 25, 6, "é‡‘"],
                // ... ä»–ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚‚åŒæ§˜ã«è¿½åŠ å¯èƒ½
            ];
            showStatus("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•†å“ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ", "info");
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFiles(files) {
            currentFiles = Array.from(files);
            showStatus(`${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ`, "info");
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
            const fileNames = Array.from(files).map(file => file.name).join(', ');
            document.getElementById('uploadArea').innerHTML = `
                <h3>ğŸ“ é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <p>${fileNames}</p>
                <button class="file-select-btn" onclick="document.getElementById('dataFile').click()">
                    åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </button>
            `;
        }

        // å•†å“ãƒã‚¹ã‚¿æ›´æ–°
        async function updateMaster(input) {
            const file = input.files[0];
            if (!file) return;

            try {
                showStatus("å•†å“ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...", "info");
                
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // å•†å“ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
                const masterSheetName = workbook.SheetNames.find(name => 
                    name.includes('å•†å“ãƒã‚¹ã‚¿') || name.includes('ãƒã‚¹ã‚¿')
                ) || workbook.SheetNames[0];
                
                const worksheet = workbook.Sheets[masterSheetName];
                productMaster = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                showStatus(`å•†å“ãƒã‚¹ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ (${productMaster.length - 1}ä»¶ã®å•†å“)`, "success");
            } catch (error) {
                showStatus(`å•†å“ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
            }
        }

        // â‘ ç™ºé€ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»
        function clearData() {
            if (confirm('ç™ºé€ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
                processedData = [];
                currentFiles = [];
                document.getElementById('dataTable').style.display = 'none';
                document.getElementById('uploadArea').innerHTML = `
                    <h3>ğŸ“ ECã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠ</h3>
                    <p>Amazon, Yahoo, æ¥½å¤©ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œ</p>
                    <input type="file" id="dataFile" class="file-input" multiple accept=".csv,.txt" onchange="handleFiles(this.files)">
                    <button class="file-select-btn" onclick="document.getElementById('dataFile').click()">
                        ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                    </button>
                `;
                showStatus("ç™ºé€ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã—ãŸ", "success");
            }
        }

        // â‘¡ECã‚µã‚¤ãƒˆã®è²©å£²ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€
        async function importData() {
            if (currentFiles.length === 0) {
                showStatus("å…ˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
                return;
            }

            try {
                showProgress(0);
                showStatus("ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ä¸­...", "info");
                
                processedData = [];
                
                for (let i = 0; i < currentFiles.length; i++) {
                    const file = currentFiles[i];
                    showProgress((i / currentFiles.length) * 100);
                    
                    const text = await file.text();
                    const data = parseCSV(text);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ECã‚µã‚¤ãƒˆã‚’åˆ¤å®š
                    const ecSite = detectECSite(file.name, data);
                    const converted = convertToYamatoFormat(data, ecSite);
                    
                    processedData = processedData.concat(converted);
                }
                
                showProgress(100);
                showStatus(`${processedData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`, "success");
                
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                showStatus(`ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
                document.getElementById('progressBar').style.display = 'none';
            }
        }

        // â‘¢å–å¾—ã—ãŸç™ºé€ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        function previewData() {
            if (processedData.length === 0) {
                showStatus("å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚“ã§ãã ã•ã„", "error");
                return;
            }

            displayDataTable(processedData);
            showStatus(`${processedData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­`, "info");
        }

        // â‘£ãƒ¤ãƒãƒˆè¼¸é€ç™ºé€ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›
        function exportData() {
            if (processedData.length === 0) {
                showStatus("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", "error");
                return;
            }

            try {
                const csvContent = generateYamatoCSV(processedData);
                downloadCSV(csvContent, `yamato_shipping_${getDateString()}.csv`);
                showStatus(`${processedData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ`, "success");
            } catch (error) {
                showStatus(`CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
            }
        }

        // CSVè§£æ
        function parseCSV(text) {
            // æ–‡å­—ã‚³ãƒ¼ãƒ‰åˆ¤å®šã¨å¤‰æ›
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const data = lines.map(line => {
                // CSVãƒ‘ãƒ¼ã‚¹ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            });
            
            return data;
        }

        // ECã‚µã‚¤ãƒˆåˆ¤å®š
        function detectECSite(filename, data) {
            const name = filename.toLowerCase();
            if (name.includes('amazon') || name.includes('18208008508020269')) return 'Amazon';
            if (name.includes('yahoo') || name.includes('yahooall')) return 'Yahoo';
            if (name.includes('rakuten') || name.includes('æ¥½å¤©') || name.includes('20250630')) return 'Rakuten';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰åˆ¤å®š
            if (data.length > 0) {
                const header = data[0].join('').toLowerCase();
                if (header.includes('order-id') || header.includes('sku')) return 'Amazon';
                if (header.includes('orderid') || header.includes('itemid')) return 'Yahoo';
                if (header.includes('æ³¨æ–‡ç•ªå·') || header.includes('å•†å“å')) return 'Rakuten';
            }
            
            return 'Unknown';
        }

        // ãƒ¤ãƒãƒˆå½¢å¼ã¸ã®å¤‰æ›
        function convertToYamatoFormat(data, ecSite) {
            if (data.length === 0) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            const converted = [];
            
            const senderInfo = {
                phone: document.getElementById('phone').value,
                zipcode: document.getElementById('zipcode').value,
                address: document.getElementById('address').value,
                name: document.getElementById('name').value
            };

            rows.forEach(row => {
                try {
                    let convertedRow;
                    
                    switch (ecSite) {
                        case 'Amazon':
                            convertedRow = convertAmazonData(headers, row, senderInfo);
                            break;
                        case 'Yahoo':
                            convertedRow = convertYahooData(headers, row, senderInfo);
                            break;
                        case 'Rakuten':
                            convertedRow = convertRakutenData(headers, row, senderInfo);
                            break;
                        default:
                            convertedRow = convertGenericData(headers, row, senderInfo);
                    }
                    
                    if (convertedRow) {
                        converted.push(convertedRow);
                    }
                } catch (error) {
                    console.warn('è¡Œã®å¤‰æ›ã§ã‚¨ãƒ©ãƒ¼:', error);
                }
            });
            
            return converted;
        }

        // Amazon ãƒ‡ãƒ¼ã‚¿å¤‰æ›
        function convertAmazonData(headers, row, senderInfo) {
            const getField = (fieldName) => {
                const index = headers.findIndex(h => h.toLowerCase().includes(fieldName.toLowerCase()));
                return index >= 0 ? row[index] : '';
            };

            const recipientName = getField('recipient-name') || getField('ship-name');
            const recipientAddress1 = getField('ship-address-1');
            const recipientAddress2 = getField('ship-address-2');
            const recipientCity = getField('ship-city');
            const recipientState = getField('ship-state');
            const recipientZip = getField('ship-postal-code');
            const productName = getField('product-name');
            const quantity = getField('quantity-purchased') || getField('quantity-shipped');

            // å•†å“æƒ…å ±ã®æ¤œç´¢
            const productInfo = findProductInfo(productName);
            const totalWeight = calculateTotalWeight(productInfo, quantity);

            return [
                '0', // é€ã‚ŠçŠ¶ç¨®é¡ï¼ˆç™ºæ‰•ã„ï¼‰
                formatDate(new Date()), // å‡ºè·äºˆå®šæ—¥
                '', // ãŠå±Šã‘äºˆå®šæ—¥
                '', // é…é”æ™‚é–“å¸¯
                '', // ãŠå±Šã‘å…ˆé›»è©±ç•ªå·ï¼ˆAmazonã§ã¯é€šå¸¸æä¾›ã•ã‚Œãªã„ï¼‰
                formatZipCode(recipientZip),
                `${recipientState}${recipientCity}${recipientAddress1}`,
                recipientAddress2 || '',
                recipientName,
                senderInfo.phone,
                senderInfo.zipcode,
                senderInfo.address,
                senderInfo.name,
                productInfo.simpleName || productName.substring(0, 25),
                totalWeight || '',
                productName,
                '', // ä¸æ˜å“å
                getField('order-id') || getField('order-item-id')
            ];
        }

        // Yahoo ãƒ‡ãƒ¼ã‚¿å¤‰æ›
        function convertYahooData(headers, row, senderInfo) {
            const getField = (fieldName) => {
                const index = headers.findIndex(h => h.toLowerCase().includes(fieldName.toLowerCase()));
                return index >= 0 ? row[index] : '';
            };

            const shipName = getField('shipname') || getField('billname');
            const shipAddress1 = getField('shipaddress1') || getField('billaddress1');
            const shipAddress2 = getField('shipaddress2') || getField('billaddress2');
            const shipCity = getField('shipcity') || getField('billcity');
            const shipPrefecture = getField('shipprefecture') || getField('billprefecture');
            const shipZipCode = getField('shipzipcode') || getField('billzipcode');
            const title = getField('title');
            const quantity = getField('quantitydetail') || 1;

            // å•†å“æƒ…å ±ã®æ¤œç´¢
            const productInfo = findProductInfo(title);
            const totalWeight = calculateTotalWeight(productInfo, quantity);

            return [
                '0', // é€ã‚ŠçŠ¶ç¨®é¡
                formatDate(new Date()),
                '',
                '',
                '',
                formatZipCode(shipZipCode),
                `${shipPrefecture}${shipCity}${shipAddress1}`,
                shipAddress2 || '',
                shipName,
                senderInfo.phone,
                senderInfo.zipcode,
                senderInfo.address,
                senderInfo.name,
                productInfo.simpleName || title.substring(0, 25),
                totalWeight || '',
                title,
                '',
                getField('orderid') || getField('id')
            ];
        }

        // æ¥½å¤©ãƒ‡ãƒ¼ã‚¿å¤‰æ›
        function convertRakutenData(headers, row, senderInfo) {
            const getField = (fieldName) => {
                const index = headers.findIndex(h => h.includes(fieldName));
                return index >= 0 ? row[index] : '';
            };

            const deliveryName = getField('é…é€å…ˆå') || getField('æ³¨æ–‡è€…å');
            const deliveryZip1 = getField('é…é€å…ˆéƒµä¾¿ç•ªå·1');
            const deliveryZip2 = getField('é…é€å…ˆéƒµä¾¿ç•ªå·2');
            const deliveryPrefecture = getField('é…é€å…ˆéƒ½é“åºœçœŒ');
            const deliveryCity = getField('é…é€å…ˆå¸‚åŒºç”ºæ‘');
            const deliveryAddress1 = getField('é…é€å…ˆä½æ‰€1');
            const deliveryAddress2 = getField('é…é€å…ˆä½æ‰€2') || '';
            const productName = getField('å•†å“å');
            const quantity = getField('å€‹æ•°') || getField('æ•°é‡') || 1;

            const productInfo = findProductInfo(productName);
            const totalWeight = calculateTotalWeight(productInfo, quantity);

            return [
                '0',
                formatDate(new Date()),
                '',
                '',
                '',
                `${deliveryZip1}-${deliveryZip2}`,
                `${deliveryPrefecture}${deliveryCity}${deliveryAddress1}`,
                deliveryAddress2,
                deliveryName,
                senderInfo.phone,
                senderInfo.zipcode,
                senderInfo.address,
                senderInfo.name,
                productInfo.simpleName || productName.substring(0, 25),
                totalWeight || '',
                productName,
                '',
                getField('æ³¨æ–‡ç•ªå·') || getField('ä¼ç¥¨ç•ªå·')
            ];
        }

        // æ±ç”¨ãƒ‡ãƒ¼ã‚¿å¤‰æ›
        function convertGenericData(headers, row, senderInfo) {
            // åŸºæœ¬çš„ãªå¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
            return [
                '0',
                formatDate(new Date()),
                '', '', '', '', '', '', '',
                senderInfo.phone,
                senderInfo.zipcode,
                senderInfo.address,
                senderInfo.name,
                'å•†å“', '', '', '', ''
            ];
        }

        // å•†å“æƒ…å ±æ¤œç´¢
        function findProductInfo(productName) {
            if (!productName || productMaster.length <= 1) {
                return { simpleName: 'å•†å“', weight: 0, quantity: 1 };
            }

            const searchName = productName.toLowerCase();
            
            for (let i = 1; i < productMaster.length; i++) {
                const product = productMaster[i];
                const productDetail = (product[1] || '').toLowerCase();
                const productNo = (product[2] || '').toLowerCase();
                
                if (searchName.includes(productNo) || productDetail.includes(searchName.substring(0, 10))) {
                    return {
                        simpleName: 'ãƒ¡ã‚¿ãƒ«ã‚¸ã‚°',
                        weight: product[3] || 0,
                        quantity: product[4] || 1,
                        color: product[5] || ''
                    };
                }
            }

            // é‡é‡ã‚’å•†å“åã‹ã‚‰æ¨å®š
            const weightMatch = productName.match(/(\d+)g/);
            const weight = weightMatch ? parseInt(weightMatch[1]) : 0;

            return {
                simpleName: 'ãƒ¡ã‚¿ãƒ«ã‚¸ã‚°',
                weight: weight,
                quantity: 1,
                color: ''
            };
        }

        // ç·é‡é‡è¨ˆç®—
        function calculateTotalWeight(productInfo, quantity) {
            const qty = parseInt(quantity) || 1;
            const weight = productInfo.weight || 0;
            const productQty = productInfo.quantity || 1;
            return weight * productQty * qty;
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // éƒµä¾¿ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatZipCode(zipCode) {
            if (!zipCode) return '';
            const cleaned = zipCode.replace(/[^\d]/g, '');
            if (cleaned.length === 7) {
                return `${cleaned.substring(0, 3)}-${cleaned.substring(3)}`;
            }
            return zipCode;
        }

        // æ—¥ä»˜æ–‡å­—åˆ—ç”Ÿæˆ
        function getDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
        function displayDataTable(data) {
            if (data.length === 0) return;

            const headers = [
                'é€ã‚ŠçŠ¶ç¨®é¡', 'å‡ºè·äºˆå®šæ—¥', 'ãŠå±Šã‘äºˆå®šæ—¥', 'é…é”æ™‚é–“å¸¯',
                'ãŠå±Šã‘å…ˆé›»è©±ç•ªå·', 'ãŠå±Šã‘å…ˆéƒµä¾¿ç•ªå·', 'ãŠå±Šã‘å…ˆä½æ‰€',
                'ãŠå±Šã‘å…ˆã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å', 'ãŠå±Šã‘å…ˆå',
                'ã”ä¾é ¼ä¸»é›»è©±ç•ªå·', 'ã”ä¾é ¼ä¸»éƒµä¾¿ç•ªå·', 'ã”ä¾é ¼ä¸»ä½æ‰€', 'ã”ä¾é ¼ä¸»å',
                'å“å', 'ç·é‡é‡(g)', 'å“åè©³ç´°', 'ä¸æ˜å“å', 'è²©å£²ID'
            ];

            let html = '<tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr>';

            document.getElementById('tableHeader').innerHTML = html;

            let bodyHtml = '';
            data.slice(0, 100).forEach(row => { // æœ€åˆã®100è¡Œã®ã¿è¡¨ç¤º
                bodyHtml += '<tr>';
                row.forEach(cell => {
                    bodyHtml += `<td>${cell || ''}</td>`;
                });
                bodyHtml += '</tr>';
            });

            document.getElementById('tableBody').innerHTML = bodyHtml;
            document.getElementById('dataTable').style.display = 'block';
        }

        // ãƒ¤ãƒãƒˆCSVç”Ÿæˆ
        function generateYamatoCSV(data) {
            const headers = [
                'é€ã‚ŠçŠ¶ç¨®é¡', 'å‡ºè·äºˆå®šæ—¥', 'ãŠå±Šã‘äºˆå®šæ—¥', 'é…é”æ™‚é–“å¸¯',
                'ãŠå±Šã‘å…ˆé›»è©±ç•ªå·', 'ãŠå±Šã‘å…ˆéƒµä¾¿ç•ªå·', 'ãŠå±Šã‘å…ˆä½æ‰€',
                'ãŠå±Šã‘å…ˆã‚¢ãƒ‘ãƒ¼ãƒˆãƒãƒ³ã‚·ãƒ§ãƒ³å', 'ãŠå±Šã‘å…ˆå',
                'ã”ä¾é ¼ä¸»é›»è©±ç•ªå·', 'ã”ä¾é ¼ä¸»éƒµä¾¿ç•ªå·', 'ã”ä¾é ¼ä¸»ä½æ‰€', 'ã”ä¾é ¼ä¸»å',
                'å“åï¼‘', 'ç·é‡é‡(g)', 'å“åè©³ç´°', 'ä¸æ˜å“å', 'è²©å£²ID'
            ];

            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                const escapedRow = row.map(cell => {
                    const str = String(cell || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                });
                csv += escapedRow.join(',') + '\n';
            });

            return csv;
        }

        // CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV(content, filename) {
            const bom = '\uFEFF'; // UTF-8 BOM
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
        function showProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = `${percentage}%`;
        }

        // XLSX ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
