<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV統合変換システム - ヤマト運輸データ作成</title>
    <meta name="description" content="Amazon・楽天・Yahoo のCSVデータをヤマト運輸用CSVに変換するWebアプリケーション">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .file-group {
            margin-bottom: 20px;
        }

        .file-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #f7fafc;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-family: inherit;
        }

        .file-input:hover {
            border-color: #007bff;
            background: #edf2f7;
        }

        .file-input.has-file {
            border-color: #28a745;
            background: #f0fff4;
            border-style: solid;
        }

        .file-status {
            font-size: 12px;
            margin-top: 4px;
            color: #718096;
        }

        .file-status.success {
            color: #28a745;
        }

        .convert-button {
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 20px;
        }

        .convert-button:hover:not(:disabled) {
            background: #0056b3;
        }

        .convert-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            color: #4a5568;
            font-size: 14px;
        }

        .result-section {
            display: none;
        }

        .success-message {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .error-message {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #742a2a;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .download-button {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .download-button:hover {
            background: #218838;
        }

        .reset-button {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .reset-button:hover {
            background: #f7fafc;
        }

        .info-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .info-list {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-list li {
            margin-bottom: 4px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-box {
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .required-label {
            color: #e53e3e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CSV統合変換システム</h1>
            <p>Amazon・楽天・Yahoo のデータをヤマト運輸用に変換</p>
        </div>

        <div class="upload-section">
            <div class="file-group">
                <label class="file-label">商品マスタファイル <span class="required-label">*必須</span></label>
                <input type="file" id="masterFile" class="file-input" accept=".xlsx,.xlsm,.xls">
                <div class="file-status" id="masterStatus">商品マスタファイル(.xlsx/.xlsm)を選択してください</div>
            </div>

            <div class="file-group">
                <label class="file-label">Amazonデータ (TSV形式)</label>
                <input type="file" id="amazonFile" class="file-input" accept=".txt,.tsv,.csv">
                <div class="file-status" id="amazonStatus">ファイルを選択してください</div>
            </div>

            <div class="file-group">
                <label class="file-label">楽天データ (CSV形式)</label>
                <input type="file" id="rakutenFile" class="file-input" accept=".csv">
                <div class="file-status" id="rakutenStatus">ファイルを選択してください</div>
            </div>

            <div class="file-group">
                <label class="file-label">Yahooデータ (CSV形式)</label>
                <input type="file" id="yahooFile" class="file-input" accept=".csv">
                <div class="file-status" id="yahooStatus">ファイルを選択してください</div>
            </div>
        </div>

        <button class="convert-button" id="convertButton" disabled>
            データを変換してダウンロード
        </button>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">処理中...</div>
        </div>

        <div class="result-section" id="resultSection">
            <div id="messageArea"></div>
            <button class="download-button" id="downloadButton" style="display: none;">
                ヤマト運輸用CSVをダウンロード
            </button>
            <button class="reset-button" id="resetButton">
                最初からやり直す
            </button>
        </div>

        <div class="info-section">
            <div class="info-title">使用方法</div>
            <ul class="info-list">
                <li>1. 商品マスタファイル(.xlsx/.xlsm)を選択</li>
                <li>2. 各ECサイトのCSVファイルを選択</li>
                <li>3. 「データを変換してダウンロード」をクリック</li>
                <li>4. 変換完了後、ヤマト運輸用CSVをダウンロード</li>
                <li>※ ファイル形式：Amazon(TSV)、楽天・Yahoo(CSV)</li>
                <li>※ 同一配送先は自動統合されます</li>
                <li>※ 重量は商品マスタから自動計算されます</li>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // グローバル変数
        let productMaster = {};
        let colorWeightMap = {}; // カラーオモリ対応表
        let selectedFiles = {
            master: null,
            amazon: null,
            rakuten: null,
            yahoo: null
        };

        // DOM要素
        const masterFile = document.getElementById('masterFile');
        const amazonFile = document.getElementById('amazonFile');
        const rakutenFile = document.getElementById('rakutenFile');
        const yahooFile = document.getElementById('yahooFile');
        const convertButton = document.getElementById('convertButton');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultSection = document.getElementById('resultSection');
        const messageArea = document.getElementById('messageArea');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');

        // 初期化時にカラーオモリ対応表を読み込み
        async function loadColorWeightMap() {
            try {
                console.log('Loading color weight map...');
                const response = await fetch('カラーオモリ対応表1.xlsx');
                if (!response.ok) {
                    throw new Error('カラーオモリ対応表1.xlsxが見つかりません');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // 最初のシートを使用
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                const jsonData = XLSX.utils.sheet_to_json(sheet, { 
                    header: 1,
                    defval: '',
                    blankrows: false
                });
                
                console.log('Color weight map headers:', jsonData[0]);
                
                colorWeightMap = {};
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row[1] && row[3] && row[4]) { // B列、D列、E列が存在する場合
                        const productCode = String(row[1]).trim(); // B列：商品コード
                        const color = String(row[3]).trim(); // D列：色
                        const weightStr = String(row[4]).trim(); // E列：重さ
                        
                        // 重量から「g」を取り除いて数値に変換
                        const weight = parseFloat(weightStr.replace(/g$/i, '')) || 0;
                        
                        if (productCode && color && weight > 0) {
                            colorWeightMap[productCode] = {
                                color: color,
                                weight: weight
                            };
                        }
                    }
                }
                
                console.log(`Color weight map loaded: ${Object.keys(colorWeightMap).length} entries`);
                
            } catch (error) {
                console.error('カラーオモリ対応表読み込みエラー:', error);
                // エラーでも処理を続行
            }
        }

        // 特殊色の場合にSubCodeやSKUからカラーオモリ対応表を検索する関数
        function findSpecialColorInfo(productId, subCodeOrSku, dataSource) {
            let colorCode = '';
            
            console.log(`特殊色検索開始 - データソース: ${dataSource}, 商品ID: ${productId}, SubCode/SKU: ${subCodeOrSku}`);
            
            if (dataSource === 'Yahoo') {
                // Yahoo: SubCode(=以降)から抽出
                if (subCodeOrSku && subCodeOrSku.includes('=')) {
                    colorCode = subCodeOrSku.split('=')[1];
                    console.log(`Yahoo SubCode抽出: ${colorCode}`);
                }
            } else if (dataSource === 'Rakuten') {
                // 楽天: SKU情報(:以降)から抽出
                if (subCodeOrSku && subCodeOrSku.includes(':')) {
                    colorCode = subCodeOrSku.split(':')[1];
                    console.log(`楽天 SKU抽出: ${colorCode}`);
                }
            }
            
            // カラーオモリ対応表から検索
            console.log(`カラーオモリ対応表で検索: ${colorCode}`);
            if (colorCode && colorWeightMap[colorCode]) {
                console.log(`カラーオモリ対応表で見つかった: ${colorWeightMap[colorCode].color}, ${colorWeightMap[colorCode].weight}g`);
                return colorWeightMap[colorCode];
            }
            
            console.log(`カラーオモリ対応表で見つからなかった: ${colorCode}`);
            return null;
        }
        function getColorAbbreviation(color) {
            if (!color) return '';
            
            const colorMap = {
                // 基本色
                '赤': '赤',
                '赤色': '赤',
                'レッド': '赤',
                'Red': '赤',
                '青': '青',
                '青色': '青',
                'ブルー': '青',
                'Blue': '青',
                '緑': '緑',
                '緑色': '緑',
                'グリーン': '緑',
                'Green': '緑',
                '黄': '黄',
                '黄色': '黄',
                'イエロー': '黄',
                'Yellow': '黄',
                '白': '白',
                '白色': '白',
                'ホワイト': '白',
                'White': '白',
                '黒': '黒',
                '黒色': '黒',
                'ブラック': '黒',
                'Black': '黒',
                '紫': '紫',
                '紫色': '紫',
                'パープル': '紫',
                'Purple': '紫',
                '橙': '橙',
                '橙色': '橙',
                'オレンジ': '橙',
                'Orange': '橙',
                'ピンク': 'ピ',
                'Pink': 'ピ',
                '桃': '桃',
                '桃色': '桃',
                '茶': '茶',
                '茶色': '茶',
                'ブラウン': '茶',
                'Brown': '茶',
                '灰': '灰',
                '灰色': '灰',
                'グレー': '灰',
                'Gray': '灰',
                'Grey': '灰',
                '金': '金',
                '金色': '金',
                'ゴールド': '金',
                'Gold': '金',
                '銀': '銀',
                '銀色': '銀',
                'シルバー': '銀',
                'Silver': '銀',
                // 特殊色（カラーオモリ対応表の色）
                '虹色': '虹',
                '混色': '混',
                '縞色': '縞'
            };
            
            // 完全一致を試す
            if (colorMap[color]) {
                return colorMap[color];
            }
            
            // 部分一致を試す
            for (const [key, value] of Object.entries(colorMap)) {
                if (color.includes(key) || key.includes(color)) {
                    return value;
                }
            }
            
            // マッチしない場合は最初の文字を返す
            return color.charAt(0);
        }

        // ファイル選択イベント
        masterFile.addEventListener('change', (e) => handleFileSelect(e, 'master', 'masterStatus'));
        amazonFile.addEventListener('change', (e) => handleFileSelect(e, 'amazon', 'amazonStatus'));
        rakutenFile.addEventListener('change', (e) => handleFileSelect(e, 'rakuten', 'rakutenStatus'));
        yahooFile.addEventListener('change', (e) => handleFileSelect(e, 'yahoo', 'yahooStatus'));

        function handleFileSelect(event, type, statusId) {
            const file = event.target.files[0];
            const statusElement = document.getElementById(statusId);
            const inputElement = event.target;

            console.log(`File selected for ${type}:`, file ? file.name : 'none');

            if (file) {
                selectedFiles[type] = file;
                statusElement.textContent = `選択済み: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`;
                statusElement.className = 'file-status success';
                inputElement.classList.add('has-file');
                
                // 商品マスタファイルの場合は即座に読み込み
                if (type === 'master') {
                    loadProductMaster(file);
                }
            } else {
                selectedFiles[type] = null;
                statusElement.textContent = type === 'master' ? 
                    '商品マスタファイル(.xlsx/.xlsm)を選択してください' : 
                    'ファイルを選択してください';
                statusElement.className = 'file-status';
                inputElement.classList.remove('has-file');
                
                if (type === 'master') {
                    productMaster = {};
                }
            }

            updateConvertButton();
        }

        async function loadProductMaster(file) {
            try {
                console.log('Loading product master...');
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                console.log('Workbook sheets:', workbook.SheetNames);
                
                let masterSheet = null;
                // 商品マスタシートを探す
                for (const sheetName of workbook.SheetNames) {
                    if (sheetName.includes('商品マスタ') || sheetName.includes('master') || sheetName.includes('Master')) {
                        masterSheet = workbook.Sheets[sheetName];
                        console.log('Found master sheet:', sheetName);
                        break;
                    }
                }
                
                // 見つからない場合は最初のシートを使用
                if (!masterSheet && workbook.SheetNames.length > 0) {
                    masterSheet = workbook.Sheets[workbook.SheetNames[0]];
                    console.log('Using first sheet:', workbook.SheetNames[0]);
                }
                
                if (!masterSheet) {
                    throw new Error('商品マスタシートが見つかりません');
                }
                
                // シートをJSONに変換
                const jsonData = XLSX.utils.sheet_to_json(masterSheet, { 
                    header: 1,
                    defval: '',
                    blankrows: false
                });
                
                console.log('Master data rows:', jsonData.length);
                console.log('Headers:', jsonData[0]);
                
                // 商品マスタオブジェクトを構築（複数カラムセット対応）
                productMaster = {};
                let loadedCount = 0;
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length >= 3 && row[0] && row[2] && row[0] !== 'FBA') { // 販売サイト、商品No最低限必要、FBA除外
                        const site = String(row[0]).trim();
                        const detail = String(row[1] || '').trim();
                        const productNo = String(row[2]).trim();
                        
                        // 複数カラムセットを処理（D-F, G-I, J-L, M-O, P-R）
                        const colorSets = [];
                        const columnGroups = [
                            [3, 4, 5],   // D, E, F
                            [6, 7, 8],   // G, H, I  
                            [9, 10, 11], // J, K, L
                            [12, 13, 14], // M, N, O
                            [15, 16, 17]  // P, Q, R
                        ];
                        
                        columnGroups.forEach(([weightCol, quantityCol, colorCol]) => {
                            const weight = parseFloat(row[weightCol]) || 0;
                            const quantity = parseInt(row[quantityCol]) || 0;
                            const color = String(row[colorCol] || '').trim();
                            
                            if (weight > 0 && quantity > 0 && color) {
                                colorSets.push({
                                    weight: weight,
                                    quantity: quantity,
                                    color: color
                                });
                            }
                        });
                        
                        // 少なくとも1つのカラーセットがある場合のみ登録
                        if (colorSets.length > 0) {
                            productMaster[productNo] = {
                                site: site,
                                detail: detail,
                                colorSets: colorSets
                            };
                            loadedCount++;
                        }
                    }
                }
                
                console.log(`Product master loaded: ${loadedCount} products`);
                
                // ステータスを更新
                const masterStatus = document.getElementById('masterStatus');
                masterStatus.textContent = `✅ 商品マスタ読み込み完了: ${loadedCount}件`;
                masterStatus.className = 'file-status success';
                
            } catch (error) {
                console.error('商品マスタ読み込みエラー:', error);
                const masterStatus = document.getElementById('masterStatus');
                masterStatus.textContent = `❌ 読み込みエラー: ${error.message}`;
                masterStatus.className = 'file-status';
                masterStatus.style.color = '#e53e3e';
                productMaster = {};
            }
        }

        function updateConvertButton() {
            // 商品マスタは必須、他のファイルは少なくとも1つは必要
            const hasMaster = selectedFiles.master && Object.keys(productMaster).length > 0;
            const hasData = selectedFiles.amazon || selectedFiles.rakuten || selectedFiles.yahoo;
            
            convertButton.disabled = !hasMaster || !hasData;
            
            console.log('Button update:', { hasMaster, hasData, disabled: convertButton.disabled });
        }

        // 変換処理
        convertButton.addEventListener('click', async () => {
            try {
                showProgress();
                updateProgress(10, 'ファイルを読み込み中...');

                const results = [];
                
                // Amazonデータ処理
                if (selectedFiles.amazon) {
                    updateProgress(25, 'Amazonデータを解析中...');
                    const amazonData = await readFileWithEncoding(selectedFiles.amazon);
                    const amazonOrders = await processAmazonData(amazonData);
                    results.push(...amazonOrders);
                }

                // 楽天データ処理
                if (selectedFiles.rakuten) {
                    updateProgress(45, '楽天データを解析中...');
                    const rakutenData = await readFileWithEncoding(selectedFiles.rakuten);
                    const rakutenOrders = await processRakutenData(rakutenData);
                    results.push(...rakutenOrders);
                }

                // Yahooデータ処理
                if (selectedFiles.yahoo) {
                    updateProgress(65, 'Yahooデータを解析中...');
                    const yahooData = await readFileWithEncoding(selectedFiles.yahoo);
                    const yahooOrders = await processYahooData(yahooData);
                    results.push(...yahooOrders);
                }

                // データ統合
                updateProgress(80, 'データを統合中...');
                const mergedOrders = mergeOrdersByRecipient(results);
                
                updateProgress(90, 'CSV生成中...');
                const csvContent = generateYamatoCSV(mergedOrders);
                
                updateProgress(100, '変換完了!');
                
                setTimeout(() => {
                    // 重量別の統計を計算
                    const lightOrders = mergedOrders.filter(order => order.weight <= 1000);
                    const heavyOrders = mergedOrders.filter(order => order.weight > 1000);
                    
                    showResult(csvContent, {
                        original: results.length,
                        merged: mergedOrders.length,
                        amazon: results.filter(r => r.source === 'Amazon').length,
                        rakuten: results.filter(r => r.source === '楽天').length,
                        yahoo: results.filter(r => r.source === 'Yahoo').length,
                        lightOrders: lightOrders.length,
                        heavyOrders: heavyOrders.length,
                        unknownProducts: []
                    });
                }, 500);

            } catch (error) {
                console.error('変換エラー:', error);
                showError(error.message);
            }
        });

        async function readFileWithEncoding(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const buffer = new Uint8Array(e.target.result);
                        
                        // UTF-8で試行
                        let result;
                        try {
                            result = new TextDecoder('utf-8', { fatal: true }).decode(buffer);
                        } catch {
                            // Shift-JISで試行
                            try {
                                result = new TextDecoder('shift-jis', { fatal: false }).decode(buffer);
                            } catch {
                                // 最後の手段：非厳密なUTF-8
                                result = new TextDecoder('utf-8', { fatal: false }).decode(buffer);
                            }
                        }
                        
                        resolve(result);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function processAmazonData(amazonData) {
            const orders = [];
            const lines = amazonData.split('\n').filter(line => line.trim());
            
            if (lines.length <= 1) return orders;
            
            const headers = lines[0].split('\t');
            console.log('Amazon headers count:', headers.length);
            
            for (let i = 1; i < lines.length; i++) {
                const fields = lines[i].split('\t');
                if (fields.length < 20) continue; // 最低限のフィールド数チェック
                
                try {
                    const sku = fields[11]?.trim();
                    const productName = fields[13]?.trim();
                    const quantity = parseInt(fields[14]) || 1;
                    const recipientName = fields[19]?.trim();
                    
                    // Amazon住所の完全な結合: ship-state + ship-address-1 + ship-address-2 + ship-address-3
                    const shipState = fields[24]?.trim() || '';
                    const shipAddress1 = fields[20]?.trim() || '';
                    const shipAddress2 = fields[21]?.trim() || '';
                    const shipAddress3 = fields[22]?.trim() || '';
                    const shipAddress = [shipState, shipAddress1, shipAddress2, shipAddress3]
                        .filter(addr => addr && addr.trim())
                        .join('');
                    
                    const zipCode = fields[25]?.trim();
                    const phoneNumber = fields[10]?.trim();
                    const orderId = fields[0]?.trim();
                    const orderItemId = fields[1]?.trim();

                    if (!recipientName || !shipAddress || !zipCode || !phoneNumber) continue;

                    // 商品マスタから重量情報取得（複数カラーセット対応）
                    const masterInfo = productMaster[sku];
                    let weight = 50 * quantity; // デフォルト重量×注文数
                    let productDetail = productName;

                    if (masterInfo && masterInfo.colorSets) {
                        // 総重量計算: 各カラーセットの(重さ×個数)を合計してから注文数を掛ける
                        let unitTotalWeight = 0;
                        const detailParts = [];
                        
                        masterInfo.colorSets.forEach(set => {
                            unitTotalWeight += set.weight * set.quantity;
                            let colorAbbr = getColorAbbreviation(set.color);
                            let actualWeight = set.weight;
                            
                            // 色に「特殊」が含まれている場合の処理（Amazonの場合は商品名から判断）
                            if (set.color.includes('特殊')) {
                                // Amazonの場合は特殊処理なし（必要に応じて追加）
                            }
                            
                            detailParts.push(`${colorAbbr}: ${actualWeight}g×${set.quantity}`);
                        });
                        
                        weight = unitTotalWeight * quantity;
                        productDetail = detailParts.join(', ');
                    } else {
                        // 商品名から重量を推定
                        const weightMatch = productName?.match(/(\d+)g/);
                        if (weightMatch) {
                            weight = parseInt(weightMatch[1]) * quantity;
                        }
                        
                        // カラーオモリ対応表から特殊色を検索
                        const colorInfo = colorWeightMap[sku];
                        if (colorInfo) {
                            weight = colorInfo.weight * quantity;
                            const colorAbbr = getColorAbbreviation(colorInfo.color);
                            productDetail = `${colorAbbr}: ${colorInfo.weight}g×${quantity}`;
                        }
                    }

                    orders.push({
                        source: 'Amazon',
                        sku: sku,
                        productName: productDetail,
                        quantity: quantity,
                        recipientName: recipientName,
                        shipAddress: shipAddress,
                        zipCode: formatZipCode(zipCode),
                        phoneNumber: formatPhoneNumber(phoneNumber),
                        weight: weight,
                        orderId: `${orderId}:${orderItemId}:${quantity}`
                    });
                } catch (error) {
                    console.error(`Amazon row ${i} error:`, error);
                }
            }
            
            console.log('Amazon orders processed:', orders.length);
            return orders;
        }

        async function processRakutenData(rakutenData) {
            const orders = [];
            
            const parsed = Papa.parse(rakutenData, { 
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
            });
            
            if (!parsed.data || parsed.data.length === 0) return orders;
            
            console.log('Rakuten headers:', Object.keys(parsed.data[0]));
            
            parsed.data.forEach((row, index) => {
                try {
                    const orderId = row['注文番号']?.trim();
                    const itemId = row['商品管理番号']?.trim();
                    const itemName = row['商品名']?.trim();
                    const quantity = parseInt(row['個数']) || 1;
                    const skuCode = row['SKU管理番号']?.trim() || ''; // FB列のSKU情報を取得
                    
                    const shipLastName = row['送付先姓']?.trim() || '';
                    const shipFirstName = row['送付先名']?.trim() || '';
                    const shipName = `${shipLastName} ${shipFirstName}`.trim();
                    
                    const shipPhone1 = row['送付先電話番号1']?.trim() || '';
                    const shipPhone2 = row['送付先電話番号2']?.trim() || '';
                    const shipPhone3 = row['送付先電話番号3']?.trim() || '';
                    const phoneNumber = formatPhoneNumber(`${shipPhone1}-${shipPhone2}-${shipPhone3}`);
                    
                    const shipZip1 = row['送付先郵便番号1']?.toString().trim() || '';
                    const shipZip2 = row['送付先郵便番号2']?.toString().trim() || '';
                    
                    // 楽天郵便番号: AJ列を3桁、AK列を4桁に0埋め
                    const paddedZip1 = shipZip1.padStart(3, '0');
                    const paddedZip2 = shipZip2.padStart(4, '0');
                    const zipCode = formatZipCode(`${paddedZip1}${paddedZip2}`);
                    
                    const shipPref = row['送付先住所都道府県']?.trim() || '';
                    const shipCity = row['送付先住所郡市区']?.trim() || '';
                    const shipAddr = row['送付先住所それ以降の住所']?.trim() || '';
                    const shipApart = row['送付先住所アパートマンション名']?.trim() || '';
                    
                    // 楽天住所の完全な結合
                    const fullAddress = [shipPref, shipCity, shipAddr, shipApart]
                        .filter(addr => addr && addr.trim())
                        .join('');

                    if (!shipName || !fullAddress || !zipCode || !phoneNumber || !orderId) return;

                    // 商品マスタから重量取得（複数カラーセット対応）
                    const masterInfo = productMaster[itemId];
                    let weight = 50 * quantity; // デフォルト重量×注文数
                    let productDetail = itemName;

                    if (masterInfo && masterInfo.colorSets) {
                        // 総重量計算: 各カラーセットの(重さ×個数)を合計してから注文数を掛ける
                        let unitTotalWeight = 0;
                        const detailParts = [];
                        
                        masterInfo.colorSets.forEach(set => {
                            unitTotalWeight += set.weight * set.quantity;
                            let colorAbbr = getColorAbbreviation(set.color);
                            let actualWeight = set.weight;
                            
                            console.log(`楽天 - 商品ID: ${itemId}, 色: ${set.color}, 特殊チェック: ${set.color.includes('特殊')}`);
                            
                            // 色に「特殊」が含まれている場合は、SKU情報からカラーオモリ対応表を検索
                            if (set.color.includes('特殊')) {
                                console.log(`楽天 - 特殊色検出: ${set.color}, SKU: ${skuCode}`);
                                const specialColorInfo = findSpecialColorInfo(itemId, skuCode, '楽天');
                                if (specialColorInfo) {
                                    console.log(`楽天 - 特殊色情報見つかった: ${specialColorInfo.color}, ${specialColorInfo.weight}g`);
                                    colorAbbr = getColorAbbreviation(specialColorInfo.color);
                                    actualWeight = specialColorInfo.weight;
                                    // 重量を特殊色の重量に置き換え
                                    unitTotalWeight = unitTotalWeight - set.weight * set.quantity + actualWeight * set.quantity;
                                } else {
                                    console.log(`楽天 - 特殊色情報が見つからない: ${itemId}, ${skuCode}`);
                                }
                            }
                            
                            detailParts.push(`${colorAbbr}: ${actualWeight}g×${set.quantity}`);
                        });
                        
                        weight = unitTotalWeight * quantity;
                        productDetail = detailParts.join(', ');
                    } else {
                        const weightMatch = itemName?.match(/(\d+)g/);
                        if (weightMatch) {
                            weight = parseInt(weightMatch[1]) * quantity;
                        }
                        
                        // カラーオモリ対応表から特殊色を検索
                        const colorInfo = colorWeightMap[itemId];
                        if (colorInfo) {
                            weight = colorInfo.weight * quantity;
                            const colorAbbr = getColorAbbreviation(colorInfo.color);
                            productDetail = `${colorAbbr}: ${colorInfo.weight}g×${quantity}`;
                        }
                    }

                    orders.push({
                        source: '楽天',
                        sku: itemId,
                        productName: productDetail,
                        quantity: quantity,
                        recipientName: shipName,
                        shipAddress: fullAddress,
                        zipCode: zipCode,
                        phoneNumber: phoneNumber,
                        weight: weight,
                        orderId: orderId
                    });
                } catch (error) {
                    console.error(`Rakuten row ${index} error:`, error);
                }
            });
            
            console.log('Rakuten orders processed:', orders.length);
            return orders;
        }

        async function processYahooData(yahooData) {
            const orders = [];
            
            const parsed = Papa.parse(yahooData, { 
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false
            });
            
            if (!parsed.data || parsed.data.length === 0) return orders;
            
            console.log('Yahoo headers:', Object.keys(parsed.data[0]));
            
            parsed.data.forEach((row, index) => {
                try {
                    const orderId = row['OrderId']?.trim();
                    let itemId = row['ItemId']?.trim();
                    const title = row['Title']?.trim();
                    const quantityDetail = row['QuantityDetail']?.trim();
                    const shipName = row['ShipName']?.trim();
                    const shipAddress1 = row['ShipAddress1']?.trim() || '';
                    const shipAddress2 = row['ShipAddress2']?.trim() || '';
                    const shipCity = row['ShipCity']?.trim() || '';
                    const shipPrefecture = row['ShipPrefecture']?.trim() || '';
                    const shipAddressFull = row['ShipAddressFull']?.trim() || '';
                    
                    // Yahoo住所: ShipAddressFullを優先、なければ個別フィールドを結合
                    const shipAddress = shipAddressFull || 
                        [shipPrefecture, shipCity, shipAddress1, shipAddress2]
                            .filter(addr => addr && addr.trim())
                            .join('');
                    
                    const shipZip = row['ShipZipCode']?.toString().trim();
                    const shipPhone = formatPhoneNumber(row['ShipPhoneNumber']?.toString().trim());

                    if (!shipName || !shipAddress || !shipZip || !shipPhone || !orderId) return;

                    // Yahoo商品IDの処理
                    let totalWeight = 0;
                    let productDetails = [];
                    let totalQuantity = 0;

                    if (itemId?.includes('&')) {
                        // 複数商品の場合（例: L1=bara60&L2=bara80）
                        const items = itemId.split('&');
                        items.forEach(item => {
                            // L1=bara60 -> bara60 を抽出
                            let cleanItemCode = '';
                            if (item.includes('=')) {
                                cleanItemCode = item.split('=')[1]; // = より後ろを取得
                            } else {
                                cleanItemCode = item.trim();
                            }
                            
                            console.log(`Yahoo multiple item: ${item} -> ${cleanItemCode}`);
                            
                            // QuantityDetailから該当商品の数量を取得（例: bara60:2,bara80:1）
                            let quantity = 1;
                            if (quantityDetail) {
                                const quantityMatch = quantityDetail.match(new RegExp(`${cleanItemCode}:(\\d+)`));
                                quantity = quantityMatch ? parseInt(quantityMatch[1]) : 1;
                            }
                            
                            const masterInfo = productMaster[cleanItemCode];
                            console.log(`Searching for ${cleanItemCode}:`, masterInfo);
                            
                            if (masterInfo && masterInfo.colorSets) {
                                // 複数カラーセット対応
                                let itemUnitWeight = 0;
                                const itemDetailParts = [];
                                
                                masterInfo.colorSets.forEach(set => {
                                    itemUnitWeight += set.weight * set.quantity;
                                    let colorAbbr = getColorAbbreviation(set.color);
                                    let actualWeight = set.weight;
                                    
                                    console.log(`Yahoo複数 - 商品ID: ${cleanItemCode}, 色: ${set.color}, 特殊チェック: ${set.color.includes('特殊')}`);
                                    
                                    // 色に「特殊」が含まれている場合は、SubCode情報からカラーオモリ対応表を検索
                                    if (set.color.includes('特殊')) {
                                        console.log(`Yahoo複数 - 特殊色検出: ${set.color}, SubCode: ${item}`);
                                        const specialColorInfo = findSpecialColorInfo(cleanItemCode, item, 'Yahoo');
                                        if (specialColorInfo) {
                                            console.log(`Yahoo複数 - 特殊色情報見つかった: ${specialColorInfo.color}, ${specialColorInfo.weight}g`);
                                            colorAbbr = getColorAbbreviation(specialColorInfo.color);
                                            actualWeight = specialColorInfo.weight;
                                            // 重量を特殊色の重量に置き換え
                                            itemUnitWeight = itemUnitWeight - set.weight * set.quantity + actualWeight * set.quantity;
                                        } else {
                                            console.log(`Yahoo複数 - 特殊色情報が見つからない: ${cleanItemCode}, ${item}`);
                                        }
                                    }
                                    
                                    itemDetailParts.push(`${colorAbbr}: ${actualWeight}g×${set.quantity}`);
                                });
                                
                                const itemTotalWeight = itemUnitWeight * quantity;
                                totalWeight += itemTotalWeight;
                                productDetails.push(itemDetailParts.join(', '));
                                totalQuantity += quantity;
                            } else {
                                console.log(`Product not found in master: ${cleanItemCode}`);
                                // カラーオモリ対応表から特殊色を検索
                                const colorInfo = colorWeightMap[cleanItemCode];
                                if (colorInfo) {
                                    const itemTotalWeight = colorInfo.weight * quantity;
                                    totalWeight += itemTotalWeight;
                                    const colorAbbr = getColorAbbreviation(colorInfo.color);
                                    productDetails.push(`${colorAbbr}: ${colorInfo.weight}g×${quantity}`);
                                } else {
                                    totalWeight += 50 * quantity;
                                    productDetails.push(`不明商品: ${cleanItemCode}`);
                                }
                                totalQuantity += quantity;
                            }
                        });
                    } else {
                        // 単一商品の場合（例: L1=bara60）
                        const quantity = parseInt(quantityDetail) || 1;
                        
                        // 単一商品でも = より後ろを取得
                        let cleanItemCode = itemId;
                        if (itemId && itemId.includes('=')) {
                            cleanItemCode = itemId.split('=')[1]; // = より後ろを取得
                        }
                        
                        console.log(`Yahoo single item: ${itemId} -> ${cleanItemCode}`);
                        const masterInfo = productMaster[cleanItemCode];
                        console.log(`Searching for ${cleanItemCode}:`, masterInfo);
                        
                        if (masterInfo && masterInfo.colorSets) {
                            // 複数カラーセット対応
                            let unitTotalWeight = 0;
                            const detailParts = [];
                            
                            masterInfo.colorSets.forEach(set => {
                                unitTotalWeight += set.weight * set.quantity;
                                let colorAbbr = getColorAbbreviation(set.color);
                                let actualWeight = set.weight;
                                
                                console.log(`Yahoo単一 - 商品ID: ${cleanItemCode}, 色: ${set.color}, 特殊チェック: ${set.color.includes('特殊')}`);
                                
                                // 色に「特殊」が含まれている場合は、SubCode情報からカラーオモリ対応表を検索
                                if (set.color.includes('特殊')) {
                                    console.log(`Yahoo単一 - 特殊色検出: ${set.color}, SubCode: ${itemId}`);
                                    const specialColorInfo = findSpecialColorInfo(cleanItemCode, itemId, 'Yahoo');
                                    if (specialColorInfo) {
                                        console.log(`Yahoo単一 - 特殊色情報見つかった: ${specialColorInfo.color}, ${specialColorInfo.weight}g`);
                                        colorAbbr = getColorAbbreviation(specialColorInfo.color);
                                        actualWeight = specialColorInfo.weight;
                                        // 重量を特殊色の重量に置き換え
                                        unitTotalWeight = unitTotalWeight - set.weight * set.quantity + actualWeight * set.quantity;
                                    } else {
                                        console.log(`Yahoo単一 - 特殊色情報が見つからない: ${cleanItemCode}, ${itemId}`);
                                    }
                                }
                                
                                detailParts.push(`${colorAbbr}: ${actualWeight}g×${set.quantity}`);
                            });
                            
                            totalWeight = unitTotalWeight * quantity;
                            productDetails.push(detailParts.join(', '));
                        } else {
                            console.log(`Product not found in master: ${cleanItemCode}`);
                            // カラーオモリ対応表から特殊色を検索
                            const colorInfo = colorWeightMap[cleanItemCode];
                            if (colorInfo) {
                                totalWeight = colorInfo.weight * quantity;
                                const colorAbbr = getColorAbbreviation(colorInfo.color);
                                productDetails.push(`${colorAbbr}: ${colorInfo.weight}g×${quantity}`);
                            } else {
                                // 商品マスタにない場合、タイトルから重量推定
                                const weightMatch = title?.match(/(\d+)g/);
                                totalWeight = weightMatch ? parseInt(weightMatch[1]) * quantity : 50 * quantity;
                                productDetails.push(`不明商品: ${cleanItemCode}`);
                            }
                        }
                        totalQuantity = quantity;
                    }

                    orders.push({
                        source: 'Yahoo',
                        sku: itemId,
                        productName: productDetails.join(', '),
                        quantity: totalQuantity,
                        recipientName: shipName,
                        shipAddress: shipAddress,
                        zipCode: formatZipCode(shipZip),
                        phoneNumber: shipPhone,
                        weight: totalWeight,
                        orderId: orderId
                    });
                } catch (error) {
                    console.error(`Yahoo row ${index} error:`, error);
                }
            });
            
            console.log('Yahoo orders processed:', orders.length);
            return orders;
        }

        function mergeOrdersByRecipient(orders) {
            const merged = {};
            
            orders.forEach(order => {
                const key = `${order.recipientName}_${order.shipAddress}_${order.phoneNumber}`;
                
                if (merged[key]) {
                    merged[key].weight += order.weight;
                    merged[key].quantity += order.quantity;
                    merged[key].orderId += `,${order.orderId}`;
                    
                    if (!merged[key].productName.includes(order.productName)) {
                        merged[key].productName += `, ${order.productName}`;
                    }
                } else {
                    merged[key] = { ...order };
                }
            });
            
            return Object.values(merged);
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            
            const cleaned = phone.replace(/[^\d]/g, '');
            const withZero = cleaned.startsWith('0') ? cleaned : '0' + cleaned;
            
            if (withZero.length === 10) {
                return `${withZero.substr(0, 3)}-${withZero.substr(3, 3)}-${withZero.substr(6, 4)}`;
            } else if (withZero.length === 11) {
                return `${withZero.substr(0, 3)}-${withZero.substr(3, 4)}-${withZero.substr(7, 4)}`;
            }
            
            return withZero;
        }

        function formatZipCode(zipCode) {
            if (!zipCode) return '';
            
            const cleaned = zipCode.replace(/[^\d]/g, '');
            
            // 楽天の郵便番号修正処理
            if (cleaned.length === 5) {
                if (cleaned.startsWith('133') && cleaned.endsWith('55')) {
                    return '133-0055';
                }
                if (cleaned.startsWith('590') && cleaned.endsWith('06')) {
                    return '590-0006';
                }
            }
            
            if (cleaned.length === 7) {
                return `${cleaned.substr(0, 3)}-${cleaned.substr(3, 4)}`;
            }
            
            return cleaned;
        }

        function generateYamatoCSV(orders) {
            const headers = [
                '送り状種類','出荷予定日','お届け予定日','配達時間帯','お届け先電話番号',
                'お届け先郵便番号','お届け先住所','お届け先アパートマンション名','お届け先名',
                'ご依頼主電話番号','ご依頼主郵便番号','ご依頼主住所','ご依頼主名','品名１',
                '総重量(g)','品名詳細','不明品名','販売ID','',''
            ];

            const rows = [headers.join(',')];
            
            const today = new Date();
            const shipDate = `${today.getFullYear()}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getDate().toString().padStart(2, '0')}`;

            // 重量で分類（1kg以下と1kg超過）
            const lightOrders = orders.filter(order => order.weight <= 1000);
            const heavyOrders = orders.filter(order => order.weight > 1000);
            
            // すべての注文を処理する関数
            const processOrders = (orderList, shipType) => {
                orderList.forEach(order => {
                    const escapeCSV = (str) => {
                        if (!str) return '';
                        const strValue = String(str);
                        if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) {
                            return '"' + strValue.replace(/"/g, '""') + '"';
                        }
                        return strValue;
                    };
                    
                    const fullProductName = order.productName || '';
                    const truncatedProductName = fullProductName.substring(0, 25); // 全角25文字制限
                    const hasOverflow = fullProductName.length > 25;
                    
                    const row = [
                        shipType, // 送り状種類：A（1kg以下）またはZ（1kg超過）
                        shipDate,
                        '', // お届け予定日
                        '', // 配達時間帯
                        escapeCSV(order.phoneNumber),
                        escapeCSV(order.zipCode),
                        escapeCSV(order.shipAddress),
                        '', // アパートマンション名
                        escapeCSV(order.recipientName),
                        '050-3590-1444', // JGSフィッシュ電話番号
                        '104-0061', // JGSフィッシュ郵便番号
                        '東京都中央区銀座1-22-11 2F', // JGSフィッシュ住所
                        'JGSフィッシュ', // JGSフィッシュ名
                        escapeCSV(truncatedProductName), // 品名１（全角25文字制限）
                        Math.round(order.weight || 50),
                        hasOverflow ? escapeCSV(fullProductName) : '', // 品名詳細（オーバーフロー時は完全版）
                        '', // 不明品名
                        escapeCSV(order.orderId),
                        '', ''
                    ];
                    rows.push(row.join(','));
                });
            };

            // 1kg以下の注文を先に処理（送り状種類：A）
            processOrders(lightOrders, 'A');
            
            // 1kg超過の注文を最下部に処理（送り状種類：Z）
            processOrders(heavyOrders, 'Z');

            return rows.join('\r\n');
        }

        function showProgress() {
            document.querySelector('.upload-section').style.display = 'none';
            convertButton.style.display = 'none';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
        }

        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function showResult(csvContent, stats) {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            // 重量別の統計を計算
            const lightCount = stats.lightOrders || 0;
            const heavyCount = stats.heavyOrders || 0;
            
            messageArea.innerHTML = `
                <div class="success-message">
                    <strong>🎉 変換完了！</strong><br>
                    ${stats.original}件のデータを${stats.merged}件にまとめてヤマト運輸形式に変換しました。
                </div>
                
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="stat-number">${stats.amazon}</div>
                        <div class="stat-label">Amazon</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.rakuten}</div>
                        <div class="stat-label">楽天</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.yahoo}</div>
                        <div class="stat-label">Yahoo</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${stats.merged}</div>
                        <div class="stat-label">最終件数</div>
                    </div>
                </div>
                
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="stat-number">${lightCount}</div>
                        <div class="stat-label">1kg以下 (A)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${heavyCount}</div>
                        <div class="stat-label">1kg超過 (Z)</div>
                    </div>
                </div>
            `;
            
            downloadButton.style.display = 'block';
            window.csvData = csvContent;
            
            downloadButton.onclick = () => downloadCSV(csvContent, stats.merged);
        }

        function downloadCSV(csvContent, recordCount) {
            try {
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `YBMdata_${getCurrentDateString()}.csv`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                downloadButton.textContent = '✅ ダウンロード完了！';
                downloadButton.style.background = '#218838';
                
            } catch (error) {
                console.error('ダウンロードエラー:', error);
                alert('ダウンロードに失敗しました。ブラウザの設定を確認してください。');
            }
        }

        function getCurrentDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function showError(message) {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            messageArea.innerHTML = `
                <div class="error-message">
                    <strong>❌ エラーが発生しました</strong><br>
                    ${message}<br><br>
                    <small>確認項目：<br>
                    • 商品マスタファイルが正しく選択されているか<br>
                    • ファイル形式が正しいか（Amazon: TSV、楽天・Yahoo: CSV）<br>
                    • ファイルが破損していないか</small>
                </div>
            `;
            
            downloadButton.style.display = 'none';
        }

        // リセット処理
        resetButton.addEventListener('click', () => {
            // ファイル選択をリセット
            masterFile.value = '';
            amazonFile.value = '';
            rakutenFile.value = '';
            yahooFile.value = '';
            
            selectedFiles = { master: null, amazon: null, rakuten: null, yahoo: null };
            productMaster = {};
            
            // ステータスをリセット
            const statusElements = [
                { id: 'masterStatus', text: '商品マスタファイル(.xlsx/.xlsm)を選択してください' },
                { id: 'amazonStatus', text: 'ファイルを選択してください' },
                { id: 'rakutenStatus', text: 'ファイルを選択してください' },
                { id: 'yahooStatus', text: 'ファイルを選択してください' }
            ];
            
            statusElements.forEach(({ id, text }) => {
                const element = document.getElementById(id);
                element.textContent = text;
                element.className = 'file-status';
                element.style.color = '';
            });
            
            // インプット要素のクラスをリセット
            [masterFile, amazonFile, rakutenFile, yahooFile].forEach(input => {
                input.classList.remove('has-file');
            });
            
            // セクション表示をリセット
            document.querySelector('.upload-section').style.display = 'block';
            convertButton.style.display = 'block';
            convertButton.textContent = 'データを変換してダウンロード';
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            
            downloadButton.textContent = 'ヤマト運輸用CSVをダウンロード';
            downloadButton.style.background = '#28a745';
            
            updateConvertButton();
        });

        // 初期化
        loadColorWeightMap().then(() => {
            updateConvertButton();
        });
    </script>
</body>
</html>
